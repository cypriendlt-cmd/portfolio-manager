<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Manager Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="stylesheet" href="/portfolio-manager/CSS/styles.css">
</head>
<body>
    <!-- Menu Hamburger (mobile only) -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle" onclick="toggleMobileMenu()">
        <span></span>
        <span></span>
        <span></span>
    </button>
    
    <!-- Overlay pour fermer le menu (mobile only) -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileMenu()"></div>
    
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="logo">Portfolio Manager</div>
        
        <div class="nav-menu">
            <button class="nav-item active" data-section="dashboard" onclick="showSection('dashboard')">
                <span class="icon">üìä</span>
                <span>Dashboard</span>
            </button>
            <button class="nav-item" onclick="showSection('portfolio')">
                <span class="icon">üíº</span>
                <span>Portfolio</span>
            </button>
            
            <div style="margin: 32px 0 12px 20px; font-size: 0.75em; color: var(--text-secondary); font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Asset categories</div>
            
            <button class="nav-item" data-section="crypto" onclick="showSection('crypto')">
                <span class="icon">‚Çø</span>
                <span>Crypto</span>
            </button>
            <button class="nav-item" data-section="pea" onclick="showSection('pea')">
                <span class="icon">üìà</span>
                <span>Actions</span>
            </button>
            <button class="nav-item" data-section="livrets" onclick="showSection('livrets')">
                <span class="icon">üí∞</span>
                <span>Livrets</span>
            </button>
            <button class="nav-item" data-section="fundraising" onclick="showSection('fundraising')">
                <span class="icon">üöÄ</span>
                <span>Lev√©es</span>
            </button>
            
            <div style="margin: 32px 0 12px 20px; font-size: 0.75em; color: var(--text-secondary); font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Planning</div>
            
            <button class="nav-item" data-section="goals" onclick="showSection('goals')">
                <span class="icon">üéØ</span>
                <span>Objectifs</span>
            </button>
            
            <div style="margin-top: auto;">
                    <button class="nav-item" data-section="settings" onclick="showSection('settings')">
                        <span class="icon">üë§</span>
                        <span>Profile</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Portfolio Manager Pro</h1>
            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                <button class="quick-add-btn" onclick="openQuickAddModal()" title="Ajout rapide (Ctrl+N)">
                    ‚ûï Ajouter
                </button>
                <button class="theme-toggle-btn" id="themeToggle" onclick="toggleTheme()" title="Changer de th√®me (Ctrl+T)">
                    <span id="themeIcon">üåô</span>
                </button>
                <button class="privacy-btn" id="privacyToggle" onclick="togglePrivacy()">
                    <span id="privacyIcon">üëÅÔ∏è</span>
                    <span id="privacyText">Masquer</span>
                </button>
                <button class="drive-connection-btn" id="driveConnectionBtn" onclick="toggleDriveConnection()">
                    <span id="driveIcon">üîå</span>
                    <span id="driveText">Connecter Drive</span>
                </button>
                <div class="sync-status" id="syncStatus">‚è≥ Non synchronis√©</div>
                <button class="update-btn" onclick="updateAll()">üîÑ Actualiser les prix</button>
            </div>
        </header>

        <nav>
            <button class="nav-btn" onclick="showSection('dashboard')">üìà Dashboard</button>
            <button class="nav-btn" onclick="showSection('crypto')">‚Çø Crypto</button>
            <button class="nav-btn" onclick="showSection('pea')">üìä PEA</button>
            <button class="nav-btn" onclick="showSection('livrets')">üí∞ Livrets</button>
            <button class="nav-btn" onclick="showSection('fundraising')">üöÄ Lev√©es</button>
            <button class="nav-btn" onclick="showSection('settings')">‚öôÔ∏è Param√®tres</button>
        </nav>

        <!-- Dashboard -->
        <div id="dashboard" class="section active">
            <h2 style="margin-bottom: 20px;">üìà Vue d'ensemble</h2>
            <div class="stats-grid" id="dashboardStats"></div>
            
            <!-- Quick Stats Card -->
            <div style="margin: 30px 0;">
                <div class="fear-greed-card" style="background: linear-gradient(135deg, rgba(255, 99, 71, 0.05), rgba(255, 127, 102, 0.05));">
                    <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5em;">‚ö°</span>
                        Statistiques rapides
                    </h3>
                    <div id="quickStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;"></div>
                </div>
            </div>
            
            <!-- Fear & Greed Indicators -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 30px 0;">
                <div class="fear-greed-card">
                    <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5em;">üò±</span>
                        Crypto Fear & Greed Index
                    </h3>
                    <div id="cryptoFearGreed" style="text-align: center;">
                        <div class="loading">Chargement...</div>
                    </div>
                    <p style="font-size: 0.8em; color: #a0aec0; margin-top: 10px;">
                        Source : Alternative.me
                    </p>
                </div>
                
                <div class="fear-greed-card">
                    <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5em;">üìä</span>
                        CNN Fear & Greed Index (Bourse)
                    </h3>
                    <div id="stockFearGreed" style="text-align: center;">
                        <div class="fear-greed-gauge">
                            <div class="gauge-value" id="stockFGValue">--</div>
                            <div class="gauge-label" id="stockFGLabel">Chargement...</div>
                        </div>
                    </div>
                    <p style="font-size: 0.8em; color: #a0aec0; margin-top: 10px;">
                        Estimation bas√©e sur les indices VIX et march√©s
                    </p>
                </div>
            </div>
            
            <!-- Market News with AI Summary -->
            <div class="news-section">
                <h3 style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <span>üì∞ Actualit√©s des march√©s</span>
                    <button onclick="refreshNews()" class="btn-secondary" style="font-size: 0.9em; padding: 8px 16px;">
                        üîÑ Actualiser
                    </button>
                </h3>
                
                <div id="aiSummary" class="ai-summary-box">
                    <div class="loading">‚è≥ Chargement et synth√®se IA des actualit√©s...</div>
                </div>
                
                <div id="newsFeed" class="news-feed">
                    <div class="loading">Chargement des actualit√©s...</div>
                </div>
            </div>
            
            <!-- NEW: Evolution Chart (Line Graph) -->
            <div style="margin: 32px 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 16px;">
                    <h2 style="font-size: 1.8em; font-weight: 800; letter-spacing: -1px;">üìà √âvolution du patrimoine</h2>
                    <div class="time-range-dropdown">
                        <select id="timeRangeSelect" class="time-range-select" onchange="setTimeRangeFromSelect(this.value)">
                            <option value="1M" selected>1 mois</option>
                            <option value="3M">3 mois</option>
                            <option value="6M">6 mois</option>
                            <option value="1Y">1 an</option>
                            <option value="YTD">Ann√©e en cours</option>
                            <option value="ALL">Maximum</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="evolutionChart"></canvas>
                </div>
            </div>
            
            <!-- NEW: Performance View -->
            <div style="margin: 32px 0;">
                <h2 style="font-size: 1.8em; font-weight: 800; letter-spacing: -1px; margin-bottom: 24px;">üìä Performance</h2>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 32px;">
                    <!-- Best Performers -->
                    <div class="fear-greed-card">
                        <h3 style="margin-bottom: 20px;">üèÜ Meilleurs performers</h3>
                        <div id="topPerformers"></div>
                    </div>
                    
                    <!-- Worst Performers -->
                    <div class="fear-greed-card">
                        <h3 style="margin-bottom: 20px;">üìâ Pires performers</h3>
                        <div id="worstPerformers"></div>
                    </div>
                </div>
                
                <!-- Performance Table -->
                <div class="fear-greed-card">
                    <h3 style="margin-bottom: 20px;">üìã Performance d√©taill√©e</h3>
                    <div style="overflow-x: auto;">
                        <table id="performanceTable">
                            <thead>
                                <tr>
                                    <th>Actif</th>
                                    <th>Valeur actuelle</th>
                                    <th>Prix d'achat</th>
                                    <th>Plus-value</th>
                                    <th>Performance</th>
                                </tr>
                            </thead>
                            <tbody id="performanceTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- NEW: Diversification Analysis -->
            <div style="margin: 32px 0;">
                <h2 style="font-size: 1.8em; font-weight: 800; letter-spacing: -1px; margin-bottom: 24px;">ü•ß Analyse de diversification</h2>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
                    <!-- By Asset Class -->
                    <div class="fear-greed-card">
                        <h3 style="margin-bottom: 20px;">Par classe d'actifs</h3>
                        <canvas id="assetClassChart" style="max-height: 300px;"></canvas>
                    </div>
                    
                    <!-- Diversification Score -->
                    <div class="fear-greed-card">
                        <h3 style="margin-bottom: 20px;">Score de diversification</h3>
                        <div id="diversificationScore" style="text-align: center; padding: 40px;">
                            <div class="gauge-value" id="divScore">--</div>
                            <div class="gauge-label">DIVERSIFICATION</div>
                            <p style="color: var(--text-secondary); margin-top: 20px; font-size: 0.9em;">
                                Score calcul√© selon la r√©partition de vos actifs
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- NEW: Transaction History -->
            <div style="margin: 32px 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="font-size: 1.8em; font-weight: 800; letter-spacing: -1px;">üìú Historique des transactions</h2>
                    <button class="btn-secondary" onclick="exportTransactions()">üì• Exporter CSV</button>
                </div>
                
                <div class="fear-greed-card">
                    <div style="margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap;">
                        <select id="transactionTypeFilter" onchange="filterTransactions()" style="max-width: 200px;">
                            <option value="all">Tous les types</option>
                            <option value="buy">Achats</option>
                            <option value="sell">Ventes</option>
                            <option value="dividend">Dividendes</option>
                        </select>
                        <select id="transactionCategoryFilter" onchange="filterTransactions()" style="max-width: 200px;">
                            <option value="all">Toutes cat√©gories</option>
                            <option value="crypto">Crypto</option>
                            <option value="pea">PEA</option>
                            <option value="livrets">Livrets</option>
                            <option value="fundraising">Lev√©es</option>
                        </select>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Cat√©gorie</th>
                                    <th>Actif</th>
                                    <th>Quantit√©</th>
                                    <th>Prix</th>
                                    <th>Montant</th>
                                </tr>
                            </thead>
                            <tbody id="transactionHistory"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="portfolioChart"></canvas>
            </div>
        </div>

        <!-- Portfolio Section (NEW) -->
        <div id="portfolio" class="section">
            <h2 style="margin-bottom: 20px;">üíº Portfolio</h2>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
                <!-- Quick overview cards showing all assets -->
                <div class="fear-greed-card">
                    <h3 style="margin-bottom: 20px;">üìä Vue globale</h3>
                    <div id="portfolioOverview"></div>
                </div>
                
                <div class="fear-greed-card">
                    <h3 style="margin-bottom: 20px;">üìà R√©partition</h3>
                    <canvas id="portfolioAllocationChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>

        <!-- Crypto Section -->
        <div id="crypto" class="section">
            <h2 style="margin-bottom: 20px;">‚Çø Portefeuille Crypto</h2>
            
            <!-- Binance API Integration -->
            <div class="binance-section">
                <h3>
                    <svg class="binance-logo" viewBox="0 0 126.61 126.61" fill="#f3ba2f">
                        <path d="M38.73 53.2l24.59-24.58 24.6 24.6 14.3-14.31L63.32 0 24.43 38.89l14.3 14.31zM0 63.31l14.3-14.3 14.31 14.3-14.31 14.3L0 63.31zm38.73 10.11l24.59 24.58 24.6-24.6 14.31 14.29-38.9 38.91-38.9-38.88 14.3-14.3zM88.58 63.31l14.3-14.3 14.31 14.3-14.31 14.3-14.3-14.3z"/>
                        <path d="M77.83 63.3l-14.51-14.52-10.73 10.73-1.24 1.23-2.54 2.54-.01.02 14.51 14.5 14.51-14.5z"/>
                    </svg>
                    Importer depuis Binance
                    <span class="api-status" id="binanceStatus">Non connect√©</span>
                </h3>
                
                <div class="warning-message" style="margin-bottom: 15px;">
                    <strong>‚ö†Ô∏è PROBL√àME CORS :</strong> Les navigateurs bloquent les requ√™tes directes vers l'API Binance.<br>
                    <strong>üí° Solution alternative recommand√©e :</strong> Import manuel via CSV (voir ci-dessous)
                </div>
                
                <div class="info-message">
                    <strong>üì• Import CSV depuis Binance (RECOMMAND√â) :</strong><br>
                    1. Allez sur <strong>Binance.com ‚Üí Wallet ‚Üí Spot</strong><br>
                    2. Cliquez sur <strong>"Export Complete Account Statement"</strong><br>
                    3. T√©l√©chargez le CSV de vos positions actuelles<br>
                    4. Importez-le ci-dessous avec le bouton "üì• Importer CSV Binance"<br>
                    <br>
                    <strong>Ou utilisez l'API (peut √™tre bloqu√© par CORS) :</strong>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>API Key Binance (optionnel)</label>
                        <input type="password" id="binanceApiKey" placeholder="Votre API Key">
                    </div>
                    <div class="form-group">
                        <label>API Secret Binance (optionnel)</label>
                        <input type="password" id="binanceApiSecret" placeholder="Votre API Secret">
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                    <button class="btn-primary">
                        <label for="binanceCSVImport" style="cursor: pointer; margin: 0;">üì• Importer CSV Binance</label>
                        <input type="file" id="binanceCSVImport" accept=".csv" onchange="importBinanceCSV(event)" style="display: none;">
                    </button>
                    <button onclick="saveBinanceCredentials()" class="btn-secondary">üíæ Sauvegarder les cl√©s API</button>
                    <button onclick="importFromBinance()" class="btn-secondary">üì• Tenter import API</button>
                    <button onclick="clearBinanceCredentials()" class="btn-danger">üóëÔ∏è Supprimer les cl√©s</button>
                </div>
                
                <div class="info-message" style="background: rgba(255, 193, 7, 0.1); border-color: rgba(255, 193, 7, 0.3); color: #ffc107;">
                    <strong>üí° Format CSV Binance attendu :</strong><br>
                    Le CSV doit contenir les colonnes : <code>Coin</code>, <code>Free</code>, <code>Locked</code><br>
                    Exemple : BTC,0.5,0 | ETH,10.2,0.5
                </div>
            </div>

            <!-- Crypto Library -->
            <div class="crypto-library">
                <h3>üìö Biblioth√®que de Cryptos</h3>
                <div class="info-message" style="margin-bottom: 15px;">
                    Cliquez sur une crypto pour remplir automatiquement le symbole
                </div>
                <div class="crypto-grid" id="cryptoLibrary"></div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Symbole (ex: BTC, ETH)</label>
                    <input type="text" id="cryptoSymbol" placeholder="BTC">
                </div>
                <div class="form-group">
                    <label>Quantit√©</label>
                    <input type="number" id="cryptoQuantity" step="0.00000001" placeholder="0.5">
                </div>
                <div class="form-group">
                    <label>Prix d'achat ($)</label>
                    <input type="number" id="cryptoPrice" step="0.01" placeholder="50000">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="cryptoDate">
                </div>
            </div>
            <button onclick="addCrypto()">‚ûï Ajouter une position</button>
            
            <div id="cryptoList"></div>
        </div>

        <!-- PEA Section -->
        <div id="pea" class="section">
            <h2 style="margin-bottom: 20px;">üìä Plan d'√âpargne en Actions (PEA)</h2>
            
            <!-- Quick Select for existing assets -->
            <div class="info-message" style="margin-bottom: 20px;">
                <strong>üí° Astuce :</strong> Pour ajouter une ligne sur un actif existant, s√©lectionnez-le ci-dessous :
                <div id="quickSelectPEA" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px;"></div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Nom de l'action</label>
                    <input type="text" id="peaName" placeholder="Apple Inc." list="peaNameList">
                    <datalist id="peaNameList"></datalist>
                </div>
                <div class="form-group">
                    <label>Ticker</label>
                    <input type="text" id="peaTicker" placeholder="AAPL" list="peaTickerList">
                    <datalist id="peaTickerList"></datalist>
                </div>
                <div class="form-group">
                    <label>Quantit√©</label>
                    <input type="number" id="peaQuantity" step="1" placeholder="10">
                </div>
                <div class="form-group">
                    <label>Prix d'achat (‚Ç¨)</label>
                    <input type="number" id="peaPrice" step="0.01" placeholder="150.50">
                </div>
                <div class="form-group">
                    <label>Frais (‚Ç¨)</label>
                    <input type="number" id="peaFees" step="0.01" placeholder="5.00">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="peaDate">
                </div>
            </div>
            <button onclick="addPEA()">‚ûï Ajouter une position</button>
            
            <div id="peaList"></div>
        </div>

        <!-- Livrets Section -->
        <div id="livrets" class="section">
            <h2 style="margin-bottom: 20px;">üí∞ Livrets d'√©pargne</h2>
            
            <div class="info-message" style="margin-bottom: 20px;">
                <strong>üí° Taux actuels 2025 :</strong><br>
                ‚Ä¢ LEP (Livret d'√âpargne Populaire) : 4.00% net<br>
                ‚Ä¢ Livret A : 2.40% net<br>
                ‚Ä¢ LDDS (Livret de D√©veloppement Durable et Solidaire) : 2.40% net<br>
                ‚Ä¢ Livret Jeune : 2.40% √† 4.00% selon les banques<br>
                ‚Ä¢ PEL (Plan d'√âpargne Logement) : 2.25% brut (apr√®s pr√©l√®vements sociaux)
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Type de livret</label>
                    <select id="livretType">
                        <option value="">-- S√©lectionnez --</option>
                        <option value="LEP">LEP (Livret √âpargne Populaire)</option>
                        <option value="Livret A">Livret A</option>
                        <option value="LDDS">LDDS (Livret D√©veloppement Durable)</option>
                        <option value="Livret Jeune">Livret Jeune</option>
                        <option value="PEL">PEL (Plan √âpargne Logement)</option>
                        <option value="CEL">CEL (Compte √âpargne Logement)</option>
                        <option value="CSL">CSL (Compte Sur Livret)</option>
                        <option value="Autre">Autre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Banque</label>
                    <input type="text" id="livretBank" placeholder="Cr√©dit Agricole">
                </div>
                <div class="form-group">
                    <label>Montant actuel (‚Ç¨)</label>
                    <input type="number" id="livretAmount" step="0.01" placeholder="10000">
                </div>
                <div class="form-group">
                    <label>Taux d'int√©r√™t annuel (%)</label>
                    <input type="number" id="livretRate" step="0.01" placeholder="2.40">
                </div>
                <div class="form-group">
                    <label>Plafond (‚Ç¨)</label>
                    <input type="number" id="livretCeiling" step="0.01" placeholder="22950">
                </div>
                <div class="form-group">
                    <label>Date d'ouverture</label>
                    <input type="date" id="livretDate">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button onclick="addLivret()">‚ûï Ajouter un livret</button>
                <button onclick="autoFillLivretRate()" class="btn-secondary">üîÑ Appliquer les taux actuels</button>
            </div>
            
            <div id="livretsList"></div>
        </div>

        <!-- Fundraising Section -->
        <div id="fundraising" class="section">
            <h2 style="margin-bottom: 20px;">üöÄ Lev√©es de fonds / Investissements</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Nom de l'entreprise</label>
                    <input type="text" id="fundName" placeholder="StartupXYZ">
                </div>
                <div class="form-group">
                    <label>Montant investi (‚Ç¨)</label>
                    <input type="number" id="fundAmount" step="0.01" placeholder="10000">
                </div>
                <div class="form-group">
                    <label>Valuation (‚Ç¨)</label>
                    <input type="number" id="fundValuation" step="0.01" placeholder="1000000">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="fundDate">
                </div>
            </div>
            <button onclick="addFundraising()">‚ûï Ajouter un investissement</button>
            
            <div id="fundraisingList"></div>
        </div>

        <!-- Goals Section -->
        <div id="goals" class="section">
            <h2 style="margin-bottom: 20px;">üéØ Objectifs & Planning</h2>
            
            <!-- Add Goal Button -->
            <div style="margin-bottom: 32px;">
                <button class="update-btn" onclick="openGoalModal()" style="width: auto;">
                    ‚ûï Nouvel objectif
                </button>
            </div>
            
            <!-- Goals List -->
            <div id="goalsList" style="display: grid; gap: 20px;"></div>
            
            <!-- DCA Calculator -->
            <div style="margin-top: 48px;">
                <h3 style="font-size: 1.5em; margin-bottom: 24px;">üí∞ Simulateur d'investissement r√©gulier (DCA)</h3>
                <div class="fear-greed-card">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px;">
                        <div class="form-group">
                            <label>Montant mensuel (‚Ç¨)</label>
                            <input type="number" id="dcaMonthlyAmount" value="500" min="0" step="50">
                        </div>
                        <div class="form-group">
                            <label>Dur√©e (mois)</label>
                            <input type="number" id="dcaDuration" value="12" min="1" max="360">
                        </div>
                        <div class="form-group">
                            <label>Rendement annuel estim√© (%)</label>
                            <input type="number" id="dcaReturnRate" value="7" min="-50" max="100" step="0.5">
                        </div>
                    </div>
                    <button class="update-btn" onclick="calculateDCA()" style="width: 100%;">
                        Calculer la projection
                    </button>
                    <div id="dcaResults" style="margin-top: 24px;"></div>
                    <canvas id="dcaChart" style="margin-top: 24px; max-height: 300px;"></canvas>
                </div>
            </div>
            
            <!-- Retirement Calculator -->
            <div style="margin-top: 48px;">
                <h3 style="font-size: 1.5em; margin-bottom: 24px;">üèñÔ∏è Calculateur d'ind√©pendance financi√®re</h3>
                <div class="fear-greed-card">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px;">
                        <div class="form-group">
                            <label>Capital actuel (‚Ç¨)</label>
                            <input type="number" id="retireCurrentCapital" value="0" min="0" step="1000">
                        </div>
                        <div class="form-group">
                            <label>√âpargne mensuelle (‚Ç¨)</label>
                            <input type="number" id="retireMonthlySavings" value="1000" min="0" step="100">
                        </div>
                        <div class="form-group">
                            <label>Rendement annuel (%)</label>
                            <input type="number" id="retireReturnRate" value="7" min="0" max="100" step="0.5">
                        </div>
                        <div class="form-group">
                            <label>D√©penses mensuelles vis√©es (‚Ç¨)</label>
                            <input type="number" id="retireMonthlyExpenses" value="3000" min="0" step="100">
                        </div>
                        <div class="form-group">
                            <label>Taux de retrait s√©curis√© (%)</label>
                            <input type="number" id="retireWithdrawalRate" value="4" min="0" max="10" step="0.5">
                        </div>
                    </div>
                    <button class="update-btn" onclick="calculateRetirement()" style="width: 100%;">
                        Calculer l'ind√©pendance financi√®re
                    </button>
                    <div id="retireResults" style="margin-top: 24px;"></div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="section">
            <h2 style="margin-bottom: 20px;">‚öôÔ∏è Param√®tres</h2>
            
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">‚òÅÔ∏è Synchronisation Google Drive</h3>
                
                <div class="form-group" style="max-width: 600px; margin-top: 15px;">
                    <label>Google Client ID</label>
                    <input type="text" id="clientId" placeholder="Votre Client ID Google">
                    <button onclick="saveClientId()" style="margin-top: 10px;">üíæ Enregistrer</button>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <button onclick="connectGoogleDrive()">üîó Connecter</button>
                    <button class="btn-danger" onclick="disconnectGoogleDrive()">‚ùå D√©connecter</button>
                    <button class="btn-secondary" onclick="loadFromDrive()">üì• Charger</button>
                    <button class="btn-secondary" onclick="syncDriveData()">üì§ Sauvegarder</button>
                </div>
            </div>

            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">üìä Synchronisation Google Sheets</h3>
                <div class="info-message">
                    <strong>Configuration :</strong><br>
                    1. Cr√©ez une Google Sheet avec 2 colonnes : <code>ticker</code> et <code>prix</code><br>
                    2. Fichier ‚Üí Partager ‚Üí Publier sur le Web ‚Üí Publier<br>
                    3. Copiez l'ID de la feuille (dans l'URL : /d/<strong>ID_ICI</strong>/edit)<br>
                    4. Collez l'ID ci-dessous<br><br>
                    
                    <strong>Exemple d'URL :</strong><br>
                    <code>https://docs.google.com/spreadsheets/d/<span style="color: #00ff88;">1A2B3C4D5E6F7G8H9I0J</span>/edit</code><br><br>
                    
                    <strong>Format de votre feuille :</strong><br>
                    <table style="margin-top: 10px; max-width: 300px;">
                        <tr><th>ticker</th><th>prix</th></tr>
                        <tr><td>FR0013451333</td><td>87.37</td></tr>
                        <tr><td>AAPL</td><td>182.50</td></tr>
                    </table>
                </div>
                
                <div class="form-group" style="max-width: 600px; margin-top: 15px;">
                    <label>Google Sheet ID</label>
                    <input type="text" id="googleSheetId" placeholder="1A2B3C4D5E6F7G8H9I0J">
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <button onclick="saveGoogleSheetId()">üíæ Enregistrer l'ID</button>
                    <button onclick="syncPricesFromGoogleSheets()" class="btn-primary">üîÑ Synchroniser les prix</button>
                </div>
                
                <div style="margin-top: 15px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="autoSyncCheckbox" onchange="toggleAutoSync(this.checked)">
                        <span>üîÑ Synchronisation automatique (toutes les 5 minutes)</span>
                    </label>
                </div>
            </div>
            
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">üé® Interface & Accessibilit√©</h3>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Th√®me</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="setTheme('dark')" class="theme-option" id="theme-dark">üåô Sombre</button>
                        <button onclick="setTheme('light')" class="theme-option" id="theme-light">‚òÄÔ∏è Clair</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Devise</label>
                    <select id="currencySelect" onchange="changeCurrency(this.value)" style="padding: 10px; border-radius: 8px; background: var(--bg-secondary); border: 1px solid var(--border-subtle); color: var(--text-primary); width: 200px;">
                        <option value="EUR">‚Ç¨ Euro (EUR)</option>
                        <option value="USD">$ Dollar US (USD)</option>
                        <option value="GBP">¬£ Livre Sterling (GBP)</option>
                        <option value="CHF">CHF Franc Suisse (CHF)</option>
                    </select>
                </div>
                
                <div style="background: rgba(0, 212, 170, 0.1); padding: 15px; border-radius: 10px; border: 1px solid rgba(0, 212, 170, 0.3);">
                    <h4 style="margin-bottom: 10px;">‚å®Ô∏è Raccourcis clavier</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 8px; font-size: 0.9em;">
                        <div><kbd>Ctrl + N</kbd> ‚Üí Ajout rapide</div>
                        <div><kbd>Ctrl + D</kbd> ‚Üí Dashboard</div>
                        <div><kbd>Ctrl + P</kbd> ‚Üí Portfolio</div>
                        <div><kbd>Ctrl + T</kbd> ‚Üí Changer th√®me</div>
                        <div><kbd>Ctrl + H</kbd> ‚Üí Masquer/Afficher valeurs</div>
                        <div><kbd>Ctrl + E</kbd> ‚Üí Exporter PDF</div>
                        <div><kbd>Ctrl + S</kbd> ‚Üí Sauvegarder</div>
                        <div><kbd>Esc</kbd> ‚Üí Fermer modal</div>
                    </div>
                </div>
            </div>
            
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px;">
                <h3 style="margin-bottom: 15px;">üìÑ Export & Rapports</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="exportPDF()" class="btn-secondary">üìÑ Exporter en PDF</button>
                    <button onclick="printReport()" class="btn-secondary">üñ®Ô∏è Imprimer rapport</button>
                    <button onclick="exportExcel()" class="btn-secondary">üìä Exporter Excel</button>
                </div>
            </div>
            
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px; margin-top: 20px;">
                <h3 style="margin-bottom: 15px;">üíæ Import / Export Local</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="exportData()" class="btn-secondary">üì• Exporter JSON</button>
                    <label class="btn-secondary" style="margin: 0; cursor: pointer;">
                        üì§ Importer JSON
                        <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                    </label>
                </div>
            </div>
        </div>
    </div>

    </div>
    <script>
        // Popular cryptocurrencies library
        const cryptoLibrary = [
            { symbol: 'BTC', name: 'Bitcoin' },
            { symbol: 'ETH', name: 'Ethereum' },
            { symbol: 'BNB', name: 'Binance Coin' },
            { symbol: 'SOL', name: 'Solana' },
            { symbol: 'XRP', name: 'Ripple' },
            { symbol: 'ADA', name: 'Cardano' },
            { symbol: 'AVAX', name: 'Avalanche' },
            { symbol: 'DOGE', name: 'Dogecoin' },
            { symbol: 'DOT', name: 'Polkadot' },
            { symbol: 'MATIC', name: 'Polygon' },
            { symbol: 'LINK', name: 'Chainlink' },
            { symbol: 'UNI', name: 'Uniswap' },
            { symbol: 'ATOM', name: 'Cosmos' },
            { symbol: 'LTC', name: 'Litecoin' },
            { symbol: 'NEAR', name: 'NEAR Protocol' },
            { symbol: 'APT', name: 'Aptos' },
            { symbol: 'ARB', name: 'Arbitrum' },
            { symbol: 'OP', name: 'Optimism' },
            { symbol: 'SUI', name: 'Sui' },
            { symbol: 'PEPE', name: 'Pepe' },
            { symbol: 'SHIB', name: 'Shiba Inu' },
            { symbol: 'TRX', name: 'TRON' },
            { symbol: 'BCH', name: 'Bitcoin Cash' },
            { symbol: 'XLM', name: 'Stellar' },
            { symbol: 'AAVE', name: 'Aave' },
            { symbol: 'CRV', name: 'Curve' },
            { symbol: 'MKR', name: 'Maker' },
            { symbol: 'SNX', name: 'Synthetix' },
            { symbol: 'FTM', name: 'Fantom' },
            { symbol: 'ALGO', name: 'Algorand' }
        ];

        let portfolio = {
            crypto: [],
            pea: [],
            fundraising: [],
            prices: {},
            priceTimestamps: {},
            binanceCredentials: null,
            goals: []
        };

        let autoSyncInterval = null;
        let isGoogleDriveConnected = false;
        let accessToken = null;
        let tokenClient = null;
        let myChart = null;
        
        // UX preferences
        let currentTheme = localStorage.getItem('theme') || 'dark';
        let currentCurrency = localStorage.getItem('currency') || 'EUR';
        let exchangeRates = { EUR: 1, USD: 1.08, GBP: 0.86, CHF: 0.93 };
        
        // Helper function to get chart colors based on current theme
        function getChartColors() {
            const isLight = document.body.classList.contains('light-mode');
            return {
                text: isLight ? '#1a202c' : '#ffffff',
                textSecondary: isLight ? '#4a5568' : '#8892a6',
                grid: isLight ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.05)',
                tooltipBg: isLight ? 'rgba(255, 255, 255, 0.95)' : 'rgba(26, 32, 54, 0.95)',
                tooltipBorder: isLight ? 'rgba(255, 99, 71, 0.5)' : 'rgba(255, 99, 71, 0.5)'
            };
        }

        // ===== D√âTECTION DU TYPE D'APPAREIL =====
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isTablet = /(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(navigator.userAgent);
        const isDesktop = !isMobile && !isTablet;
        
        // D√©tection plus pr√©cise
        const deviceInfo = {
            isMobile: isMobile,
            isTablet: isTablet,
            isDesktop: isDesktop,
            screenWidth: window.innerWidth,
            screenHeight: window.innerHeight,
            isTouchDevice: 'ontouchstart' in window || navigator.maxTouchPoints > 0,
            platform: navigator.platform,
            userAgent: navigator.userAgent
        };
        
        // Fonction utilitaire pour adapter l'interface selon l'appareil
        function getDeviceType() {
            if (isMobile) return 'mobile';
            if (isTablet) return 'tablet';
            return 'desktop';
        }
        
        // Log du type d'appareil au d√©marrage
        console.log('üì± Type d\'appareil d√©tect√©:', getDeviceType());
        console.log('üìä Informations:', deviceInfo);

        // Initialize crypto library display
        function initCryptoLibrary() {
            const container = document.getElementById('cryptoLibrary');
            container.innerHTML = cryptoLibrary.map(crypto => `
                <div class="crypto-chip" onclick="selectCrypto('${crypto.symbol}')">
                    <div class="crypto-chip-symbol">${crypto.symbol}</div>
                    <div class="crypto-chip-name">${crypto.name}</div>
                </div>
            `).join('');
        }

        function selectCrypto(symbol) {
            document.getElementById('cryptoSymbol').value = symbol;
            
            // Visual feedback
            document.querySelectorAll('.crypto-chip').forEach(chip => {
                chip.classList.remove('selected');
            });
            event.target.closest('.crypto-chip').classList.add('selected');
        }

        // Binance API functions
        function saveBinanceCredentials() {
            const apiKey = document.getElementById('binanceApiKey').value.trim();
            const apiSecret = document.getElementById('binanceApiSecret').value.trim();
            
            if (!apiKey || !apiSecret) {
                alert('‚ö†Ô∏è Veuillez remplir les deux champs (API Key et API Secret)');
                return;
            }
            
            portfolio.binanceCredentials = { apiKey, apiSecret };
            saveData();
            updateBinanceStatus();
            alert('‚úÖ Cl√©s API Binance sauvegard√©es avec succ√®s !');
        }

        function clearBinanceCredentials() {
            if (confirm('üóëÔ∏è √ätes-vous s√ªr de vouloir supprimer vos cl√©s API Binance ?')) {
                portfolio.binanceCredentials = null;
                document.getElementById('binanceApiKey').value = '';
                document.getElementById('binanceApiSecret').value = '';
                saveData();
                updateBinanceStatus();
                alert('‚úÖ Cl√©s API supprim√©es');
            }
        }

        function updateBinanceStatus() {
            const statusEl = document.getElementById('binanceStatus');
            if (portfolio.binanceCredentials) {
                statusEl.textContent = '‚úì Connect√©';
                statusEl.className = 'api-status connected';
                
                // Fill credentials fields
                document.getElementById('binanceApiKey').value = portfolio.binanceCredentials.apiKey;
                document.getElementById('binanceApiSecret').value = portfolio.binanceCredentials.apiSecret;
            } else {
                statusEl.textContent = 'Non connect√©';
                statusEl.className = 'api-status disconnected';
            }
        }

        async function importFromBinance() {
            if (!portfolio.binanceCredentials) {
                alert('‚ö†Ô∏è Veuillez d\'abord sauvegarder vos cl√©s API Binance');
                return;
            }

            try {
                const timestamp = Date.now();
                const { apiKey, apiSecret } = portfolio.binanceCredentials;
                
                console.log('üîÑ Import depuis Binance...');
                console.log('API Key:', apiKey.substring(0, 10) + '...');
                
                // Create signature
                const queryString = `timestamp=${timestamp}`;
                const signature = await createHmacSignature(apiSecret, queryString);
                
                console.log('‚úÖ Signature cr√©√©e');
                
                // Binance API URL
                const binanceUrl = `https://api.binance.com/api/v3/account?${queryString}&signature=${signature}`;
                
                // Try with CORS proxy
                const proxies = [
                    `https://api.allorigins.win/get?url=${encodeURIComponent(binanceUrl)}`,
                    `https://corsproxy.io/?${encodeURIComponent(binanceUrl)}`,
                    binanceUrl // Try direct as last resort
                ];
                
                let data = null;
                let lastError = null;
                
                for (let i = 0; i < proxies.length; i++) {
                    try {
                        console.log(`‚è≥ Tentative ${i + 1}/${proxies.length}...`);
                        
                        const headers = {
                            'X-MBX-APIKEY': apiKey
                        };
                        
                        const response = await fetch(proxies[i], {
                            headers: i === 0 ? {} : headers, // AllOrigins doesn't forward headers
                            signal: AbortSignal.timeout(15000)
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        // Handle AllOrigins response format
                        if (i === 0) {
                            const proxyData = await response.json();
                            if (proxyData.contents) {
                                data = JSON.parse(proxyData.contents);
                            } else {
                                throw new Error('Proxy response invalid');
                            }
                        } else {
                            data = await response.json();
                        }
                        
                        // Check if we got valid data
                        if (data && data.balances) {
                            console.log('‚úÖ Donn√©es re√ßues de Binance');
                            break;
                        }
                        
                    } catch (error) {
                        console.warn(`‚ùå Proxy ${i + 1} failed:`, error.message);
                        lastError = error;
                        continue;
                    }
                }
                
                if (!data || !data.balances) {
                    throw new Error(`Impossible de se connecter √† Binance. 

Raisons possibles:
1. Les cl√©s API sont incorrectes
2. L'API Trading n'est pas activ√©e dans vos param√®tres Binance
3. Restrictions IP activ√©es sur votre cl√© API
4. CORS bloqu√© par le navigateur

Solution recommand√©e:
1. Allez sur Binance.com ‚Üí API Management
2. V√©rifiez que "Enable Spot & Margin Trading" est activ√©
3. Ajoutez "0.0.0.0/0" dans les IP autoris√©es (ou d√©sactivez la restriction IP)
4. Reg√©n√©rez votre cl√© API si n√©cessaire

Erreur technique: ${lastError?.message || 'Unknown'}`);
                }
                
                // Filter balances with value > 0
                const balances = data.balances.filter(b => parseFloat(b.free) > 0 || parseFloat(b.locked) > 0);
                
                console.log(`üìä ${balances.length} positions trouv√©es`);
                
                if (balances.length === 0) {
                    alert('‚ÑπÔ∏è Aucune position trouv√©e sur votre compte Binance');
                    return;
                }
                
                // Add positions to portfolio
                let imported = 0;
                let updated = 0;
                
                for (const balance of balances) {
                    const quantity = parseFloat(balance.free) + parseFloat(balance.locked);
                    const symbol = balance.asset;
                    
                    console.log(`${symbol}: ${quantity}`);
                    
                    // Check if already exists
                    const existingIndex = portfolio.crypto.findIndex(c => c.symbol === symbol);
                    
                    if (existingIndex >= 0) {
                        // Update existing
                        portfolio.crypto[existingIndex].quantity = quantity;
                        updated++;
                    } else {
                        // Add new
                        portfolio.crypto.push({
                            symbol: symbol,
                            quantity: quantity,
                            price: 0, // Will be updated with current price
                            date: new Date().toISOString().split('T')[0]
                        });
                        imported++;
                    }
                }
                
                saveData();
                await updateAll();
                
                alert(`‚úÖ Import Binance r√©ussi !

Nouvelles positions : ${imported}
Positions mises √† jour : ${updated}
Total : ${balances.length} cryptos

‚ö†Ô∏è Note : Les prix d'achat sont √† 0. 
Vous pouvez les modifier manuellement dans la liste ci-dessous.`);
                
            } catch (error) {
                console.error('‚ùå Erreur import Binance:', error);
                alert(`‚ùå Erreur lors de l'import depuis Binance:

${error.message}

üí° SOLUTION : Utilisez l'import CSV Binance (bouton "üì• Importer CSV Binance")

Aide au d√©pannage API:
‚Ä¢ V√©rifiez vos cl√©s API dans les param√®tres Binance
‚Ä¢ Assurez-vous que "Enable Spot & Margin Trading" est activ√©
‚Ä¢ V√©rifiez les restrictions IP (d√©sactivez-les temporairement pour tester)
‚Ä¢ Le probl√®me CORS persiste malgr√© nos tentatives de proxies`);
            }
        }
        
        // Import CSV from Binance
        function importBinanceCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('üì• Import CSV Binance...');
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    try {
                        ensurePortfolioStructure();
                        
                        let imported = 0;
                        let updated = 0;
                        let errors = [];
                        
                        console.log('üìä Lignes trouv√©es:', results.data.length);
                        
                        results.data.forEach((row, index) => {
                            // Try different possible column names
                            const coin = row.Coin || row.coin || row.Asset || row.asset || row.Symbol || row.symbol;
                            const free = parseFloat(row.Free || row.free || row.Available || row.available || 0);
                            const locked = parseFloat(row.Locked || row.locked || 0);
                            
                            if (!coin) {
                                errors.push(`Ligne ${index + 1}: Pas de symbole trouv√©`);
                                return;
                            }
                            
                            const quantity = free + locked;
                            
                            // Skip if quantity is 0
                            if (quantity <= 0) {
                                console.log(`‚è≠Ô∏è ${coin}: Quantit√© = 0, ignor√©`);
                                return;
                            }
                            
                            console.log(`üí∞ ${coin}: ${quantity} (Free: ${free}, Locked: ${locked})`);
                            
                            // Check if already exists
                            const existingIndex = portfolio.crypto.findIndex(c => c.symbol === coin.toUpperCase());
                            
                            if (existingIndex >= 0) {
                                // Update existing
                                portfolio.crypto[existingIndex].quantity = quantity;
                                updated++;
                            } else {
                                // Add new
                                portfolio.crypto.push({
                                    symbol: coin.toUpperCase(),
                                    quantity: quantity,
                                    price: 0, // Will be updated with current price
                                    date: new Date().toISOString().split('T')[0]
                                });
                                imported++;
                            }
                        });
                        
                        if (imported === 0 && updated === 0) {
                            alert(`‚ö†Ô∏è Aucune position valide trouv√©e dans le CSV.

V√©rifiez que votre CSV contient :
‚Ä¢ Une colonne "Coin" (ou "Asset"/"Symbol")
‚Ä¢ Une colonne "Free" (ou "Available")
‚Ä¢ Une colonne "Locked" (optionnel)

Erreurs d√©tect√©es :
${errors.length > 0 ? errors.join('\n') : 'Aucune ligne avec quantit√© > 0'}`);
                            return;
                        }
                        
                        saveData();
                        syncDriveData();
                        updateAll();
                        
                        alert(`‚úÖ Import CSV Binance r√©ussi !

Nouvelles positions : ${imported}
Positions mises √† jour : ${updated}
Total import√© : ${imported + updated} cryptos

‚ö†Ô∏è Note : Les prix d'achat sont √† 0.
Cliquez sur "Actualiser les prix" pour obtenir les prix actuels.
${errors.length > 0 ? '\n\n‚ö†Ô∏è Erreurs : ' + errors.length + ' lignes ignor√©es' : ''}`);
                        
                    } catch (err) {
                        console.error('‚ùå Erreur traitement CSV:', err);
                        alert(`‚ùå Erreur lors du traitement du CSV:

${err.message}

V√©rifiez que votre fichier CSV est au bon format.`);
                    }
                },
                error: function(error) {
                    alert(`‚ùå Erreur lecture CSV: ${error.message}`);
                }
            });
            
            // Reset input
            event.target.value = '';
        }

        async function createHmacSignature(secret, message) {
            const encoder = new TextEncoder();
            const keyData = encoder.encode(secret);
            const messageData = encoder.encode(message);
            
            const key = await crypto.subtle.importKey(
                'raw',
                keyData,
                { name: 'HMAC', hash: 'SHA-256' },
                false,
                ['sign']
            );
            
            const signature = await crypto.subtle.sign('HMAC', key, messageData);
            return Array.from(new Uint8Array(signature))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        // ===== MOBILE MENU TOGGLE =====
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const body = document.body;
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
            body.classList.toggle('menu-open');
        }
        
        // Fermer le menu quand on clique sur un lien de navigation
        document.addEventListener('DOMContentLoaded', function() {
            if (isMobile) {
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    item.addEventListener('click', function() {
                        // Fermer le menu apr√®s un court d√©lai
                        setTimeout(() => {
                            if (document.querySelector('.sidebar').classList.contains('open')) {
                                toggleMobileMenu();
                            }
                        }, 200);
                    });
                });
            }
        });

        function showSection(sectionId) {
            // Update nav items - make active button RED
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-section') === sectionId) {
                    item.classList.add('active');
                }
            });
            
            // Show section
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
        }

        // ===== PRIVACY MODE =====
        let isPrivacyMode = false;

        function togglePrivacy() {
            isPrivacyMode = !isPrivacyMode;
            const body = document.body;
            const icon = document.getElementById('privacyIcon');
            const text = document.getElementById('privacyText');
            const btn = document.getElementById('privacyToggle');
            
            if (isPrivacyMode) {
                body.classList.add('privacy-mode');
                icon.textContent = 'üôà';
                text.textContent = 'Afficher';
                btn.classList.add('active');
            } else {
                body.classList.remove('privacy-mode');
                icon.textContent = 'üëÅÔ∏è';
                text.textContent = 'Masquer';
                btn.classList.remove('active');
            }
            
            // Appliquer le mode privacy (que ce soit pour masquer OU afficher)
            applyPrivacyMode();
            
            // Sauvegarder la pr√©f√©rence
            localStorage.setItem('privacyMode', isPrivacyMode);
        }

        function applyPrivacyMode() {
            // Retirer les anciennes classes et filtres
            document.querySelectorAll('.value-hidden').forEach(el => {
                el.classList.remove('value-hidden');
            });
            document.querySelectorAll('canvas').forEach(canvas => {
                canvas.style.filter = 'none';
            });
            document.querySelectorAll('.chart-container').forEach(container => {
                container.style.filter = 'none';
            });
            
            if (!isPrivacyMode) return;
            
            // ===== MASQUER UNIQUEMENT LES VALEURS FINANCI√àRES PERSONNELLES =====
            
            // 1. Stats du dashboard (les 4 grandes cartes en haut)
            document.querySelectorAll('#dashboardStats .stat-value').forEach(el => {
                el.classList.add('value-hidden');
            });
            
            // 2. Valeurs dans les d√©tails d'actifs (sections crypto, PEA)
            document.querySelectorAll('.asset-stat-value').forEach(el => {
                el.classList.add('value-hidden');
            });
            
            // 3. Tableaux - Historique des transactions
            document.querySelectorAll('#transactionHistory td').forEach(td => {
                const cellIndex = Array.from(td.parentElement.children).indexOf(td);
                // Masquer : Quantit√© (col 4), Prix (col 5), Montant (col 6)
                // Ne PAS masquer : Date (0), Type (1), Cat√©gorie (2), Actif (3)
                if (cellIndex >= 4) {
                    td.classList.add('value-hidden');
                }
            });
            
            // 4. Tableaux - Autres tableaux (d√©tails actifs)
            document.querySelectorAll('table:not(#transactionHistory) tbody tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                cells.forEach((cell, index) => {
                    const text = cell.textContent.trim();
                    // Masquer seulement les montants et prix
                    if (text.match(/^[$‚Ç¨]\d|^\d+[.,]\d+\s*[$‚Ç¨]?$|^\+\d|^-\d/)) {
                        cell.classList.add('value-hidden');
                    }
                });
            });
            
            // 5. Toutes les Plus-values et Moins-values (P&L)
            document.querySelectorAll('td, div, span').forEach(el => {
                const text = el.textContent.trim();
                // Masquer tout ce qui ressemble √† +‚Ç¨123.45 ou -‚Ç¨123.45 ou +8.16% ou -3.2%
                if (text.match(/^[+\-][‚Ç¨$]?\d+[.,]?\d*\s*[‚Ç¨$]?$|^[+\-]\d+[.,]\d+%$/)) {
                    el.classList.add('value-hidden');
                }
            });
            
            // 6. P&L sp√©cifique dans les sections
            document.querySelectorAll('.positive, .negative').forEach(el => {
                const text = el.textContent.trim();
                if (text.match(/[+\-‚Ç¨$\d%]/)) {
                    el.classList.add('value-hidden');
                }
            });
            
            // 7. Section Performance - uniquement les valeurs et %
            document.querySelectorAll('#topPerformers, #worstPerformers').forEach(section => {
                section.querySelectorAll('div').forEach(el => {
                    const text = el.textContent.trim();
                    // Masquer montants et pourcentages
                    if (text.match(/^[‚Ç¨$]\d+|^[+\-]\d+[.,]\d+%$/)) {
                        el.classList.add('value-hidden');
                    }
                });
            });
            
            // 8. R√©capitulatif des livrets
            document.querySelectorAll('p, div').forEach(el => {
                const text = el.textContent.trim();
                if (text.match(/^Total √©pargn√©\s*:\s*[‚Ç¨$]|^Int√©r√™ts.*:\s*[‚Ç¨$]/)) {
                    const parts = text.split(':');
                    if (parts.length === 2) {
                        el.innerHTML = parts[0] + ': <span class="value-hidden">' + parts[1] + '</span>';
                    }
                }
            });
            
            // 9. Section Portfolio - Vue globale et d√©tails
            document.querySelectorAll('#portfolioOverview .stat-value, #portfolioOverview div[style*="font-size: 2.2em"], #portfolioOverview div[style*="font-size: 1.3em"]').forEach(el => {
                el.classList.add('value-hidden');
            });
            
            // Portfolio - Masquer aussi les valeurs dans les cartes de cat√©gories
            document.querySelectorAll('#portfolioOverview div[style*="font-weight: 700"]').forEach(el => {
                const text = el.textContent.trim();
                if (text.match(/^[‚Ç¨$]\d+|^[+\-]\d+[.,]\d+%$|^\d+\s*(actifs|comptes|projets)$/)) {
                    el.classList.add('value-hidden');
                }
            });
            
            // ===== EXCEPTIONS - NE JAMAIS MASQUER =====
            
            // Indices Fear & Greed
            document.querySelectorAll('#cryptoFearGreed, #stockFearGreed').forEach(section => {
                section.querySelectorAll('*').forEach(el => {
                    el.classList.remove('value-hidden');
                });
            });
            
            // Score de diversification
            document.querySelectorAll('#diversificationScore, #divScore').forEach(el => {
                el.classList.remove('value-hidden');
            });
            
            // Labels et noms
            document.querySelectorAll('.asset-name, .asset-ticker, .stat-label, .asset-stat-label, h1, h2, h3, h4, label, th').forEach(el => {
                el.classList.remove('value-hidden');
            });
            
            // Labels sp√©cifiques Portfolio (Valeur totale, Performance, etc.)
            document.querySelectorAll('#portfolioOverview div[style*="font-size: 0.9em"]').forEach(el => {
                el.classList.remove('value-hidden');
            });
            document.querySelectorAll('#portfolioOverview div[style*="font-size: 0.85em"]').forEach(el => {
                el.classList.remove('value-hidden');
            });
            
            // ===== GRAPHIQUES =====
            applyPrivacyToCharts();
        }
        
        // Fonction s√©par√©e pour g√©rer le flou des graphiques
        function applyPrivacyToCharts() {
            if (isPrivacyMode) {
                // Graphique d'√©volution du patrimoine
                const evolutionChart = document.getElementById('evolutionChart');
                if (evolutionChart && evolutionChart.closest('.chart-container')) {
                    evolutionChart.closest('.chart-container').style.filter = 'blur(8px)';
                }
                
                // Graphiques individuels des actifs
                document.querySelectorAll('canvas[id^="chart-"]').forEach(canvas => {
                    canvas.style.filter = 'blur(8px)';
                });
                
                // Graphique donut principal
                const portfolioChart = document.getElementById('portfolioChart');
                if (portfolioChart) {
                    portfolioChart.style.filter = 'blur(8px)';
                }
                
                // Graphique de r√©partition du Portfolio
                const portfolioAllocationChart = document.getElementById('portfolioAllocationChart');
                if (portfolioAllocationChart) {
                    portfolioAllocationChart.style.filter = 'blur(8px)';
                }
                
                // Graphique de diversification
                const assetClassChart = document.getElementById('assetClassChart');
                if (assetClassChart) {
                    assetClassChart.style.filter = 'blur(8px)';
                }
            } else {
                // Mode normal - retirer tous les flous
                document.querySelectorAll('canvas').forEach(canvas => {
                    canvas.style.filter = 'none';
                });
                document.querySelectorAll('.chart-container').forEach(container => {
                    container.style.filter = 'none';
                });
            }
            
            // NE JAMAIS flouter le graphique de diversification
            const assetClassChart = document.getElementById('assetClassChart');
            if (assetClassChart) {
                assetClassChart.style.filter = 'none';
            }
        }

        // Charger la pr√©f√©rence au d√©marrage
        window.addEventListener('load', () => {
            // Ajouter la classe CSS selon le type d'appareil
            document.body.classList.add(`device-${getDeviceType()}`);
            
            // Charger la pr√©f√©rence de privacy
            const savedPrivacy = localStorage.getItem('privacyMode') === 'true';
            if (savedPrivacy) {
                togglePrivacy();
            }
        });

        function ensurePortfolioStructure() {
            if (!portfolio.crypto) portfolio.crypto = [];
            if (!portfolio.pea) portfolio.pea = [];
            if (!portfolio.livrets) portfolio.livrets = [];
            if (!portfolio.fundraising) portfolio.fundraising = [];
            if (!portfolio.prices) portfolio.prices = {};
            if (!portfolio.priceTimestamps) portfolio.priceTimestamps = {};
            if (!portfolio.binanceCredentials) portfolio.binanceCredentials = null;
            if (!portfolio.goals) portfolio.goals = [];
        }

        function addCrypto() {
            const symbol = document.getElementById('cryptoSymbol').value.toUpperCase();
            const quantity = parseFloat(document.getElementById('cryptoQuantity').value);
            const price = parseFloat(document.getElementById('cryptoPrice').value);
            const date = document.getElementById('cryptoDate').value;

            if (!symbol || !quantity || !price || !date) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            portfolio.crypto.push({ symbol, quantity, price, date });
            saveData();
            syncDriveData();
            updateCryptoList();
            
            document.getElementById('cryptoSymbol').value = '';
            document.getElementById('cryptoQuantity').value = '';
            document.getElementById('cryptoPrice').value = '';
            
            // Remove selection
            document.querySelectorAll('.crypto-chip').forEach(chip => {
                chip.classList.remove('selected');
            });
        }

        function addPEA() {
            const name = document.getElementById('peaName').value;
            const ticker = document.getElementById('peaTicker').value.toUpperCase();
            const quantity = parseFloat(document.getElementById('peaQuantity').value);
            const price = parseFloat(document.getElementById('peaPrice').value);
            const fees = parseFloat(document.getElementById('peaFees').value) || 0;
            const date = document.getElementById('peaDate').value;

            if (!name || !ticker || !quantity || !price || !date) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }

            portfolio.pea.push({ name, ticker, quantity, price, fees, date });
            saveData();
            syncDriveData();
            updatePEAList();
            updatePEAQuickSelect(); // Update quick select buttons
            
            document.getElementById('peaName').value = '';
            document.getElementById('peaTicker').value = '';
            document.getElementById('peaQuantity').value = '';
            document.getElementById('peaPrice').value = '';
            document.getElementById('peaFees').value = '';
        }
        
        // Function to fill form with existing asset data
        function fillPEAForm(name, ticker) {
            document.getElementById('peaName').value = name;
            document.getElementById('peaTicker').value = ticker;
            document.getElementById('peaQuantity').focus();
        }
        
        // Function to update quick select buttons and autocomplete
        function updatePEAQuickSelect() {
            const container = document.getElementById('quickSelectPEA');
            if (!container) return;
            
            // Get unique assets (grouped by ticker)
            const uniqueAssets = {};
            portfolio.pea.forEach(item => {
                if (!uniqueAssets[item.ticker]) {
                    uniqueAssets[item.ticker] = {
                        name: item.name,
                        ticker: item.ticker
                    };
                }
            });
            
            // Update quick select buttons
            if (Object.keys(uniqueAssets).length === 0) {
                container.innerHTML = '<em style="color: #a0aec0;">Aucun actif existant</em>';
            } else {
                container.innerHTML = Object.values(uniqueAssets).map(asset => 
                    `<button class="quick-select-btn" onclick="fillPEAForm('${asset.name}', '${asset.ticker}')">
                        ${asset.name} (${asset.ticker})
                    </button>`
                ).join('');
            }
            
            // Update autocomplete datalists
            const nameList = document.getElementById('peaNameList');
            const tickerList = document.getElementById('peaTickerList');
            
            if (nameList && tickerList) {
                nameList.innerHTML = Object.values(uniqueAssets).map(asset => 
                    `<option value="${asset.name}">`
                ).join('');
                
                tickerList.innerHTML = Object.values(uniqueAssets).map(asset => 
                    `<option value="${asset.ticker}">`
                ).join('');
            }
        }
        
        // Auto-sync name and ticker when typing
        document.addEventListener('DOMContentLoaded', function() {
            const peaNameInput = document.getElementById('peaName');
            const peaTickerInput = document.getElementById('peaTicker');
            
            if (peaNameInput && peaTickerInput) {
                peaNameInput.addEventListener('input', function() {
                    // Find matching asset by name
                    const matchingAsset = portfolio.pea.find(item => 
                        item.name.toLowerCase() === this.value.toLowerCase()
                    );
                    if (matchingAsset) {
                        peaTickerInput.value = matchingAsset.ticker;
                    }
                });
                
                peaTickerInput.addEventListener('input', function() {
                    // Find matching asset by ticker
                    const matchingAsset = portfolio.pea.find(item => 
                        item.ticker.toUpperCase() === this.value.toUpperCase()
                    );
                    if (matchingAsset) {
                        peaNameInput.value = matchingAsset.name;
                    }
                });
            }
        });

        function addFundraising() {
            const name = document.getElementById('fundName').value;
            const amount = parseFloat(document.getElementById('fundAmount').value);
            const valuation = parseFloat(document.getElementById('fundValuation').value);
            const date = document.getElementById('fundDate').value;

            if (!name || !amount || !valuation || !date) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            if (isNaN(amount) || isNaN(valuation)) {
                alert('Montant et valuation doivent √™tre des nombres');
                return;
            }
            
            // Ensure portfolio structure exists
            ensurePortfolioStructure();
            
            portfolio.fundraising.push({ 
                name: name, 
                amount: amount, 
                valuation: valuation, 
                date: date 
            });
            
            console.log('‚úÖ Investissement ajout√©:', { name, amount, valuation, date });
            
            saveData();
            syncDriveData();
            updateFundraisingList();
            updateAll();
            
            // Clear form
            document.getElementById('fundName').value = '';
            document.getElementById('fundAmount').value = '';
            document.getElementById('fundValuation').value = '';
        }

        async function updatePrices() {
            const cryptoSymbols = [...new Set(portfolio.crypto.map(c => c.symbol))];
            const peaTickers = [...new Set(portfolio.pea.map(p => p.ticker))];
            
            for (const symbol of cryptoSymbols) {
                try {
                    const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${getCoinGeckoId(symbol)}&vs_currencies=usd`);
                    const data = await res.json();
                    const coinId = getCoinGeckoId(symbol);
                    if (data[coinId]) {
                        portfolio.prices[symbol] = data[coinId].usd;
                        portfolio.priceTimestamps[symbol] = Date.now();
                    }
                } catch (e) {
                    console.error(`Erreur prix ${symbol}:`, e);
                }
            }

            for (const ticker of peaTickers) {
                try {
                    const res = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1d`);
                    const data = await res.json();
                    if (data.chart.result[0]) {
                        const price = data.chart.result[0].meta.regularMarketPrice;
                        portfolio.prices[ticker] = price;
                        portfolio.priceTimestamps[ticker] = Date.now();
                    }
                } catch (e) {
                    console.error(`Erreur prix ${ticker}:`, e);
                }
            }
            
            saveData();
        }

        function getCoinGeckoId(symbol) {
            const map = {
                'BTC': 'bitcoin', 'ETH': 'ethereum', 'BNB': 'binancecoin',
                'SOL': 'solana', 'XRP': 'ripple', 'ADA': 'cardano',
                'AVAX': 'avalanche-2', 'DOGE': 'dogecoin', 'DOT': 'polkadot',
                'MATIC': 'matic-network', 'LINK': 'chainlink', 'UNI': 'uniswap',
                'ATOM': 'cosmos', 'LTC': 'litecoin', 'NEAR': 'near',
                'APT': 'aptos', 'ARB': 'arbitrum', 'OP': 'optimism',
                'SUI': 'sui', 'PEPE': 'pepe', 'SHIB': 'shiba-inu',
                'TRX': 'tron', 'BCH': 'bitcoin-cash', 'XLM': 'stellar',
                'AAVE': 'aave', 'CRV': 'curve-dao-token', 'MKR': 'maker',
                'SNX': 'synthetix-network-token', 'FTM': 'fantom', 'ALGO': 'algorand'
            };
            return map[symbol] || symbol.toLowerCase();
        }

        function updateCryptoList() {
            const grouped = {};
            portfolio.crypto.forEach(item => {
                if (!grouped[item.symbol]) grouped[item.symbol] = [];
                grouped[item.symbol].push(item);
            });

            const html = Object.entries(grouped).map(([symbol, items]) => {
                const totalQty = items.reduce((sum, i) => sum + i.quantity, 0);
                const avgPrice = items.reduce((sum, i) => sum + (i.price * i.quantity), 0) / totalQty;
                const currentPrice = portfolio.prices[symbol] || 0;
                const currentValue = totalQty * currentPrice;
                const invested = items.reduce((sum, i) => sum + (i.price * i.quantity), 0);
                const pnl = currentValue - invested;
                const pnlPercent = ((pnl / invested) * 100) || 0;

                const cryptoInfo = cryptoLibrary.find(c => c.symbol === symbol);
                const fullName = cryptoInfo ? cryptoInfo.name : symbol;

                return `
                    <div class="asset-group">
                        <div class="asset-header" onclick="toggleAsset('${symbol}')">
                            <div class="asset-header-left">
                                <span class="asset-toggle" id="toggle-${symbol}">‚ñ∂</span>
                                <div>
                                    <div class="asset-name">${fullName}</div>
                                    <div class="asset-ticker">${symbol}</div>
                                </div>
                            </div>
                            <div class="asset-stats">
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Quantit√©</div>
                                    <div class="asset-stat-value">${totalQty.toFixed(8)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Prix moyen</div>
                                    <div class="asset-stat-value">$${avgPrice.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Prix actuel</div>
                                    <div class="asset-stat-value">$${currentPrice.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Valeur</div>
                                    <div class="asset-stat-value">$${currentValue.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">P&L</div>
                                    <div class="asset-stat-value ${pnl >= 0 ? 'positive' : 'negative'}">
                                        ${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}
                                    </div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">P&L %</div>
                                    <div class="asset-stat-value ${pnlPercent >= 0 ? 'positive' : 'negative'}">
                                        ${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="asset-content" id="content-${symbol}">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Quantit√©</th>
                                        <th>Prix d'achat</th>
                                        <th>Valeur actuelle</th>
                                        <th>P&L</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${items.map((item, idx) => {
                                        const itemValue = item.quantity * currentPrice;
                                        const itemInvested = item.quantity * item.price;
                                        const itemPnl = itemValue - itemInvested;
                                        const itemPnlPercent = ((itemPnl / itemInvested) * 100) || 0;
                                        
                                        return `
                                            <tr>
                                                <td>${item.date}</td>
                                                <td>${item.quantity}</td>
                                                <td>$${item.price.toFixed(2)}</td>
                                                <td>$${itemValue.toFixed(2)}</td>
                                                <td class="${itemPnl >= 0 ? 'positive' : 'negative'}">
                                                    ${itemPnl >= 0 ? '+' : ''}$${itemPnl.toFixed(2)} (${itemPnlPercent.toFixed(2)}%)
                                                </td>
                                                <td>
                                                    <button onclick="editCrypto('${symbol}', ${portfolio.crypto.indexOf(item)})" class="btn-secondary">‚úèÔ∏è</button>
                                                    <button onclick="deleteCrypto(${portfolio.crypto.indexOf(item)})" class="btn-danger">üóëÔ∏è</button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('cryptoList').innerHTML = html;
            
            // Appliquer le mode privacy si activ√©
            if (isPrivacyMode) {
                applyPrivacyMode();
            }
        }

        function updatePEAList() {
            const grouped = {};
            portfolio.pea.forEach((item, index) => {
                if (!grouped[item.ticker]) {
                    grouped[item.ticker] = {
                        name: item.name || item.ticker,
                        ticker: item.ticker,
                        purchases: []
                    };
                }
                grouped[item.ticker].purchases.push({ ...item, originalIndex: index });
            });

            const html = Object.entries(grouped).map(([ticker, asset]) => {
                const totalQty = asset.purchases.reduce((sum, i) => sum + i.quantity, 0);
                const totalFees = asset.purchases.reduce((sum, i) => sum + (i.fees || 0), 0);
                const totalInvested = asset.purchases.reduce((sum, i) => sum + (i.price * i.quantity) + (i.fees || 0), 0);
                const avgPrice = totalQty > 0 ? totalInvested / totalQty : 0;
                const currentPrice = portfolio.prices[ticker] || avgPrice;
                const currentValue = totalQty * currentPrice;
                const pnl = currentValue - totalInvested;
                const pnlPercent = totalInvested > 0 ? (pnl / totalInvested) * 100 : 0;

                const lastUpdate = portfolio.priceTimestamps[ticker] 
                    ? new Date(portfolio.priceTimestamps[ticker]).toLocaleString('fr-FR')
                    : 'Jamais';

                return `
                    <div class="asset-group">
                        <div class="asset-header" onclick="toggleAsset('${ticker}')">
                            <div class="asset-header-left">
                                <span class="asset-toggle" id="toggle-${ticker}">‚ñ∂</span>
                                <div>
                                    <div class="asset-name">${asset.name}</div>
                                    <div class="asset-ticker">${ticker} ‚Ä¢ MAJ: ${lastUpdate}</div>
                                </div>
                            </div>
                            <div class="asset-stats">
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Quantit√©</div>
                                    <div class="asset-stat-value">${totalQty.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Investi</div>
                                    <div class="asset-stat-value">‚Ç¨${totalInvested.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">PRU</div>
                                    <div class="asset-stat-value">‚Ç¨${avgPrice.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Prix actuel</div>
                                    <div class="asset-stat-value">‚Ç¨${currentPrice.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Valeur</div>
                                    <div class="asset-stat-value">‚Ç¨${currentValue.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">P&L</div>
                                    <div class="asset-stat-value ${pnl >= 0 ? 'positive' : 'negative'}">
                                        ${pnl >= 0 ? '+' : ''}‚Ç¨${pnl.toFixed(2)}
                                    </div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">P&L %</div>
                                    <div class="asset-stat-value ${pnlPercent >= 0 ? 'positive' : 'negative'}">
                                        ${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="asset-content" id="details-${ticker}" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 20px;">
                                <h4 style="margin: 0; color: #a0aec0;">üìä Historique des achats</h4>
                                <div style="flex: 1; max-width: 500px; height: 150px;">
                                    <canvas id="chart-${ticker}"></canvas>
                                </div>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Quantit√©</th>
                                        <th>Prix d'achat</th>
                                        <th>Frais</th>
                                        <th>Valeur actuelle</th>
                                        <th>P&L</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${asset.purchases.map((item) => {
                                        const itemValue = item.quantity * currentPrice;
                                        const itemInvested = item.quantity * item.price + (item.fees || 0);
                                        const itemPnl = itemValue - itemInvested;
                                        const itemPnlPercent = itemInvested > 0 ? ((itemPnl / itemInvested) * 100) : 0;
                                        
                                        return `
                                            <tr>
                                                <td>${new Date(item.date).toLocaleDateString('fr-FR')}</td>
                                                <td>${item.quantity.toFixed(2)}</td>
                                                <td>‚Ç¨${item.price.toFixed(2)}</td>
                                                <td>‚Ç¨${(item.fees || 0).toFixed(2)}</td>
                                                <td>‚Ç¨${itemValue.toFixed(2)}</td>
                                                <td class="${itemPnl >= 0 ? 'positive' : 'negative'}">
                                                    ${itemPnl >= 0 ? '+' : ''}‚Ç¨${itemPnl.toFixed(2)} (${itemPnlPercent.toFixed(2)}%)
                                                </td>
                                                <td>
                                                    <button onclick="editPEA('${ticker}', ${item.originalIndex})" class="btn-secondary">‚úèÔ∏è</button>
                                                    <button onclick="deletePEA(${item.originalIndex})" class="btn-danger">üóëÔ∏è</button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('peaList').innerHTML = html;
            
            // Create charts for each asset
            Object.entries(grouped).forEach(([ticker, asset]) => {
                const currentPrice = portfolio.prices[ticker] || 0;
                setTimeout(() => createAssetChart(ticker, asset.purchases, currentPrice), 100);
            });
            
            // Appliquer le mode privacy si activ√©
            if (isPrivacyMode) {
                setTimeout(() => applyPrivacyMode(), 200);
            }
        }

        function updateFundraisingList() {
            const container = document.getElementById('fundraisingList');
            if (!container) {
                console.error('Container fundraisingList not found');
                return;
            }
            
            if (!portfolio.fundraising || portfolio.fundraising.length === 0) {
                container.innerHTML = '<p style="color: #a0aec0; text-align: center; padding: 40px;">Aucun investissement enregistr√©.</p>';
                return;
            }
            
            const html = portfolio.fundraising.map((item, index) => {
                // V√©rification et conversion s√©curis√©e
                const amount = parseFloat(item.amount) || 0;
                const valuation = parseFloat(item.valuation) || 0;
                const date = item.date || 'N/A';
                const name = item.name || 'Sans nom';
                
                const equity = valuation > 0 ? (amount / valuation) * 100 : 0;
                
                return `
                    <div class="asset-group">
                        <div class="asset-header">
                            <div class="asset-header-left">
                                <div>
                                    <div class="asset-name">${name}</div>
                                    <div class="asset-ticker">${date}</div>
                                </div>
                            </div>
                            <div class="asset-stats">
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Investi</div>
                                    <div class="asset-stat-value">‚Ç¨${amount.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Valuation</div>
                                    <div class="asset-stat-value">‚Ç¨${valuation.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Part</div>
                                    <div class="asset-stat-value">${equity.toFixed(4)}%</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Actions</div>
                                    <div>
                                        <button onclick="editFundraising(${index})" class="btn-secondary">‚úèÔ∏è</button>
                                        <button onclick="deleteFundraising(${index})" class="btn-danger">üóëÔ∏è</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            container.innerHTML = html;
        }

        function createAssetChart(ticker, purchases, currentPrice) {
            const ctx = document.getElementById(`chart-${ticker}`);
            if (!ctx) return;
            
            // Sort purchases by date
            const sortedPurchases = [...purchases].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Calculate cumulative portfolio value over time
            const chartData = [];
            let cumulativeQuantity = 0;
            let cumulativeInvested = 0;
            
            sortedPurchases.forEach(p => {
                const fees = p.fees || 0;
                cumulativeQuantity += p.quantity;
                cumulativeInvested += (p.quantity * p.price) + fees;
                
                const avgPrice = cumulativeInvested / cumulativeQuantity;
                const currentValue = cumulativeQuantity * currentPrice;
                
                chartData.push({
                    date: new Date(p.date).toLocaleDateString('fr-FR'),
                    invested: cumulativeInvested,
                    value: currentValue,
                    quantity: cumulativeQuantity
                });
            });
            
            // Create chart
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(d => d.date),
                    datasets: [
                        {
                            label: 'Valeur actuelle',
                            data: chartData.map(d => d.value),
                            borderColor: '#00ff88',
                            backgroundColor: 'rgba(0, 255, 136, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Montant investi',
                            data: chartData.map(d => d.invested),
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#fff', font: { size: 10 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' ‚Ç¨';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#a0aec0' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#a0aec0' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function toggleAsset(ticker) {
            const content = document.getElementById(`content-${ticker}`);
            const details = document.getElementById(`details-${ticker}`);
            const toggle = document.getElementById(`toggle-${ticker}`);
            
            const targetElement = content || details;
            
            if (targetElement) {
                if (targetElement.classList.contains('expanded') || targetElement.style.display === 'block') {
                    targetElement.classList.remove('expanded');
                    targetElement.style.display = 'none';
                    if (toggle) toggle.classList.remove('expanded');
                } else {
                    targetElement.classList.add('expanded');
                    targetElement.style.display = 'block';
                    if (toggle) toggle.classList.add('expanded');
                }
            }
        }

        function editCrypto(symbol, index) {
            const item = portfolio.crypto[index];
            const newQuantity = prompt('Nouvelle quantit√©:', item.quantity);
            const newPrice = prompt('Nouveau prix:', item.price);
            
            if (newQuantity !== null && newPrice !== null) {
                portfolio.crypto[index].quantity = parseFloat(newQuantity);
                portfolio.crypto[index].price = parseFloat(newPrice);
                saveData();
                syncDriveData();
                updateCryptoList();
            }
        }

        function deleteCrypto(index) {
            if (confirm('Supprimer cette position ?')) {
                portfolio.crypto.splice(index, 1);
                saveData();
                syncDriveData();
                updateCryptoList();
            }
        }

        function editPEA(ticker, index) {
            const item = portfolio.pea[index];
            const newQuantity = prompt('Nouvelle quantit√©:', item.quantity);
            const newPrice = prompt('Nouveau prix:', item.price);
            const newFees = prompt('Nouveaux frais:', item.fees);
            
            if (newQuantity !== null && newPrice !== null && newFees !== null) {
                portfolio.pea[index].quantity = parseFloat(newQuantity);
                portfolio.pea[index].price = parseFloat(newPrice);
                portfolio.pea[index].fees = parseFloat(newFees);
                saveData();
                syncDriveData();
                updatePEAList();
            }
        }

        function deletePEA(index) {
            if (confirm('Supprimer cette position ?')) {
                portfolio.pea.splice(index, 1);
                saveData();
                syncDriveData();
                updatePEAList();
            }
        }

        function editFundraising(index) {
            const item = portfolio.fundraising[index];
            const newAmount = prompt('Nouveau montant investi:', item.amount);
            const newValuation = prompt('Nouvelle valuation:', item.valuation);
            
            if (newAmount !== null && newValuation !== null) {
                portfolio.fundraising[index].amount = parseFloat(newAmount);
                portfolio.fundraising[index].valuation = parseFloat(newValuation);
                saveData();
                syncDriveData();
                updateFundraisingList();
            }
        }

        function deleteFundraising(index) {
            if (confirm('Supprimer cet investissement ?')) {
                portfolio.fundraising.splice(index, 1);
                saveData();
                syncDriveData();
                updateFundraisingList();
                updateAll();
            }
        }

        // ========================================
        // LIVRETS D'√âPARGNE FUNCTIONS
        // ========================================
        
        function addLivret() {
            const type = document.getElementById('livretType').value;
            const bank = document.getElementById('livretBank').value;
            const amount = parseFloat(document.getElementById('livretAmount').value);
            const rate = parseFloat(document.getElementById('livretRate').value);
            const ceiling = parseFloat(document.getElementById('livretCeiling').value) || null;
            const date = document.getElementById('livretDate').value;

            if (!type || !bank || !amount || !rate || !date) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            if (isNaN(amount) || isNaN(rate)) {
                alert('Montant et taux doivent √™tre des nombres');
                return;
            }

            ensurePortfolioStructure();
            
            portfolio.livrets.push({ 
                type, 
                bank, 
                amount, 
                rate, 
                ceiling,
                date 
            });
            
            console.log('‚úÖ Livret ajout√©:', { type, bank, amount, rate, ceiling, date });
            
            saveData();
            syncDriveData();
            updateLivretsList();
            updateAll();
            
            // Clear form
            document.getElementById('livretType').value = '';
            document.getElementById('livretBank').value = '';
            document.getElementById('livretAmount').value = '';
            document.getElementById('livretRate').value = '';
            document.getElementById('livretCeiling').value = '';
        }
        
        function autoFillLivretRate() {
            const type = document.getElementById('livretType').value;
            const rateInput = document.getElementById('livretRate');
            const ceilingInput = document.getElementById('livretCeiling');
            
            const livretData = {
                'LEP': { rate: 4.00, ceiling: 10000 },
                'Livret A': { rate: 2.40, ceiling: 22950 },
                'LDDS': { rate: 2.40, ceiling: 12000 },
                'Livret Jeune': { rate: 2.40, ceiling: 1600 },
                'PEL': { rate: 2.25, ceiling: 61200 },
                'CEL': { rate: 2.00, ceiling: 15300 },
                'CSL': { rate: 0.50, ceiling: null }
            };
            
            if (type && livretData[type]) {
                rateInput.value = livretData[type].rate;
                if (livretData[type].ceiling) {
                    ceilingInput.value = livretData[type].ceiling;
                }
                alert(`‚úÖ Taux et plafond appliqu√©s pour ${type}`);
            } else {
                alert('‚ö†Ô∏è S√©lectionnez d\'abord un type de livret');
            }
        }
        
        function updateLivretsList() {
            const container = document.getElementById('livretsList');
            if (!container) {
                console.error('Container livretsList not found');
                return;
            }
            
            if (!portfolio.livrets || portfolio.livrets.length === 0) {
                container.innerHTML = '<p style="color: #a0aec0; text-align: center; padding: 40px;">Aucun livret enregistr√©.</p>';
                return;
            }
            
            let totalLivrets = 0;
            let totalInterestPerYear = 0;
            
            const html = portfolio.livrets.map((item, index) => {
                const amount = parseFloat(item.amount) || 0;
                const rate = parseFloat(item.rate) || 0;
                const ceiling = parseFloat(item.ceiling) || null;
                const bank = item.bank || 'N/A';
                const type = item.type || 'Autre';
                const date = item.date || 'N/A';
                
                const interestPerYear = (amount * rate) / 100;
                const remaining = ceiling ? Math.max(0, ceiling - amount) : null;
                const fillPercentage = ceiling ? (amount / ceiling) * 100 : null;
                
                totalLivrets += amount;
                totalInterestPerYear += interestPerYear;
                
                return `
                    <div class="asset-group">
                        <div class="asset-header">
                            <div class="asset-header-left">
                                <div>
                                    <div class="asset-name">${type}</div>
                                    <div class="asset-ticker">${bank} ‚Ä¢ Ouvert le ${new Date(date).toLocaleDateString('fr-FR')}</div>
                                </div>
                            </div>
                            <div class="asset-stats">
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Montant</div>
                                    <div class="asset-stat-value">‚Ç¨${amount.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Taux</div>
                                    <div class="asset-stat-value">${rate.toFixed(2)}%</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Int√©r√™ts/an</div>
                                    <div class="asset-stat-value positive">‚Ç¨${interestPerYear.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Plafond</div>
                                    <div class="asset-stat-value">${ceiling ? '‚Ç¨' + ceiling.toLocaleString('fr-FR') : 'Aucun'}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Restant</div>
                                    <div class="asset-stat-value">${remaining !== null ? '‚Ç¨' + remaining.toLocaleString('fr-FR') : '-'}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Actions</div>
                                    <div>
                                        <button onclick="editLivret(${index})" class="btn-secondary">‚úèÔ∏è</button>
                                        <button onclick="deleteLivret(${index})" class="btn-danger">üóëÔ∏è</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ${fillPercentage !== null ? `
                        <div style="padding: 10px 20px;">
                            <div style="background: rgba(0,0,0,0.3); height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #00ff88, #00cc6a); height: 100%; width: ${fillPercentage}%; transition: width 0.3s;"></div>
                            </div>
                            <p style="text-align: center; margin-top: 5px; font-size: 0.85em; color: #a0aec0;">
                                ${fillPercentage.toFixed(1)}% du plafond atteint
                            </p>
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            const summary = `
                <div class="info-message" style="margin-bottom: 20px;">
                    <strong>üìä R√©capitulatif :</strong><br>
                    Total √©pargn√© : <strong>‚Ç¨${totalLivrets.toLocaleString('fr-FR', {minimumFractionDigits: 2})}</strong><br>
                    Int√©r√™ts annuels estim√©s : <strong class="positive">‚Ç¨${totalInterestPerYear.toFixed(2)}</strong><br>
                    Int√©r√™ts mensuels estim√©s : <strong class="positive">‚Ç¨${(totalInterestPerYear / 12).toFixed(2)}</strong>
                </div>
            `;
            
            container.innerHTML = summary + html;
        }
        
        function editLivret(index) {
            const livret = portfolio.livrets[index];
            if (!livret) return;
            
            document.getElementById('livretType').value = livret.type;
            document.getElementById('livretBank').value = livret.bank;
            document.getElementById('livretAmount').value = livret.amount;
            document.getElementById('livretRate').value = livret.rate;
            document.getElementById('livretCeiling').value = livret.ceiling || '';
            document.getElementById('livretDate').value = livret.date;
            
            // Delete old entry
            portfolio.livrets.splice(index, 1);
            saveData();
            syncDriveData();
            updateLivretsList();
        }
        
        function deleteLivret(index) {
            if (confirm('Supprimer ce livret ?')) {
                portfolio.livrets.splice(index, 1);
                saveData();
                syncDriveData();
                updateLivretsList();
                updateAll();
            }
        }

        function updatePortfolio() {
            // Calculate values for each category
            let cryptoValue = 0;
            let cryptoInvested = 0;
            portfolio.crypto.forEach(c => {
                const currentPrice = portfolio.prices[c.symbol] || 0;
                cryptoValue += c.quantity * currentPrice;
                cryptoInvested += c.quantity * c.price;
            });

            // PEA calculations
            let peaValue = 0;
            let peaInvested = 0;
            const peaByTicker = {};
            portfolio.pea.forEach(p => {
                const fees = p.fees || 0;
                if (!peaByTicker[p.ticker]) {
                    peaByTicker[p.ticker] = { quantity: 0, invested: 0 };
                }
                peaByTicker[p.ticker].quantity += p.quantity;
                peaByTicker[p.ticker].invested += (p.quantity * p.price) + fees;
            });

            Object.entries(peaByTicker).forEach(([ticker, data]) => {
                const avgPrice = data.invested / data.quantity;
                const currentPrice = portfolio.prices[ticker] || avgPrice;
                peaValue += data.quantity * currentPrice;
                peaInvested += data.invested;
            });

            // Livrets
            let livretsValue = 0;
            portfolio.livrets.forEach(l => {
                const amount = parseFloat(l.amount) || 0;
                livretsValue += amount;
            });

            // Fundraising
            let fundraisingValue = 0;
            let fundraisingInvested = 0;
            portfolio.fundraising.forEach(f => {
                fundraisingValue += f.valuation;
                fundraisingInvested += f.amount;
            });

            const totalValue = cryptoValue + peaValue + livretsValue + fundraisingValue;
            const totalInvested = cryptoInvested + peaInvested + livretsValue + fundraisingInvested;
            const totalPnL = totalValue - totalInvested;
            const totalPerf = totalInvested > 0 ? (totalPnL / totalInvested) * 100 : 0;

            // Count assets
            const totalAssets = portfolio.crypto.length + Object.keys(peaByTicker).length + 
                               portfolio.livrets.length + portfolio.fundraising.length;

            // Update overview
            const overviewHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 24px;">
                    <div style="text-align: center; padding: 20px; background: rgba(255, 99, 71, 0.05); border-radius: 12px; border: 1px solid var(--border-subtle);">
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">Valeur totale</div>
                        <div style="font-size: 2.2em; font-weight: 900; color: var(--orange-primary);">
                            ‚Ç¨${totalValue.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                        </div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: rgba(255, 99, 71, 0.05); border-radius: 12px; border: 1px solid var(--border-subtle);">
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">Performance</div>
                        <div style="font-size: 2.2em; font-weight: 900;" class="${totalPerf >= 0 ? 'positive' : 'negative'}">
                            ${totalPerf >= 0 ? '+' : ''}${totalPerf.toFixed(2)}%
                        </div>
                    </div>
                </div>

                <div style="display: grid; gap: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--bg-secondary); border-radius: 12px; border-left: 4px solid var(--orange-primary);">
                        <div>
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">‚Çø Crypto</div>
                            <div style="font-weight: 700; font-size: 1.3em;">‚Ç¨${cryptoValue.toLocaleString('fr-FR', {minimumFractionDigits: 2})}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">${portfolio.crypto.length} actifs</div>
                            <div class="${(cryptoValue - cryptoInvested) >= 0 ? 'positive' : 'negative'}" style="font-weight: 700;">
                                ${cryptoInvested > 0 ? ((cryptoValue - cryptoInvested) >= 0 ? '+' : '') + ((cryptoValue - cryptoInvested) / cryptoInvested * 100).toFixed(2) + '%' : '-'}
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--bg-secondary); border-radius: 12px; border-left: 4px solid #4a9eff;">
                        <div>
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">üìä Actions (PEA)</div>
                            <div style="font-weight: 700; font-size: 1.3em;">‚Ç¨${peaValue.toLocaleString('fr-FR', {minimumFractionDigits: 2})}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">${Object.keys(peaByTicker).length} actifs</div>
                            <div class="${(peaValue - peaInvested) >= 0 ? 'positive' : 'negative'}" style="font-weight: 700;">
                                ${peaInvested > 0 ? ((peaValue - peaInvested) >= 0 ? '+' : '') + ((peaValue - peaInvested) / peaInvested * 100).toFixed(2) + '%' : '-'}
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--bg-secondary); border-radius: 12px; border-left: 4px solid var(--success);">
                        <div>
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">üí∞ Livrets</div>
                            <div style="font-weight: 700; font-size: 1.3em;">‚Ç¨${livretsValue.toLocaleString('fr-FR', {minimumFractionDigits: 2})}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">${portfolio.livrets.length} comptes</div>
                            <div style="font-weight: 700; color: var(--success);">Stable</div>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--bg-secondary); border-radius: 12px; border-left: 4px solid #9b59b6;">
                        <div>
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">üöÄ Lev√©es de fonds</div>
                            <div style="font-weight: 700; font-size: 1.3em;">‚Ç¨${fundraisingValue.toLocaleString('fr-FR', {minimumFractionDigits: 2})}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">${portfolio.fundraising.length} projets</div>
                            <div class="${(fundraisingValue - fundraisingInvested) >= 0 ? 'positive' : 'negative'}" style="font-weight: 700;">
                                ${fundraisingInvested > 0 ? ((fundraisingValue - fundraisingInvested) >= 0 ? '+' : '') + ((fundraisingValue - fundraisingInvested) / fundraisingInvested * 100).toFixed(2) + '%' : '-'}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('portfolioOverview').innerHTML = overviewHTML;

            // Update allocation chart
            updatePortfolioAllocationChart(cryptoValue, peaValue, livretsValue, fundraisingValue);

            // Apply privacy mode if enabled
            if (isPrivacyMode) {
                applyPrivacyMode();
            }
        }

        function updatePortfolioAllocationChart(cryptoValue, peaValue, livretsValue, fundraisingValue) {
            const ctx = document.getElementById('portfolioAllocationChart');
            if (!ctx) return;

            const totalValue = cryptoValue + peaValue + livretsValue + fundraisingValue;
            
            // Get current text color based on theme using the helper function
            const colors = getChartColors();

            if (window.portfolioAllocationChartInstance) {
                window.portfolioAllocationChartInstance.destroy();
            }

            window.portfolioAllocationChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Crypto', 'Actions (PEA)', 'Livrets', 'Lev√©es'],
                    datasets: [{
                        data: [cryptoValue, peaValue, livretsValue, fundraisingValue],
                        backgroundColor: [
                            'rgba(255, 99, 71, 0.8)',
                            'rgba(74, 158, 255, 0.8)',
                            'rgba(0, 212, 170, 0.8)',
                            'rgba(155, 89, 182, 0.8)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 71, 1)',
                            'rgba(74, 158, 255, 1)',
                            'rgba(0, 212, 170, 1)',
                            'rgba(155, 89, 182, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: colors.text,
                                padding: 15,
                                font: {
                                    size: 13,
                                    weight: '600',
                                    family: 'Inter'
                                },
                                boxWidth: 15,
                                boxHeight: 15,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percentage = totalValue > 0 ? ((value / totalValue) * 100).toFixed(1) : 0;
                                            return {
                                                text: `${label}: ‚Ç¨${value.toLocaleString('fr-FR', {maximumFractionDigits: 0})} (${percentage}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                strokeStyle: data.datasets[0].borderColor[i],
                                                fontColor: colors.text,
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: colors.tooltipBg,
                            titleColor: colors.text,
                            bodyColor: colors.text,
                            borderColor: colors.tooltipBorder,
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const percentage = totalValue > 0 ? ((value / totalValue) * 100).toFixed(2) : 0;
                                    return `${context.label}: ‚Ç¨${value.toLocaleString('fr-FR', {minimumFractionDigits: 2})} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateDashboard() {
            let totalValue = 0;
            let totalInvested = 0;

            // Crypto calculations
            portfolio.crypto.forEach(c => {
                const currentPrice = portfolio.prices[c.symbol] || 0;
                totalValue += c.quantity * currentPrice;
                totalInvested += c.quantity * c.price;
            });

            // PEA calculations
            const peaByTicker = {};
            portfolio.pea.forEach(p => {
                const fees = p.fees || 0;
                if (!peaByTicker[p.ticker]) {
                    peaByTicker[p.ticker] = { quantity: 0, invested: 0 };
                }
                peaByTicker[p.ticker].quantity += p.quantity;
                peaByTicker[p.ticker].invested += (p.quantity * p.price) + fees;
            });

            Object.entries(peaByTicker).forEach(([ticker, data]) => {
                const avgPrice = data.invested / data.quantity;
                const currentPrice = portfolio.prices[ticker] || avgPrice;
                totalValue += data.quantity * currentPrice;
                totalInvested += data.invested;
            });

            // Livrets calculations (both invested and value are the same)
            let totalLivrets = 0;
            portfolio.livrets.forEach(l => {
                const amount = parseFloat(l.amount) || 0;
                totalLivrets += amount;
                totalValue += amount;
                totalInvested += amount;
            });

            // Fundraising calculations
            portfolio.fundraising.forEach(f => {
                totalValue += f.valuation;
                totalInvested += f.amount;
            });

            const totalPnL = totalValue - totalInvested;
            const totalPerf = totalInvested > 0 ? (totalPnL / totalInvested) * 100 : 0;

            const html = `
                <div class="stat-card">
                    <div class="stat-label">üí∞ Valeur Totale</div>
                    <div class="stat-value">‚Ç¨${totalValue.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìä Total Investi</div>
                    <div class="stat-value">‚Ç¨${totalInvested.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìà P&L Global</div>
                    <div class="stat-value ${totalPnL >= 0 ? 'positive' : 'negative'}">
                        ${totalPnL >= 0 ? '+' : ''}‚Ç¨${totalPnL.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìä P&L %</div>
                    <div class="stat-value ${totalPerf >= 0 ? 'positive' : 'negative'}">
                        ${totalPerf >= 0 ? '+' : ''}${totalPerf.toFixed(2)}%
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">‚Çø Crypto</div>
                    <div class="stat-value">‚Ç¨${portfolio.crypto.reduce((sum, c) => sum + (c.quantity * (portfolio.prices[c.symbol] || 0)), 0).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìä PEA</div>
                    <div class="stat-value">‚Ç¨${Object.entries(peaByTicker).reduce((sum, [ticker, data]) => {
                        const avgPrice = data.invested / data.quantity;
                        const currentPrice = portfolio.prices[ticker] || avgPrice;
                        return sum + (data.quantity * currentPrice);
                    }, 0).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üí∞ Livrets</div>
                    <div class="stat-value">‚Ç¨${totalLivrets.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üöÄ Lev√©es</div>
                    <div class="stat-value">‚Ç¨${portfolio.fundraising.reduce((sum, f) => sum + f.valuation, 0).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                </div>
            `;

            document.getElementById('dashboardStats').innerHTML = html;
            updateChart(peaByTicker);
            
            // Appliquer le mode privacy si activ√©
            if (isPrivacyMode) {
                applyPrivacyMode();
            }
        }

        function updateChart(peaByTicker) {
            const ctx = document.getElementById('portfolioChart');
            if (!ctx) return;
            
            let cryptoValue = 0;
            let peaValue = 0;
            let livretsValue = 0;
            let fundraisingValue = 0;

            portfolio.crypto.forEach(c => {
                const currentPrice = portfolio.prices[c.symbol] || 0;
                cryptoValue += c.quantity * currentPrice;
            });

            Object.entries(peaByTicker).forEach(([ticker, data]) => {
                const avgPrice = data.invested / data.quantity;
                const currentPrice = portfolio.prices[ticker] || avgPrice;
                peaValue += data.quantity * currentPrice;
            });

            portfolio.livrets.forEach(l => {
                livretsValue += parseFloat(l.amount) || 0;
            });

            portfolio.fundraising.forEach(f => {
                fundraisingValue += f.valuation;
            });

            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Crypto', 'PEA', 'Livrets', 'Lev√©es'],
                    datasets: [{
                        data: [cryptoValue, peaValue, livretsValue, fundraisingValue],
                        backgroundColor: [
                            'rgba(0, 255, 136, 0.8)',      // Crypto - Vert
                            'rgba(52, 152, 219, 0.8)',     // PEA - Bleu
                            'rgba(255, 193, 7, 0.8)',      // Livrets - Jaune/Or
                            'rgba(156, 39, 176, 0.8)'      // Lev√©es - Violet (CHANG√â)
                        ],
                        borderColor: [
                            'rgba(0, 255, 136, 1)',
                            'rgba(52, 152, 219, 1)',
                            'rgba(255, 193, 7, 1)',
                            'rgba(156, 39, 176, 1)'        // Lev√©es - Violet (CHANG√â)
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff', font: { size: 14 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += '‚Ç¨' + context.parsed.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            
            // Appliquer le mode privacy si activ√©
            if (typeof applyPrivacyToCharts === 'function') {
                applyPrivacyToCharts();
            }
        }

        // ========================================
        // NEWS AND MARKET INDICATORS
        // ========================================
        
        async function loadCryptoFearGreed() {
            try {
                const response = await fetch('https://api.alternative.me/fng/?limit=1');
                const data = await response.json();
                
                if (data.data && data.data[0]) {
                    const fng = data.data[0];
                    const value = parseInt(fng.value);
                    const classification = fng.value_classification;
                    
                    let color = '#a0aec0';
                    if (value <= 25) color = '#ff4757'; // Extreme Fear
                    else if (value <= 45) color = '#ff6b6b'; // Fear
                    else if (value <= 55) color = '#ffc107'; // Neutral
                    else if (value <= 75) color = '#4ecdc4'; // Greed
                    else color = '#00ff88'; // Extreme Greed
                    
                    document.getElementById('cryptoFearGreed').innerHTML = `
                        <div class="fear-greed-gauge">
                            <div class="gauge-value" style="color: ${color};">${value}</div>
                            <div class="gauge-label" style="color: ${color};">${classification}</div>
                        </div>
                        <div style="margin-top: 15px; font-size: 0.9em; color: #d0d0d0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>0</span>
                                <span>Extreme Fear</span>
                                <span>Fear</span>
                                <span>Neutral</span>
                                <span>Greed</span>
                                <span>Extreme Greed</span>
                                <span>100</span>
                            </div>
                            <div style="height: 10px; background: linear-gradient(90deg, #ff4757, #ff6b6b, #ffc107, #4ecdc4, #00ff88); border-radius: 5px; position: relative;">
                                <div style="position: absolute; left: ${value}%; top: -5px; width: 3px; height: 20px; background: white;"></div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading Crypto F&G:', error);
                document.getElementById('cryptoFearGreed').innerHTML = '<div style="color: #ff4757;">Erreur de chargement</div>';
            }
        }
        
        async function loadStockFearGreed() {
            // Estimation bas√©e sur le VIX (volatilit√©)
            // Dans une vraie app, vous utiliseriez une API payante comme CNN Fear & Greed
            try {
                // Simulation d'une valeur bas√©e sur la date (pour d√©mo)
                const today = new Date();
                const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 86400000);
                const simValue = 50 + (Math.sin(dayOfYear / 30) * 30); // Oscillation entre 20 et 80
                
                const value = Math.round(simValue);
                let label = 'Neutral';
                let color = '#ffc107';
                
                if (value <= 25) { label = 'Extreme Fear'; color = '#ff4757'; }
                else if (value <= 45) { label = 'Fear'; color = '#ff6b6b'; }
                else if (value <= 55) { label = 'Neutral'; color = '#ffc107'; }
                else if (value <= 75) { label = 'Greed'; color = '#4ecdc4'; }
                else { label = 'Extreme Greed'; color = '#00ff88'; }
                
                document.getElementById('stockFGValue').textContent = value;
                document.getElementById('stockFGValue').style.color = color;
                document.getElementById('stockFGLabel').textContent = label;
                document.getElementById('stockFGLabel').style.color = color;
                
                // Add gradient bar
                const container = document.getElementById('stockFearGreed');
                const existingBar = container.querySelector('.fear-greed-gradient');
                if (!existingBar) {
                    container.innerHTML += `
                        <div class="fear-greed-gradient" style="margin-top: 15px;">
                            <div style="height: 10px; background: linear-gradient(90deg, #ff4757, #ff6b6b, #ffc107, #4ecdc4, #00ff88); border-radius: 5px; position: relative;">
                                <div style="position: absolute; left: ${value}%; top: -5px; width: 3px; height: 20px; background: white;"></div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading Stock F&G:', error);
            }
        }
        
        async function refreshNews() {
            const summaryEl = document.getElementById('aiSummary');
            const feedEl = document.getElementById('newsFeed');
            
            summaryEl.innerHTML = '<div class="loading">‚è≥ Chargement de la synth√®se quotidienne...</div>';
            feedEl.innerHTML = '<div class="loading">Chargement...</div>';
            
            try {
                // Charger les donn√©es depuis le fichier JSON g√©n√©r√© par GitHub Actions
                // Le fichier sera mis √† jour automatiquement chaque jour par le workflow
                const response = await fetch('./data/market-summary.json?t=' + Date.now());
                
                if (!response.ok) {
                    throw new Error('Fichier de donn√©es non disponible');
                }
                
                const data = await response.json();
                
                // Afficher la synth√®se IA
                const today = new Date().toLocaleDateString('fr-FR', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                summaryEl.innerHTML = `
                    <div style="background: rgba(255, 99, 71, 0.05); padding: 12px; border-radius: 12px; margin-bottom: 16px; border-left: 4px solid var(--orange-primary);">
                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">
                            üìÖ Synth√®se du ${data.date || today}
                        </div>
                        <div style="font-size: 0.9em; color: var(--text-secondary);">
                            Derni√®re mise √† jour : ${data.updated || 'N/A'}
                        </div>
                    </div>
                    
                    <div class="ai-summary-text">
                        ${data.summary || '<p>Aucune synth√®se disponible</p>'}
                    </div>
                    
                    <div style="margin-top: 16px; padding: 12px; background: rgba(255, 255, 255, 0.02); border-radius: 8px; font-size: 0.9em; color: var(--text-secondary);">
                        ü§ñ <em>Synth√®se g√©n√©r√©e automatiquement chaque jour par GitHub Actions</em>
                    </div>
                `;
                
                // Afficher les actualit√©s
                if (data.news && data.news.length > 0) {
                    feedEl.innerHTML = data.news.map(news => `
                        <div class="news-item" onclick="window.open('${news.url}', '_blank')">
                            <div class="news-title">${news.title}</div>
                            <div class="news-source">üì∞ ${news.source}</div>
                            <div class="news-snippet">${news.snippet || news.description || ''}</div>
                        </div>
                    `).join('');
                } else {
                    feedEl.innerHTML = '<div style="text-align: center; color: var(--text-secondary);">Aucune actualit√© disponible</div>';
                }
                
            } catch (error) {
                console.error('Error loading news:', error);
                
                // Fallback : afficher une synth√®se statique si le fichier n'existe pas encore
                summaryEl.innerHTML = `
                    <div style="background: rgba(255, 200, 71, 0.1); padding: 12px; border-radius: 12px; margin-bottom: 16px; border-left: 4px solid #ffc107;">
                        <div style="font-size: 0.9em; color: #ffc107;">
                            ‚ö†Ô∏è Synth√®se en attente de la premi√®re g√©n√©ration automatique
                        </div>
                    </div>
                    <div class="ai-summary-text">
                        <p style="margin-bottom: 12px;">
                            <strong>üìä Configuration requise :</strong> Pour activer la synth√®se IA quotidienne des march√©s, 
                            vous devez configurer GitHub Actions avec le workflow fourni.
                        </p>
                        <p style="margin-bottom: 12px;">
                            <strong>üîß √âtapes :</strong>
                            <br>1. Ajoutez le fichier <code>.github/workflows/daily-news.yml</code> dans votre repository
                            <br>2. Configurez les secrets GitHub (API keys)
                            <br>3. Le workflow se lancera automatiquement chaque jour √† 8h
                        </p>
                        <p>
                            <strong>üí° En attendant :</strong> Les indices Fear & Greed et votre analyse de portfolio 
                            fonctionnent normalement.
                        </p>
                    </div>
                `;
                
                feedEl.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                        En attente de la premi√®re synchronisation automatique...
                    </div>
                `;
            }
        }
        
        async function updateAll() {
            await updatePrices();
            updateCryptoList();
            updatePEAList();
            updatePEAQuickSelect(); // Update quick select buttons
            updateLivretsList(); // Update livrets
            updateFundraisingList();
            updateDashboard();
            updatePortfolio(); // Update portfolio overview
            
            // Load market indicators and news
            loadCryptoFearGreed();
            loadStockFearGreed();
            refreshNews();
            
            document.getElementById('syncStatus').textContent = '‚úÖ Synchronis√©';
            document.getElementById('syncStatus').classList.add('synced');
        }

        async function exportToGoogleSheets() {
            const sheetId = document.getElementById('googleSheetId').value.trim();
            if (!sheetId) {
                alert('Veuillez entrer l\'ID de votre Google Sheet');
                return;
            }

            localStorage.setItem('googleSheetId', sheetId);
            alert('‚ö†Ô∏è Cette fonction n√©cessite une authentification Google Sheets API. Utilisez plut√¥t la synchronisation depuis Google Sheets vers l\'application.');
        }

        function saveGoogleSheetId() {
            const id = document.getElementById('googleSheetId').value.trim();
            if (id) {
                localStorage.setItem('googleSheetId', id);
                alert('‚úÖ Google Sheet ID enregistr√©');
            }
        }

        async function syncPricesFromGoogleSheets() {
            const sheetId = localStorage.getItem('googleSheetId');
            if (!sheetId) {
                alert('‚ö†Ô∏è Veuillez d\'abord enregistrer l\'ID de votre Google Sheet');
                showSection('settings');
                return;
            }

            try {
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=0`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: V√©rifiez que la feuille est publique`);
                }
                
                const csvText = await response.text();
                const lines = csvText.split('\n');
                
                let count = 0;
                ensurePortfolioStructure();
                
                // Skip header line
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // Parse CSV handling quotes and decimal commas
                    const parts = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            parts.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    parts.push(current.trim());
                    
                    const ticker = parts[0]?.replace(/"/g, '');
                    const priceStr = parts[1]?.replace(/"/g, '');
                    
                    if (ticker && priceStr) {
                        // Handle both point and comma as decimal separator
                        const price = parseFloat(priceStr.replace(',', '.'));
                        if (!isNaN(price) && price > 0) {
                            portfolio.prices[ticker.toUpperCase()] = price;
                            portfolio.priceTimestamps[ticker.toUpperCase()] = Date.now();
                            count++;
                            console.log(`‚úÖ ${ticker}: ${price}‚Ç¨`);
                        }
                    }
                }
                
                if (count > 0) {
                    saveData();
                    updateAll();
                    alert(`‚úÖ ${count} prix synchronis√©s depuis Google Sheets !`);
                } else {
                    alert('‚ö†Ô∏è Aucun prix trouv√©. V√©rifiez le format de votre feuille.');
                }
                
            } catch (error) {
                console.error('Erreur:', error);
                alert(`‚ùå Erreur: ${error.message}\n\nV√©rifiez que :\n1. La feuille est publi√©e sur le Web\n2. L'ID est correct\n3. Le format est : ticker,prix`);
            }
        }

        function toggleAutoSync(isEnabled) {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
                autoSyncInterval = null;
            }
            
            if (isEnabled) {
                syncPricesFromGoogleSheets(); // Immediate sync
                autoSyncInterval = setInterval(() => {
                    console.log('üîÑ Auto-sync Google Sheets...');
                    syncPricesFromGoogleSheets();
                }, 5 * 60 * 1000); // Every 5 minutes
                localStorage.setItem('autoSyncEnabled', 'true');
                console.log('‚úÖ Auto-sync activ√© (5 min)');
            } else {
                localStorage.setItem('autoSyncEnabled', 'false');
                console.log('‚ùå Auto-sync d√©sactiv√©');
            }
        }

        // Google Drive Functions
        function saveClientId() {
            const id = document.getElementById('clientId').value.trim();
            if (id) {
                localStorage.setItem('googleClientId', id);
                alert('‚úÖ Client ID enregistr√©');
                initGoogleDrive();
            }
        }

        function initGoogleDrive() {
            const id = localStorage.getItem('googleClientId');
            if (!id) return;
            try {
                if (typeof google === 'undefined' || !google.accounts) {
                    setTimeout(initGoogleDrive, 1000);
                    return;
                }
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: id,
                    scope: 'https://www.googleapis.com/auth/drive.file',
                    callback: (r) => {
                        if (r.error) {
                            alert('‚ùå ' + r.error);
                            return;
                        }
                        accessToken = r.access_token;
                        isGoogleDriveConnected = true;
                        document.getElementById('syncStatus').textContent = '‚úì Synchronis√©';
                        document.getElementById('syncStatus').classList.add('synced');
                        updateDriveConnectionButton(true);
                        loadFromDrive();
                    }
                });
            } catch (e) {
                console.error(e);
            }
        }

        function connectGoogleDrive() {
            if (!localStorage.getItem('googleClientId')) {
                alert('‚ö†Ô∏è Entrez le Client ID');
                showSection('settings');
                return;
            }
            if (!tokenClient) {
                initGoogleDrive();
                setTimeout(() => { if (tokenClient) tokenClient.requestAccessToken(); }, 1000);
            } else {
                tokenClient.requestAccessToken();
            }
        }

        function disconnectGoogleDrive() {
            if (accessToken) google.accounts.oauth2.revoke(accessToken);
            accessToken = null;
            isGoogleDriveConnected = false;
            localStorage.removeItem('portfolioFileId');
            document.getElementById('syncStatus').textContent = '‚è≥ Non synchronis√©';
            document.getElementById('syncStatus').classList.remove('synced');
            
            // Clear all portfolio data
            portfolio = {
                crypto: [],
                pea: [],
                livrets: [],
                fundraising: [],
                goals: []
            };
            
            // Update all displays to show empty state
            updateAll();
            updateGoalsList(); // Update goals list to show empty state
            
            // Update connection button state
            updateDriveConnectionButton(false);
        }

        async function syncDriveData() {
            if (!isGoogleDriveConnected || !accessToken) {
                console.log('‚ö†Ô∏è Google Drive non connect√©, sauvegarde ignor√©e');
                return;
            }
            
            // Show saving indicator
            const statusEl = document.getElementById('syncStatus');
            const originalText = statusEl.textContent;
            statusEl.textContent = 'üíæ Sauvegarde...';
            statusEl.classList.remove('synced');
            
            try {
                const fid = localStorage.getItem('portfolioFileId');
                const data = JSON.stringify(portfolio, null, 2);
                if (fid) {
                    const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fid}?uploadType=media`, {
                        method: 'PATCH',
                        headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                        body: data
                    });
                    if (response.ok) {
                        console.log('‚úÖ Sauvegard√© sur Google Drive');
                        showSaveConfirmation();
                    } else {
                        throw new Error('Erreur HTTP: ' + response.status);
                    }
                } else {
                    const meta = { name: 'portfolio.json', mimeType: 'application/json' };
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(meta)], { type: 'application/json' }));
                    form.append('file', new Blob([data], { type: 'application/json' }));
                    const r = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${accessToken}` },
                        body: form
                    });
                    if (r.ok) {
                        const res = await r.json();
                        localStorage.setItem('portfolioFileId', res.id);
                        console.log('‚úÖ Fichier cr√©√© sur Google Drive:', res.id);
                        showSaveConfirmation();
                    } else {
                        throw new Error('Erreur cr√©ation: ' + r.status);
                    }
                }
                
                // Restore status
                statusEl.textContent = '‚úÖ Synchronis√©';
                statusEl.classList.add('synced');
                
            } catch (e) {
                console.error('‚ùå Erreur sauvegarde Drive:', e);
                statusEl.textContent = '‚ùå Erreur Drive';
                alert('‚ùå Erreur lors de la sauvegarde sur Google Drive:\n' + e.message);
            }
        }
        
        function showSaveConfirmation() {
            const statusEl = document.getElementById('syncStatus');
            statusEl.textContent = '‚úÖ Sauvegard√© sur Drive';
            statusEl.classList.add('synced');
            
            // Reset after 3 seconds
            setTimeout(() => {
                statusEl.textContent = '‚úÖ Synchronis√©';
            }, 3000);
        }

        async function loadFromDrive() {
            if (!isGoogleDriveConnected || !accessToken) {
                alert('‚ö†Ô∏è Veuillez d\'abord vous connecter √† Google Drive');
                return;
            }
            try {
                let fid = localStorage.getItem('portfolioFileId');
                if (!fid) {
                    const r = await fetch('https://www.googleapis.com/drive/v3/files?q=name%3D%27portfolio.json%27', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    const d = await r.json();
                    if (d.files && d.files.length > 0) {
                        fid = d.files[0].id;
                        localStorage.setItem('portfolioFileId', fid);
                    } else {
                        alert('‚ö†Ô∏è Aucun fichier portfolio.json trouv√© sur Google Drive');
                        return;
                    }
                }
                const r = await fetch(`https://www.googleapis.com/drive/v3/files/${fid}?alt=media`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (r.ok) {
                    const importedData = await r.json();
                    portfolio = {
                        crypto: importedData.crypto || [],
                        pea: importedData.pea || [],
                        livrets: importedData.livrets || [],
                        fundraising: importedData.fundraising || [],
                        prices: importedData.prices || {},
                        priceTimestamps: importedData.priceTimestamps || {},
                        binanceCredentials: importedData.binanceCredentials || null,
                        goals: importedData.goals || []
                    };
                    
                    portfolio.pea = portfolio.pea.map(p => ({
                        name: p.name || '',
                        ticker: p.ticker || '',
                        quantity: p.quantity || 0,
                        price: p.price || 0,
                        fees: p.fees || 0,
                        date: p.date || new Date().toISOString().split('T')[0]
                    }));
                    
                    ensurePortfolioStructure();
                    saveData();
                    updateAll();
                    updateBinanceStatus();
                    alert(`‚úÖ Donn√©es charg√©es depuis Google Drive!

üìä PEA: ${portfolio.pea.length} ligne${portfolio.pea.length > 1 ? 's' : ''}
‚Çø Crypto: ${portfolio.crypto.length} ligne${portfolio.crypto.length > 1 ? 's' : ''}
üí∞ Livrets: ${portfolio.livrets.length} livret${portfolio.livrets.length > 1 ? 's' : ''}
üöÄ Lev√©es: ${portfolio.fundraising.length} investissement${portfolio.fundraising.length > 1 ? 's' : ''}
üéØ Objectifs: ${portfolio.goals.length} objectif${portfolio.goals.length > 1 ? 's' : ''}`);
                } else {
                    alert('‚ùå Erreur lors du chargement: ' + r.status);
                }
            } catch (e) {
                console.error('Erreur Drive:', e);
                alert('‚ùå Erreur: ' + e.message);
            }
        }

        function saveData() {
            localStorage.setItem('portfolioData', JSON.stringify(portfolio));
        }

        function loadData() {
            const saved = localStorage.getItem('portfolioData');
            if (saved) {
                try {
                    portfolio = JSON.parse(saved);
                    ensurePortfolioStructure();
                } catch (e) {
                    console.error('Erreur chargement:', e);
                    portfolio = { crypto: [], pea: [], fundraising: [], prices: {}, priceTimestamps: {}, binanceCredentials: null };
                }
            }
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(portfolio, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `portfolio_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function importData(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const importedData = JSON.parse(ev.target.result);
                        portfolio = {
                            crypto: importedData.crypto || [],
                            pea: importedData.pea || [],
                            fundraising: importedData.fundraising || [],
                            prices: importedData.prices || {},
                            priceTimestamps: importedData.priceTimestamps || {},
                            binanceCredentials: importedData.binanceCredentials || null
                        };
                        
                        portfolio.pea = portfolio.pea.map(p => ({
                            name: p.name || '',
                            ticker: p.ticker || '',
                            quantity: p.quantity || 0,
                            price: p.price || 0,
                            fees: p.fees || 0,
                            date: p.date || new Date().toISOString().split('T')[0]
                        }));
                        
                        ensurePortfolioStructure();
                        saveData();
                        syncDriveData();
                        updateAll();
                        updateBinanceStatus();
                        alert(`‚úÖ Import√© avec succ√®s!\n\nPEA: ${portfolio.pea.length} lignes\nCrypto: ${portfolio.crypto.length} lignes\nLev√©es: ${portfolio.fundraising.length} lignes`);
                    } catch (err) {
                        console.error('Erreur import:', err);
                        alert(`‚ùå Erreur lors de l'import:\n${err.message}\n\nV√©rifiez que le fichier est un JSON valide.`);
                    }
                };
                reader.readAsText(file);
            }
        }

        // Init
        ensurePortfolioStructure();
        loadData();
        initCryptoLibrary();
        updateBinanceStatus();
        updateAll();
        initGoogleDrive();
        document.getElementById('cryptoDate').valueAsDate = new Date();
        document.getElementById('peaDate').valueAsDate = new Date();
        document.getElementById('livretDate').valueAsDate = new Date();
        document.getElementById('fundDate').valueAsDate = new Date();
        
        const savedSheetId = localStorage.getItem('googleSheetId');
        if (savedSheetId) {
            document.getElementById('googleSheetId').value = savedSheetId;
        }
        
        // Restore Client ID
        const savedClientId = localStorage.getItem('googleClientId');
        if (savedClientId) {
            document.getElementById('clientId').value = savedClientId;
        }
        
        const autoSyncEnabled = localStorage.getItem('autoSyncEnabled') === 'true';
        document.getElementById('autoSyncCheckbox').checked = autoSyncEnabled;
        if (autoSyncEnabled) {
            toggleAutoSync(true);
        }
        // NEW FINARY FEATURES
        // ========================================
        // NEW FINARY FEATURES - JAVASCRIPT
        // ========================================
        
        let evolutionChart = null;
        let assetClassChart = null;
        let currentTimeRange = '1M';
        
        // Evolution Chart (Line)
        function updateEvolutionChart() {
            const ctx = document.getElementById('evolutionChart');
            if (!ctx) return;
            
            // Generate sample data based on current portfolio value
            const labels = [];
            const data = [];
            const today = new Date();
            const daysToShow = currentTimeRange === '1M' ? 30 : 
                             currentTimeRange === '3M' ? 90 :
                             currentTimeRange === '6M' ? 180 :
                             currentTimeRange === '1Y' ? 365 :
                             currentTimeRange === 'YTD' ? dayOfYear(today) : 365;
            
            let totalValue = 0;
            portfolio.crypto.forEach(c => {
                totalValue += c.quantity * (portfolio.prices[c.symbol] || c.price);
            });
            portfolio.pea.forEach(p => {
                totalValue += p.quantity * (portfolio.prices[p.ticker] || p.price);
            });
            portfolio.livrets.forEach(l => {
                totalValue += parseFloat(l.amount) || 0;
            });
            portfolio.fundraising.forEach(f => {
                totalValue += parseFloat(f.valuation) || 0;
            });
            
            // Generate historical data (simulated growth)
            for (let i = daysToShow; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('fr-FR', { month: 'short', day: 'numeric' }));
                
                // Simulate growth with some randomness
                const growthFactor = 1 - (i / daysToShow) * 0.15;
                const randomVariation = (Math.random() - 0.5) * 0.02;
                data.push(totalValue * (growthFactor + randomVariation));
            }
            
            if (evolutionChart) evolutionChart.destroy();
            
            evolutionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Patrimoine',
                        data: data,
                        borderColor: '#ff6347',
                        backgroundColor: 'rgba(255, 99, 71, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return '‚Ç¨' + context.parsed.y.toLocaleString('fr-FR', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    });
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                color: '#8892a6',
                                callback: function(value) {
                                    // Afficher avec 1 d√©cimale pour plus de pr√©cision
                                    return '‚Ç¨' + (value / 1000).toFixed(1) + 'K';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.06)'
                            },
                            // Forcer une marge de 10% en haut et en bas
                            afterDataLimits: function(axis) {
                                const range = axis.max - axis.min;
                                axis.max = axis.max + (range * 0.10);
                                axis.min = axis.min - (range * 0.10);
                            }
                        },
                        x: {
                            ticks: {
                                color: '#8892a6',
                                maxTicksLimit: 10
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
            
            // Appliquer le mode privacy si activ√©
            if (typeof applyPrivacyToCharts === 'function') {
                applyPrivacyToCharts();
            }
        }
        
        function setTimeRange(range) {
            currentTimeRange = range;
            document.querySelectorAll('.time-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            updateEvolutionChart();
        }
        
        function dayOfYear(date) {
            const start = new Date(date.getFullYear(), 0, 0);
            const diff = date - start;
            const oneDay = 1000 * 60 * 60 * 24;
            return Math.floor(diff / oneDay);
        }
        
        // Performance Analysis
        function updatePerformanceView() {
            const performances = [];
            
            // Crypto
            portfolio.crypto.forEach(c => {
                const currentPrice = portfolio.prices[c.symbol] || c.price;
                const currentValue = c.quantity * currentPrice;
                const investedValue = c.quantity * c.price;
                const pnl = currentValue - investedValue;
                const perf = investedValue > 0 ? (pnl / investedValue) * 100 : 0;
                
                performances.push({
                    name: c.symbol,
                    category: 'Crypto',
                    currentValue: currentValue,
                    invested: investedValue,
                    pnl: pnl,
                    performance: perf
                });
            });
            
            // PEA
            const peaByTicker = {};
            portfolio.pea.forEach(p => {
                if (!peaByTicker[p.ticker]) {
                    peaByTicker[p.ticker] = {
                        name: p.name,
                        quantity: 0,
                        invested: 0
                    };
                }
                peaByTicker[p.ticker].quantity += p.quantity;
                peaByTicker[p.ticker].invested += (p.quantity * p.price) + (p.fees || 0);
            });
            
            Object.entries(peaByTicker).forEach(([ticker, data]) => {
                const currentPrice = portfolio.prices[ticker] || (data.invested / data.quantity);
                const currentValue = data.quantity * currentPrice;
                const pnl = currentValue - data.invested;
                const perf = data.invested > 0 ? (pnl / data.invested) * 100 : 0;
                
                performances.push({
                    name: data.name || ticker,
                    category: 'PEA',
                    currentValue: currentValue,
                    invested: data.invested,
                    pnl: pnl,
                    performance: perf
                });
            });
            
            // Sort by performance
            performances.sort((a, b) => b.performance - a.performance);
            
            // Top 5 performers
            const topHTML = performances.slice(0, 5).map(p => `
                <div style="padding: 12px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 700;">${p.name}</div>
                        <div style="font-size: 0.85em; color: var(--text-secondary);">${p.category}</div>
                    </div>
                    <div style="text-align: right;">
                        <div class="positive" style="font-weight: 800;">+${p.performance.toFixed(2)}%</div>
                        <div style="font-size: 0.85em; color: var(--text-secondary);">+‚Ç¨${p.pnl.toLocaleString('fr-FR', {minimumFractionDigits: 2})}</div>
                    </div>
                </div>
            `).join('');
            
            // Bottom 5 performers
            const worstHTML = performances.slice(-5).reverse().map(p => `
                <div style="padding: 12px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 700;">${p.name}</div>
                        <div style="font-size: 0.85em; color: var(--text-secondary);">${p.category}</div>
                    </div>
                    <div style="text-align: right;">
                        <div class="${p.performance >= 0 ? 'positive' : 'negative'}" style="font-weight: 800;">${p.performance >= 0 ? '+' : ''}${p.performance.toFixed(2)}%</div>
                        <div style="font-size: 0.85em; color: var(--text-secondary);">${p.pnl >= 0 ? '+' : ''}‚Ç¨${Math.abs(p.pnl).toLocaleString('fr-FR', {minimumFractionDigits: 2})}</div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('topPerformers').innerHTML = topHTML || '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucune donn√©e</div>';
            document.getElementById('worstPerformers').innerHTML = worstHTML || '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucune donn√©e</div>';
            
            // Performance table
            const tableHTML = performances.map(p => `
                <tr>
                    <td>
                        <div style="font-weight: 700;">${p.name}</div>
                        <div style="font-size: 0.85em; color: var(--text-secondary);">${p.category}</div>
                    </td>
                    <td style="font-weight: 600;">‚Ç¨${p.currentValue.toLocaleString('fr-FR', {minimumFractionDigits: 2})}</td>
                    <td>‚Ç¨${p.invested.toLocaleString('fr-FR', {minimumFractionDigits: 2})}</td>
                    <td class="${p.pnl >= 0 ? 'positive' : 'negative'}" style="font-weight: 700;">${p.pnl >= 0 ? '+' : ''}‚Ç¨${p.pnl.toLocaleString('fr-FR', {minimumFractionDigits: 2})}</td>
                    <td class="${p.performance >= 0 ? 'positive' : 'negative'}" style="font-weight: 800; font-size: 1.1em;">${p.performance >= 0 ? '+' : ''}${p.performance.toFixed(2)}%</td>
                </tr>
            `).join('');
            
            document.getElementById('performanceTableBody').innerHTML = tableHTML || '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">Aucune donn√©e</td></tr>';
        }
        
        // Diversification Analysis
        function updateDiversificationAnalysis() {
            let cryptoValue = 0;
            let peaValue = 0;
            let livretsValue = 0;
            let fundraisingValue = 0;
            
            portfolio.crypto.forEach(c => {
                cryptoValue += c.quantity * (portfolio.prices[c.symbol] || c.price);
            });
            
            portfolio.pea.forEach(p => {
                peaValue += p.quantity * (portfolio.prices[p.ticker] || p.price);
            });
            
            portfolio.livrets.forEach(l => {
                livretsValue += parseFloat(l.amount) || 0;
            });
            
            portfolio.fundraising.forEach(f => {
                fundraisingValue += parseFloat(f.valuation) || 0;
            });
            
            const total = cryptoValue + peaValue + livretsValue + fundraisingValue;
            
            // Get theme colors
            const colors = getChartColors();
            
            // Asset Class Chart
            const ctx = document.getElementById('assetClassChart');
            if (ctx) {
                if (assetClassChart) assetClassChart.destroy();
                
                assetClassChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Crypto', 'Actions (PEA)', 'Livrets', 'Lev√©es de fonds'],
                        datasets: [{
                            data: [cryptoValue, peaValue, livretsValue, fundraisingValue],
                            backgroundColor: ['#ff6347', '#ff7f66', '#ffa552', '#ffb366'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: colors.text, padding: 15, font: { size: 12 } }
                            },
                            tooltip: {
                                backgroundColor: colors.tooltipBg,
                                titleColor: colors.text,
                                bodyColor: colors.text,
                                borderColor: colors.tooltipBorder,
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed;
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return context.label + ': ‚Ç¨' + value.toLocaleString('fr-FR') + ' (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Diversification Score (based on distribution)
            const distributions = [cryptoValue, peaValue, livretsValue, fundraisingValue].filter(v => v > 0);
            const numCategories = distributions.length;
            
            // Calculate Herfindahl index (concentration measure)
            let herfindahl = 0;
            distributions.forEach(value => {
                const share = value / total;
                herfindahl += share * share;
            });
            
            // Convert to diversification score (0-100, where 100 is perfectly diversified)
            // Perfect diversification (4 equal parts) = HHI of 0.25
            // Complete concentration (1 category) = HHI of 1.0
            const score = Math.max(0, Math.min(100, ((1 - herfindahl) / 0.75) * 100));
            
            let scoreColor = '#ff4757';
            let scoreLabel = 'FAIBLE';
            if (score >= 70) {
                scoreColor = '#00d4aa';
                scoreLabel = 'EXCELLENTE';
            } else if (score >= 50) {
                scoreColor = '#ffc107';
                scoreLabel = 'BONNE';
            } else if (score >= 30) {
                scoreColor = '#ff7f66';
                scoreLabel = 'MOYENNE';
            }
            
            document.getElementById('divScore').textContent = Math.round(score);
            document.getElementById('divScore').style.color = scoreColor;
            document.querySelector('#diversificationScore .gauge-label').textContent = scoreLabel;
            document.querySelector('#diversificationScore .gauge-label').style.color = scoreColor;
            
            // Appliquer le mode privacy si activ√©
            if (typeof applyPrivacyToCharts === 'function') {
                applyPrivacyToCharts();
            }
        }
        
        // Transaction History
        function buildTransactionHistory() {
            const transactions = [];
            
            // Crypto transactions
            portfolio.crypto.forEach(c => {
                transactions.push({
                    date: c.date,
                    type: 'Achat',
                    category: 'crypto',
                    asset: c.symbol,
                    quantity: c.quantity,
                    price: c.price,
                    amount: c.quantity * c.price
                });
            });
            
            // PEA transactions
            portfolio.pea.forEach(p => {
                transactions.push({
                    date: p.date,
                    type: 'Achat',
                    category: 'pea',
                    asset: p.name || p.ticker,
                    quantity: p.quantity,
                    price: p.price,
                    amount: p.quantity * p.price + (p.fees || 0)
                });
            });
            
            // Livrets transactions
            portfolio.livrets.forEach(l => {
                transactions.push({
                    date: l.date,
                    type: 'D√©p√¥t',
                    category: 'livrets',
                    asset: l.type,
                    quantity: 1,
                    price: parseFloat(l.amount),
                    amount: parseFloat(l.amount)
                });
            });
            
            // Fundraising transactions
            portfolio.fundraising.forEach(f => {
                transactions.push({
                    date: f.date,
                    type: 'Investissement',
                    category: 'fundraising',
                    asset: f.name,
                    quantity: 1,
                    price: parseFloat(f.amount),
                    amount: parseFloat(f.amount)
                });
            });
            
            // Sort by date (newest first)
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            return transactions;
        }
        
        function updateTransactionHistory() {
            const transactions = buildTransactionHistory();
            const html = transactions.map(t => `
                <tr>
                    <td>${new Date(t.date).toLocaleDateString('fr-FR')}</td>
                    <td><span style="padding: 4px 12px; background: rgba(255, 99, 71, 0.1); border-radius: 12px; font-size: 0.85em; font-weight: 600;">${t.type}</span></td>
                    <td style="text-transform: capitalize;">${t.category}</td>
                    <td style="font-weight: 700;">${t.asset}</td>
                    <td>${t.quantity.toLocaleString('fr-FR', {maximumFractionDigits: 8})}</td>
                    <td>‚Ç¨${t.price.toLocaleString('fr-FR', {minimumFractionDigits: 2})}</td>
                    <td style="font-weight: 700;">‚Ç¨${t.amount.toLocaleString('fr-FR', {minimumFractionDigits: 2})}</td>
                </tr>
            `).join('');
            
            document.getElementById('transactionHistory').innerHTML = html || '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">Aucune transaction</td></tr>';
        }
        
        function filterTransactions() {
            const typeFilter = document.getElementById('transactionTypeFilter').value;
            const categoryFilter = document.getElementById('transactionCategoryFilter').value;
            
            let transactions = buildTransactionHistory();
            
            if (typeFilter !== 'all') {
                transactions = transactions.filter(t => t.type.toLowerCase().includes(typeFilter));
            }
            
            if (categoryFilter !== 'all') {
                transactions = transactions.filter(t => t.category === categoryFilter);
            }
            
            const html = transactions.map(t => `
                <tr>
                    <td>${new Date(t.date).toLocaleDateString('fr-FR')}</td>
                    <td><span style="padding: 4px 12px; background: rgba(255, 99, 71, 0.1); border-radius: 12px; font-size: 0.85em; font-weight: 600;">${t.type}</span></td>
                    <td style="text-transform: capitalize;">${t.category}</td>
                    <td style="font-weight: 700;">${t.asset}</td>
                    <td>${t.quantity.toLocaleString('fr-FR', {maximumFractionDigits: 8})}</td>
                    <td>‚Ç¨${t.price.toLocaleString('fr-FR', {minimumFractionDigits: 2})}</td>
                    <td style="font-weight: 700;">‚Ç¨${t.amount.toLocaleString('fr-FR', {minimumFractionDigits: 2})}</td>
                </tr>
            `).join('');
            
            document.getElementById('transactionHistory').innerHTML = html || '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">Aucune transaction correspondante</td></tr>';
        }
        
        function exportTransactions() {
            const transactions = buildTransactionHistory();
            
            let csv = 'Date,Type,Cat√©gorie,Actif,Quantit√©,Prix,Montant\n';
            transactions.forEach(t => {
                csv += `${t.date},${t.type},${t.category},${t.asset},${t.quantity},${t.price},${t.amount}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'transactions-' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // Add to updateAll function
        const originalUpdateAll = updateAll;
        updateAll = async function() {
            await originalUpdateAll();
            updateEvolutionChart();
            updatePerformanceView();
            updateDiversificationAnalysis();
            updateTransactionHistory();
            updatePortfolio();
            updateQuickStats();
        };
        
        // Function to handle time range selection from dropdown
        function setTimeRangeFromSelect(range) {
            setTimeRange(range);
        }
        
        // Drive Connection Button Functions
        function updateDriveConnectionButton(isConnected) {
            const btn = document.getElementById('driveConnectionBtn');
            const icon = document.getElementById('driveIcon');
            const text = document.getElementById('driveText');
            
            if (isConnected) {
                btn.classList.add('connected');
                icon.textContent = '‚úì';
                text.textContent = 'D√©connecter';
            } else {
                btn.classList.remove('connected');
                icon.textContent = 'üîå';
                text.textContent = 'Connecter Drive';
            }
        }
        
        function toggleDriveConnection() {
            if (isGoogleDriveConnected) {
                // Disconnect
                if (confirm('Voulez-vous vraiment vous d√©connecter de Google Drive ? Toutes les donn√©es du portfolio seront effac√©es de l\'affichage.')) {
                    disconnectGoogleDrive();
                }
            } else {
                // Connect
                connectGoogleDrive();
            }
        }
        
        // Initialize button state on page load
        window.addEventListener('DOMContentLoaded', () => {
            updateDriveConnectionButton(isGoogleDriveConnected);
            updateGoalsList();
            
            // Initialize theme and currency
            applyTheme(currentTheme);
            const currencySelect = document.getElementById('currencySelect');
            if (currencySelect) {
                currencySelect.value = currentCurrency;
            }
            
            // Auto-calculate current capital from portfolio
            const retireCurrentCapital = document.getElementById('retireCurrentCapital');
            if (retireCurrentCapital) {
                retireCurrentCapital.addEventListener('focus', function() {
                    if (this.value == 0) {
                        const totalValue = calculateTotalPortfolioValue();
                        this.value = Math.round(totalValue);
                    }
                });
            }
        });
        
        // ========================================
        // üéØ GOALS MANAGEMENT
        // ========================================
        
        let editingGoalId = null;
        
        function openGoalModal(goalId = null) {
            const modal = document.getElementById('goalModal');
            modal.style.display = 'flex';
            
            if (goalId !== null) {
                // Edit mode
                editingGoalId = goalId;
                const goal = portfolio.goals.find(g => g.id === goalId);
                if (goal) {
                    document.getElementById('goalName').value = goal.name;
                    document.getElementById('goalTarget').value = goal.target;
                    document.getElementById('goalDate').value = goal.date || '';
                    document.getElementById('goalCurrent').value = goal.current;
                    document.getElementById('goalCategory').value = goal.category;
                    document.getElementById('goalNotes').value = goal.notes || '';
                    document.querySelector('#goalModal h3').textContent = '‚úèÔ∏è Modifier l\'objectif';
                }
            } else {
                // Create mode
                editingGoalId = null;
                document.getElementById('goalForm').reset();
                document.querySelector('#goalModal h3').textContent = 'üéØ Nouvel objectif';
            }
        }
        
        function closeGoalModal() {
            document.getElementById('goalModal').style.display = 'none';
            document.getElementById('goalForm').reset();
            editingGoalId = null;
        }
        
        function saveGoal(event) {
            event.preventDefault();
            
            // Ensure goals array exists
            if (!portfolio.goals) {
                portfolio.goals = [];
            }
            
            const goal = {
                id: editingGoalId || Date.now(),
                name: document.getElementById('goalName').value,
                target: parseFloat(document.getElementById('goalTarget').value),
                date: document.getElementById('goalDate').value || null,
                current: parseFloat(document.getElementById('goalCurrent').value) || 0,
                category: document.getElementById('goalCategory').value,
                notes: document.getElementById('goalNotes').value || '',
                createdAt: editingGoalId ? (portfolio.goals.find(g => g.id === editingGoalId)?.createdAt || new Date().toISOString()) : new Date().toISOString()
            };
            
            if (editingGoalId) {
                // Update existing goal
                const index = portfolio.goals.findIndex(g => g.id === editingGoalId);
                if (index !== -1) {
                    portfolio.goals[index] = goal;
                }
            } else {
                // Add new goal
                portfolio.goals.push(goal);
            }
            
            syncDriveData();
            updateGoalsList();
            closeGoalModal();
        }
        
        function deleteGoal(goalId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet objectif ?')) {
                portfolio.goals = portfolio.goals.filter(g => g.id !== goalId);
                syncDriveData();
                updateGoalsList();
            }
        }
        
        function updateGoalProgress(goalId, amount) {
            const goal = portfolio.goals.find(g => g.id === goalId);
            if (goal) {
                const newAmount = parseFloat(prompt(`Mise √† jour de l'objectif "${goal.name}"
                
Montant actuel: ‚Ç¨${goal.current.toLocaleString('fr-FR', {minimumFractionDigits: 2})}
Montant cible: ‚Ç¨${goal.target.toLocaleString('fr-FR', {minimumFractionDigits: 2})}

Nouveau montant:`, goal.current));
                
                if (!isNaN(newAmount) && newAmount >= 0) {
                    goal.current = newAmount;
                    syncDriveData();
                    updateGoalsList();
                }
            }
        }
        
        function updateGoalsList() {
            const container = document.getElementById('goalsList');
            if (!container) return;
            
            if (!portfolio.goals || portfolio.goals.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                        <div style="font-size: 4em; margin-bottom: 16px;">üéØ</div>
                        <h3 style="margin-bottom: 12px;">Aucun objectif d√©fini</h3>
                        <p style="margin-bottom: 24px;">Cr√©ez votre premier objectif financier pour suivre vos progr√®s</p>
                        <button class="update-btn" onclick="openGoalModal()">‚ûï Cr√©er un objectif</button>
                    </div>
                `;
                return;
            }
            
            const html = portfolio.goals.map(goal => {
                const progress = goal.target > 0 ? (goal.current / goal.target * 100) : 0;
                const remaining = goal.target - goal.current;
                const progressClamped = Math.min(progress, 100);
                
                // Calculate status
                let status = 'on-track';
                let statusText = 'En cours';
                let statusIcon = 'üîÑ';
                
                if (progress >= 100) {
                    status = 'completed';
                    statusText = 'Objectif atteint !';
                    statusIcon = '‚úÖ';
                } else if (goal.date) {
                    const daysRemaining = Math.ceil((new Date(goal.date) - new Date()) / (1000 * 60 * 60 * 24));
                    if (daysRemaining < 0) {
                        status = 'behind';
                        statusText = '√âch√©ance d√©pass√©e';
                        statusIcon = '‚ö†Ô∏è';
                    } else if (daysRemaining < 90) {
                        const requiredMonthly = remaining / (daysRemaining / 30);
                        statusText = `${daysRemaining} jours restants`;
                        statusIcon = '‚è±Ô∏è';
                    }
                }
                
                // Category emoji
                const categoryEmojis = {
                    savings: 'üí∞',
                    investment: 'üìà',
                    purchase: 'üè†',
                    retirement: 'üèñÔ∏è',
                    education: 'üéì',
                    travel: '‚úàÔ∏è',
                    other: 'üìå'
                };
                
                const categoryEmoji = categoryEmojis[goal.category] || 'üìå';
                
                return `
                    <div class="goal-card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                    <span style="font-size: 1.8em;">${categoryEmoji}</span>
                                    <h3 style="margin: 0; font-size: 1.3em; font-weight: 800;">${goal.name}</h3>
                                </div>
                                <span class="goal-badge ${status}">${statusIcon} ${statusText}</span>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-size: 0.9em; color: var(--text-secondary);">Progression</span>
                                <span style="font-weight: 700; font-size: 1.1em; color: var(--orange-primary);">${progressClamped.toFixed(1)}%</span>
                            </div>
                            <div class="goal-progress-bar">
                                <div class="goal-progress-fill" style="width: ${progressClamped}%"></div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px;">
                            <div>
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">Actuel</div>
                                <div style="font-weight: 700; font-size: 1.2em;" class="value-hidden">‚Ç¨${goal.current.toLocaleString('fr-FR', {minimumFractionDigits: 2})}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">Restant</div>
                                <div style="font-weight: 700; font-size: 1.2em; color: ${remaining > 0 ? 'var(--text-secondary)' : 'var(--success)'};" class="value-hidden">‚Ç¨${Math.max(0, remaining).toLocaleString('fr-FR', {minimumFractionDigits: 2})}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">Objectif</div>
                                <div style="font-weight: 700; font-size: 1.2em; color: var(--orange-primary);" class="value-hidden">‚Ç¨${goal.target.toLocaleString('fr-FR', {minimumFractionDigits: 2})}</div>
                            </div>
                        </div>
                        
                        ${goal.date ? `
                            <div style="padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 10px; margin-bottom: 16px;">
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">üìÖ Date cible</div>
                                <div style="font-weight: 600;">${new Date(goal.date).toLocaleDateString('fr-FR', {year: 'numeric', month: 'long', day: 'numeric'})}</div>
                            </div>
                        ` : ''}
                        
                        ${goal.notes ? `
                            <div style="padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 10px; margin-bottom: 16px;">
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px;">üìù Notes</div>
                                <div style="font-size: 0.9em; line-height: 1.6;">${goal.notes}</div>
                            </div>
                        ` : ''}
                        
                        <div class="goal-actions">
                            <button class="goal-action-btn" onclick="updateGoalProgress(${goal.id})">üí∞ Mettre √† jour</button>
                            <button class="goal-action-btn" onclick="openGoalModal(${goal.id})">‚úèÔ∏è Modifier</button>
                            <button class="goal-action-btn delete" onclick="deleteGoal(${goal.id})">üóëÔ∏è Supprimer</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            
            // Apply privacy mode if enabled
            if (isPrivacyMode) {
                applyPrivacyMode();
            }
        }
        
        // ========================================
        // üí∞ DCA CALCULATOR
        // ========================================
        
        function calculateDCA() {
            const monthlyAmount = parseFloat(document.getElementById('dcaMonthlyAmount').value) || 0;
            const duration = parseInt(document.getElementById('dcaDuration').value) || 12;
            const returnRate = parseFloat(document.getElementById('dcaReturnRate').value) || 7;
            
            const monthlyRate = returnRate / 100 / 12;
            const totalInvested = monthlyAmount * duration;
            
            // Future value of annuity formula
            let futureValue = 0;
            if (monthlyRate === 0) {
                futureValue = totalInvested;
            } else {
                futureValue = monthlyAmount * ((Math.pow(1 + monthlyRate, duration) - 1) / monthlyRate);
            }
            
            const gains = futureValue - totalInvested;
            const gainPercentage = totalInvested > 0 ? (gains / totalInvested * 100) : 0;
            
            // Generate chart data
            const chartData = [];
            const labels = [];
            let cumulativeInvested = 0;
            let cumulativeValue = 0;
            
            for (let month = 0; month <= duration; month++) {
                labels.push(`M${month}`);
                cumulativeInvested = monthlyAmount * month;
                
                if (monthlyRate === 0) {
                    cumulativeValue = cumulativeInvested;
                } else {
                    cumulativeValue = month === 0 ? 0 : monthlyAmount * ((Math.pow(1 + monthlyRate, month) - 1) / monthlyRate);
                }
                
                chartData.push({
                    month: month,
                    invested: cumulativeInvested,
                    value: cumulativeValue
                });
            }
            
            // Display results
            const resultsHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div style="text-align: center; padding: 20px; background: rgba(255, 99, 71, 0.1); border-radius: 12px; border: 1px solid var(--orange-primary);">
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">Total investi</div>
                        <div style="font-size: 2em; font-weight: 900; color: var(--text-primary);">‚Ç¨${totalInvested.toLocaleString('fr-FR', {minimumFractionDigits: 2})}</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: rgba(0, 212, 170, 0.1); border-radius: 12px; border: 1px solid var(--success);">
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">Valeur finale</div>
                        <div style="font-size: 2em; font-weight: 900; color: var(--success);">‚Ç¨${futureValue.toLocaleString('fr-FR', {minimumFractionDigits: 2})}</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: rgba(74, 158, 255, 0.1); border-radius: 12px; border: 1px solid #4a9eff;">
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">Gains</div>
                        <div style="font-size: 2em; font-weight: 900; color: #4a9eff;">‚Ç¨${gains.toLocaleString('fr-FR', {minimumFractionDigits: 2})}</div>
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 4px;">+${gainPercentage.toFixed(2)}%</div>
                    </div>
                </div>
            `;
            
            document.getElementById('dcaResults').innerHTML = resultsHTML;
            
            // Draw chart
            const ctx = document.getElementById('dcaChart');
            if (window.dcaChartInstance) {
                window.dcaChartInstance.destroy();
            }
            
            // Get theme colors
            const colors = getChartColors();
            
            window.dcaChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total investi',
                            data: chartData.map(d => d.invested),
                            borderColor: 'rgba(255, 99, 71, 1)',
                            backgroundColor: 'rgba(255, 99, 71, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Valeur du portfolio',
                            data: chartData.map(d => d.value),
                            borderColor: 'rgba(0, 212, 170, 1)',
                            backgroundColor: 'rgba(0, 212, 170, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: colors.text,
                                font: {
                                    size: 12,
                                    weight: 600,
                                    family: 'Inter'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: colors.tooltipBg,
                            titleColor: colors.text,
                            bodyColor: colors.text,
                            borderColor: colors.tooltipBorder,
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ‚Ç¨${context.parsed.y.toLocaleString('fr-FR', {minimumFractionDigits: 2})}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: colors.grid },
                            ticks: { color: colors.textSecondary }
                        },
                        y: {
                            grid: { color: colors.grid },
                            ticks: { 
                                color: colors.textSecondary,
                                callback: function(value) {
                                    return '‚Ç¨' + value.toLocaleString('fr-FR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ========================================
        // üèñÔ∏è RETIREMENT CALCULATOR
        // ========================================
        
        function calculateTotalPortfolioValue() {
            let total = 0;
            
            // Crypto
            portfolio.crypto.forEach(c => {
                const currentPrice = portfolio.prices[c.symbol] || 0;
                total += c.quantity * currentPrice;
            });
            
            // PEA
            const peaByTicker = {};
            portfolio.pea.forEach(p => {
                if (!peaByTicker[p.ticker]) {
                    peaByTicker[p.ticker] = { quantity: 0, invested: 0 };
                }
                peaByTicker[p.ticker].quantity += p.quantity;
                peaByTicker[p.ticker].invested += (p.quantity * p.price) + (p.fees || 0);
            });
            
            Object.entries(peaByTicker).forEach(([ticker, data]) => {
                const avgPrice = data.invested / data.quantity;
                const currentPrice = portfolio.prices[ticker] || avgPrice;
                total += data.quantity * currentPrice;
            });
            
            // Livrets
            portfolio.livrets.forEach(l => {
                total += parseFloat(l.amount) || 0;
            });
            
            // Fundraising
            portfolio.fundraising.forEach(f => {
                total += f.valuation;
            });
            
            return total;
        }
        
        function calculateRetirement() {
            const currentCapital = parseFloat(document.getElementById('retireCurrentCapital').value) || 0;
            const monthlySavings = parseFloat(document.getElementById('retireMonthlySavings').value) || 0;
            const returnRate = parseFloat(document.getElementById('retireReturnRate').value) || 7;
            const monthlyExpenses = parseFloat(document.getElementById('retireMonthlyExpenses').value) || 3000;
            const withdrawalRate = parseFloat(document.getElementById('retireWithdrawalRate').value) || 4;
            
            // Calculate target capital needed (using 4% rule or custom)
            const targetCapital = (monthlyExpenses * 12) / (withdrawalRate / 100);
            
            // Calculate months needed to reach target
            const monthlyRate = returnRate / 100 / 12;
            let months = 0;
            let capital = currentCapital;
            
            if (capital >= targetCapital) {
                months = 0;
            } else if (monthlySavings === 0) {
                // Only growth, no contributions
                if (monthlyRate > 0) {
                    months = Math.log(targetCapital / currentCapital) / Math.log(1 + monthlyRate);
                } else {
                    months = Infinity;
                }
            } else {
                // With monthly contributions
                while (capital < targetCapital && months < 1200) { // Max 100 years
                    capital = capital * (1 + monthlyRate) + monthlySavings;
                    months++;
                }
            }
            
            const years = Math.floor(months / 12);
            const remainingMonths = Math.floor(months % 12);
            
            // Calculate date
            const targetDate = new Date();
            targetDate.setMonth(targetDate.getMonth() + months);
            
            const resultsHTML = `
                <div style="background: linear-gradient(135deg, rgba(255, 99, 71, 0.1), rgba(0, 212, 170, 0.1)); padding: 32px; border-radius: 20px; border: 1px solid var(--border-subtle);">
                    <div style="text-align: center; margin-bottom: 32px;">
                        <div style="font-size: 4em; margin-bottom: 16px;">üèñÔ∏è</div>
                        ${months === 0 ? `
                            <h3 style="font-size: 2em; margin-bottom: 12px; color: var(--success);">Vous √™tes d√©j√† financi√®rement ind√©pendant !</h3>
                            <p style="color: var(--text-secondary);">Votre capital actuel est suffisant pour couvrir vos d√©penses mensuelles.</p>
                        ` : months < 1200 ? `
                            <h3 style="font-size: 2em; margin-bottom: 12px;">Ind√©pendance financi√®re dans</h3>
                            <div style="font-size: 3.5em; font-weight: 900; color: var(--orange-primary); margin-bottom: 8px;">
                                ${years > 0 ? years + ' an' + (years > 1 ? 's' : '') : ''}
                                ${years > 0 && remainingMonths > 0 ? ' et ' : ''}
                                ${remainingMonths > 0 ? remainingMonths + ' mois' : ''}
                            </div>
                            <p style="font-size: 1.1em; color: var(--text-secondary);">üìÖ Date estim√©e: ${targetDate.toLocaleDateString('fr-FR', {year: 'numeric', month: 'long'})}</p>
                        ` : `
                            <h3 style="font-size: 2em; margin-bottom: 12px; color: var(--danger);">Objectif difficile √† atteindre</h3>
                            <p style="color: var(--text-secondary);">Avec les param√®tres actuels, il faudrait plus de 100 ans. Augmentez votre √©pargne mensuelle ou revoyez vos d√©penses.</p>
                        `}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center; padding: 20px; background: var(--bg-card); border-radius: 12px;">
                            <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">Capital actuel</div>
                            <div style="font-size: 1.8em; font-weight: 900;">‚Ç¨${currentCapital.toLocaleString('fr-FR', {maximumFractionDigits: 0})}</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: var(--bg-card); border-radius: 12px;">
                            <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">Capital n√©cessaire</div>
                            <div style="font-size: 1.8em; font-weight: 900; color: var(--orange-primary);">‚Ç¨${targetCapital.toLocaleString('fr-FR', {maximumFractionDigits: 0})}</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: var(--bg-card); border-radius: 12px;">
                            <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px;">Restant √† accumuler</div>
                            <div style="font-size: 1.8em; font-weight: 900; color: ${targetCapital > currentCapital ? 'var(--text-secondary)' : 'var(--success)'};">‚Ç¨${Math.max(0, targetCapital - currentCapital).toLocaleString('fr-FR', {maximumFractionDigits: 0})}</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 24px; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
                        <h4 style="margin-bottom: 12px;">üí° Calculs bas√©s sur :</h4>
                        <ul style="list-style: none; padding: 0; margin: 0; line-height: 2;">
                            <li>üìä R√®gle de retrait: ${withdrawalRate}% par an (${(monthlyExpenses * 12).toLocaleString('fr-FR')}‚Ç¨/an)</li>
                            <li>üí∞ √âpargne mensuelle: ${monthlySavings.toLocaleString('fr-FR')}‚Ç¨</li>
                            <li>üìà Rendement annuel: ${returnRate}%</li>
                            <li>üíµ D√©penses mensuelles: ${monthlyExpenses.toLocaleString('fr-FR')}‚Ç¨</li>
                        </ul>
                    </div>
                </div>
            `;
            
            document.getElementById('retireResults').innerHTML = resultsHTML;
        }
        
        // ========================================
        // üé® THEME & ACCESSIBILITY
        // ========================================
        
        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(currentTheme);
        }
        
        function setTheme(theme) {
            currentTheme = theme;
            applyTheme(theme);
        }
        
        function applyTheme(theme) {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            
            console.log('Applying theme:', theme); // Debug
            
            if (theme === 'light') {
                body.classList.add('light-mode');
                if (themeIcon) themeIcon.textContent = '‚òÄÔ∏è';
            } else {
                body.classList.remove('light-mode');
                if (themeIcon) themeIcon.textContent = 'üåô';
            }
            
            // Update active theme button
            document.querySelectorAll('.theme-option').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.getElementById(`theme-${theme}`);
            if (activeBtn) activeBtn.classList.add('active');
            
            localStorage.setItem('theme', theme);
            
            console.log('Body classes:', body.className); // Debug
            
            // Recreate charts with new colors
            setTimeout(() => {
                updatePortfolio();
                updateDiversificationAnalysis();
                
                // Recreate DCA chart if exists
                if (window.dcaChartInstance) {
                    calculateDCA();
                }
            }, 100);
        }
        
        // ========================================
        // üí± CURRENCY MANAGEMENT
        // ========================================
        
        function changeCurrency(currency) {
            currentCurrency = currency;
            localStorage.setItem('currency', currency);
            
            // Update all displays
            updateAll();
            
            console.log(`Currency changed to ${currency}`);
        }
        
        function formatCurrency(amount, skipConversion = false) {
            if (skipConversion || currentCurrency === 'EUR') {
                return `‚Ç¨${amount.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
            
            const converted = amount * exchangeRates[currentCurrency];
            const symbols = { USD: '$', GBP: '¬£', CHF: 'CHF ' };
            const symbol = symbols[currentCurrency] || '‚Ç¨';
            
            if (currentCurrency === 'CHF') {
                return `${symbol}${converted.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
            
            return `${symbol}${converted.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }
        
        // ========================================
        // üìÑ EXPORT & PRINT
        // ========================================
        
        async function exportPDF() {
            alert('üìÑ Fonctionnalit√© d\'export PDF en d√©veloppement.\n\nPour l\'instant, utilisez Ctrl+P pour imprimer en PDF via votre navigateur.');
            window.print();
        }
        
        function printReport() {
            window.print();
        }
        
        function exportExcel() {
            // Create workbook data
            let csvContent = "Type,Actif,Quantit√©,Prix d'achat,Valeur actuelle,P&L\n";
            
            // Crypto
            portfolio.crypto.forEach(c => {
                const currentPrice = portfolio.prices[c.symbol] || 0;
                const currentValue = c.quantity * currentPrice;
                const invested = c.quantity * c.price;
                const pnl = currentValue - invested;
                csvContent += `Crypto,${c.symbol},${c.quantity},${c.price},${currentPrice},${pnl}\n`;
            });
            
            // PEA
            const peaByTicker = {};
            portfolio.pea.forEach(p => {
                if (!peaByTicker[p.ticker]) {
                    peaByTicker[p.ticker] = { quantity: 0, invested: 0 };
                }
                peaByTicker[p.ticker].quantity += p.quantity;
                peaByTicker[p.ticker].invested += (p.quantity * p.price) + (p.fees || 0);
            });
            
            Object.entries(peaByTicker).forEach(([ticker, data]) => {
                const avgPrice = data.invested / data.quantity;
                const currentPrice = portfolio.prices[ticker] || avgPrice;
                const currentValue = data.quantity * currentPrice;
                const pnl = currentValue - data.invested;
                csvContent += `PEA,${ticker},${data.quantity},${avgPrice.toFixed(2)},${currentPrice},${pnl}\n`;
            });
            
            // Livrets
            portfolio.livrets.forEach(l => {
                const amount = parseFloat(l.amount) || 0;
                csvContent += `Livret,${l.type},1,${amount},${amount},0\n`;
            });
            
            // Fundraising
            portfolio.fundraising.forEach(f => {
                const pnl = f.valuation - f.amount;
                csvContent += `Lev√©e,${f.name},1,${f.amount},${f.valuation},${pnl}\n`;
            });
            
            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `portfolio-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // ========================================
        // ‚å®Ô∏è KEYBOARD SHORTCUTS
        // ========================================
        
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + shortcuts
            if (e.ctrlKey || e.metaKey) {
                switch(e.key.toLowerCase()) {
                    case 'd':
                        e.preventDefault();
                        showSection('dashboard');
                        break;
                    case 'p':
                        e.preventDefault();
                        showSection('portfolio');
                        break;
                    case 't':
                        e.preventDefault();
                        toggleTheme();
                        break;
                    case 'h':
                        e.preventDefault();
                        togglePrivacy();
                        break;
                    case 'e':
                        e.preventDefault();
                        exportPDF();
                        break;
                    case 's':
                        e.preventDefault();
                        syncDriveData();
                        break;
                    case 'n':
                        e.preventDefault();
                        openQuickAddModal();
                        break;
                }
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                closeQuickAddModal();
                closeGoalModal();
            }
        });
        
        // ========================================
        // ‚ö° QUICK WINS FEATURES
        // ========================================
        
        // Quick Add Modal
        function openQuickAddModal() {
            document.getElementById('quickAddModal').style.display = 'flex';
        }
        
        function closeQuickAddModal() {
            document.getElementById('quickAddModal').style.display = 'none';
        }
        
        function quickAddAsset(type) {
            closeQuickAddModal();
            
            switch(type) {
                case 'crypto':
                    showSection('crypto');
                    break;
                case 'pea':
                    showSection('pea');
                    break;
                case 'livret':
                    showSection('livrets');
                    break;
                case 'fundraising':
                    showSection('fundraising');
                    break;
            }
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function quickAddGoal() {
            closeQuickAddModal();
            showSection('goals');
            setTimeout(() => openGoalModal(), 300);
        }
        
        // Quick Stats
        function updateQuickStats() {
            const container = document.getElementById('quickStats');
            if (!container) return;
            
            // Calculate total invested this year
            const currentYear = new Date().getFullYear();
            let investedThisYear = 0;
            
            portfolio.crypto.forEach(c => {
                const date = new Date(c.date);
                if (date.getFullYear() === currentYear) {
                    investedThisYear += c.quantity * c.price;
                }
            });
            
            portfolio.pea.forEach(p => {
                const date = new Date(p.date);
                if (date.getFullYear() === currentYear) {
                    investedThisYear += (p.quantity * p.price) + (p.fees || 0);
                }
            });
            
            portfolio.livrets.forEach(l => {
                const date = new Date(l.date);
                if (date.getFullYear() === currentYear) {
                    investedThisYear += parseFloat(l.amount) || 0;
                }
            });
            
            portfolio.fundraising.forEach(f => {
                const date = new Date(f.date);
                if (date.getFullYear() === currentYear) {
                    investedThisYear += f.amount;
                }
            });
            
            // Calculate total assets count
            const totalAssets = portfolio.crypto.length + 
                               portfolio.pea.length + 
                               portfolio.livrets.length + 
                               portfolio.fundraising.length;
            
            // Calculate streak (days since last update)
            const lastUpdate = localStorage.getItem('lastUpdateDate');
            const today = new Date().toDateString();
            let streakDays = parseInt(localStorage.getItem('streakDays') || '0');
            
            if (lastUpdate === today) {
                // Already updated today
            } else if (lastUpdate) {
                const lastDate = new Date(lastUpdate);
                const diff = Math.floor((new Date() - lastDate) / (1000 * 60 * 60 * 24));
                if (diff === 1) {
                    streakDays++;
                } else if (diff > 1) {
                    streakDays = 1;
                }
                localStorage.setItem('streakDays', streakDays.toString());
                localStorage.setItem('lastUpdateDate', today);
            } else {
                streakDays = 1;
                localStorage.setItem('streakDays', '1');
                localStorage.setItem('lastUpdateDate', today);
            }
            
            // Calculate best day (highest single day gain - mock for now)
            const totalValue = calculateTotalPortfolioValue();
            const totalInvested = calculateTotalInvested();
            const totalGain = totalValue - totalInvested;
            
            const html = `
                <div class="quick-stat-item">
                    <div class="quick-stat-label">üìÖ Investi ${currentYear}</div>
                    <div class="quick-stat-value value-hidden">‚Ç¨${investedThisYear.toLocaleString('fr-FR', {maximumFractionDigits: 0})}</div>
                </div>
                <div class="quick-stat-item">
                    <div class="quick-stat-label">üíº Total actifs</div>
                    <div class="quick-stat-value">${totalAssets}</div>
                </div>
                <div class="quick-stat-item">
                    <div class="quick-stat-label">üî• S√©rie</div>
                    <div class="quick-stat-value">${streakDays} jour${streakDays > 1 ? 's' : ''}</div>
                </div>
                <div class="quick-stat-item">
                    <div class="quick-stat-label">üíö Gain total</div>
                    <div class="quick-stat-value ${totalGain >= 0 ? 'positive' : 'negative'} value-hidden">
                        ${totalGain >= 0 ? '+' : ''}‚Ç¨${totalGain.toLocaleString('fr-FR', {maximumFractionDigits: 0})}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Apply privacy mode if enabled
            if (isPrivacyMode) {
                applyPrivacyMode();
            }
        }
        
        function calculateTotalInvested() {
            let total = 0;
            
            portfolio.crypto.forEach(c => {
                total += c.quantity * c.price;
            });
            
            portfolio.pea.forEach(p => {
                total += (p.quantity * p.price) + (p.fees || 0);
            });
            
            portfolio.livrets.forEach(l => {
                total += parseFloat(l.amount) || 0;
            });
            
            portfolio.fundraising.forEach(f => {
                total += f.amount;
            });
            
            return total;
        }
        
        // Initialize theme and currency on load
        
    </script>
    
    
    <!-- Quick Add Modal -->
    <div id="quickAddModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h3 style="margin: 0; font-size: 1.5em;">‚ûï Ajout rapide</h3>
                <button onclick="closeQuickAddModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-secondary);">‚úï</button>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                <button class="quick-add-option" onclick="quickAddAsset('crypto')">
                    <span style="font-size: 2em;">‚Çø</span>
                    <span style="font-weight: 700;">Crypto</span>
                </button>
                <button class="quick-add-option" onclick="quickAddAsset('pea')">
                    <span style="font-size: 2em;">üìà</span>
                    <span style="font-weight: 700;">Action</span>
                </button>
                <button class="quick-add-option" onclick="quickAddAsset('livret')">
                    <span style="font-size: 2em;">üí∞</span>
                    <span style="font-weight: 700;">Livret</span>
                </button>
                <button class="quick-add-option" onclick="quickAddAsset('fundraising')">
                    <span style="font-size: 2em;">üöÄ</span>
                    <span style="font-weight: 700;">Lev√©e</span>
                </button>
                <button class="quick-add-option" onclick="quickAddGoal()">
                    <span style="font-size: 2em;">üéØ</span>
                    <span style="font-weight: 700;">Objectif</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Goal Modal -->
    <div id="goalModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h3 style="margin: 0; font-size: 1.5em;">üéØ Nouvel objectif</h3>
                <button onclick="closeGoalModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-secondary);">‚úï</button>
            </div>
            
            <form id="goalForm" onsubmit="saveGoal(event)">
                <div class="form-group">
                    <label>Nom de l'objectif *</label>
                    <input type="text" id="goalName" required placeholder="Ex: Acheter une maison, Retraite anticip√©e">
                </div>
                
                <div class="form-group">
                    <label>Montant cible (‚Ç¨) *</label>
                    <input type="number" id="goalTarget" required min="1" step="0.01" placeholder="50000">
                </div>
                
                <div class="form-group">
                    <label>Date cible</label>
                    <input type="date" id="goalDate">
                </div>
                
                <div class="form-group">
                    <label>Montant actuel (‚Ç¨)</label>
                    <input type="number" id="goalCurrent" value="0" min="0" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>Cat√©gorie</label>
                    <select id="goalCategory">
                        <option value="savings">üí∞ √âpargne</option>
                        <option value="investment">üìà Investissement</option>
                        <option value="purchase">üè† Achat</option>
                        <option value="retirement">üèñÔ∏è Retraite</option>
                        <option value="education">üéì √âducation</option>
                        <option value="travel">‚úàÔ∏è Voyage</option>
                        <option value="other">üìå Autre</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="goalNotes" rows="3" placeholder="Description ou notes suppl√©mentaires..."></textarea>
                </div>
                
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button type="submit" class="update-btn" style="flex: 1;">Enregistrer</button>
                    <button type="button" onclick="closeGoalModal()" class="privacy-btn" style="flex: 1;">Annuler</button>
                </div>
            </form>
        </div>
    </div>
    
</body>
</html>