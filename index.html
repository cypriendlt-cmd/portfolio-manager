<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Manager - Google Sheets Auto-Sync</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 100%);
            color: #fff;
            line-height: 1.6;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        h1 { color: #00ff88; font-size: clamp(1.5em, 5vw, 2.5em); }
        .sync-status {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 5px;
        }
        .sync-status.synced { background: rgba(0, 255, 136, 0.2); color: #00ff88; }
        .update-btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        .update-btn:hover { transform: translateY(-2px); }
        nav {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .nav-btn {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #1a1f2e;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
        }
        .nav-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3); }
        .section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: none;
        }
        .section.active { display: block; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(0, 204, 106, 0.1) 100%);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }
        .stat-label { font-size: 0.9em; color: #a0aec0; margin-bottom: 10px; }
        .stat-value { font-size: 2em; font-weight: bold; color: #00ff88; }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 8px; color: #a0aec0; font-size: 0.9em; }
        input, select {
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            border-radius: 8px;
        }
        input:focus, select:focus { outline: none; border-color: #00ff88; }
        .success-message {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: #00ff88;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        .info-message {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.3);
            color: #3498db;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        .warning-message {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            color: #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        button {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #1a1f2e;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4); }
        .btn-secondary { background: rgba(255, 255, 255, 0.1); color: #fff; }
        .btn-primary { background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%); color: #1a1f2e; }
        .btn-danger { background: linear-gradient(135deg, #ff4757 0%, #cc3847 100%); color: #fff; }
        
        /* Crypto library styles */
        .crypto-library {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .crypto-library h3 {
            color: #00ff88;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        .crypto-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }
        .crypto-chip {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .crypto-chip:hover {
            background: rgba(0, 255, 136, 0.1);
            border-color: #00ff88;
            transform: translateY(-2px);
        }
        .crypto-chip.selected {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }
        .crypto-chip-symbol {
            font-weight: bold;
            color: #00ff88;
            font-size: 0.9em;
        }
        .crypto-chip-name {
            font-size: 0.75em;
            color: #a0aec0;
            margin-top: 4px;
        }
        
        /* Binance API styles */
        .binance-section {
            background: rgba(243, 186, 47, 0.05);
            border: 1px solid rgba(243, 186, 47, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .binance-section h3 {
            color: #f3ba2f;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .binance-logo {
            width: 24px;
            height: 24px;
        }
        .api-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }
        .api-status.connected {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        .api-status.disconnected {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }
        
        /* Edit mode styles */
        td .edit-mode {
            width: 100%;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: #fff;
            border-radius: 4px;
        }
        td button {
            padding: 8px 12px;
            font-size: 0.9em;
        }
        
        .asset-group {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .asset-header {
            padding: 15px 20px;
            background: rgba(0, 255, 136, 0.08);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            flex-wrap: wrap;
            gap: 15px;
        }
        .asset-header:hover { background: rgba(0, 255, 136, 0.12); }
        .asset-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 200px;
        }
        .asset-toggle {
            font-size: 1.2em;
            transition: transform 0.3s;
            flex-shrink: 0;
        }
        .asset-toggle.expanded { transform: rotate(90deg); }
        .asset-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #00ff88;
        }
        .asset-ticker {
            color: #a0aec0;
            font-size: 0.9em;
        }
        .asset-stats {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 20px;
            flex: 1;
            min-width: 300px;
        }
        .asset-stat {
            text-align: center;
        }
        .asset-stat-label {
            font-size: 0.75em;
            color: #a0aec0;
            margin-bottom: 5px;
        }
        .asset-stat-value {
            font-size: 1.1em;
            font-weight: bold;
        }
        .positive { color: #00ff88; }
        .negative { color: #ff4757; }
        .neutral { color: #a0aec0; }
        
        /* Quick Select Buttons */
        .quick-select-btn {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid rgba(52, 152, 219, 0.5);
            color: #3498db;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            display: inline-block;
        }
        .quick-select-btn:hover {
            background: rgba(52, 152, 219, 0.4);
            transform: translateY(-2px);
        }
        
        .asset-content {
            display: none;
            padding: 20px;
            background: rgba(0, 0, 0, 0.1);
        }
        .asset-content.expanded { display: block; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        th {
            background: rgba(0, 0, 0, 0.2);
            color: #00ff88;
            font-weight: bold;
        }
        tr:hover { background: rgba(255, 255, 255, 0.02); }
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
        }
        @media (max-width: 768px) {
            .asset-stats { grid-template-columns: repeat(3, 1fr); }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Portfolio Manager Pro</h1>
            <div class="sync-status" id="syncStatus">‚è≥ Non synchronis√©</div>
            <button class="update-btn" onclick="updateAll()">üîÑ Actualiser les prix</button>
        </header>

        <nav>
            <button class="nav-btn" onclick="showSection('dashboard')">üìà Dashboard</button>
            <button class="nav-btn" onclick="showSection('crypto')">‚Çø Crypto</button>
            <button class="nav-btn" onclick="showSection('pea')">üìä PEA</button>
            <button class="nav-btn" onclick="showSection('livrets')">üí∞ Livrets</button>
            <button class="nav-btn" onclick="showSection('fundraising')">üöÄ Lev√©es</button>
            <button class="nav-btn" onclick="showSection('settings')">‚öôÔ∏è Param√®tres</button>
        </nav>

        <!-- Dashboard -->
        <div id="dashboard" class="section active">
            <h2 style="margin-bottom: 20px;">üìà Vue d'ensemble</h2>
            <div class="stats-grid" id="dashboardStats"></div>
            <div class="chart-container">
                <canvas id="portfolioChart"></canvas>
            </div>
        </div>

        <!-- Crypto Section -->
        <div id="crypto" class="section">
            <h2 style="margin-bottom: 20px;">‚Çø Portefeuille Crypto</h2>
            
            <!-- Binance API Integration -->
            <div class="binance-section">
                <h3>
                    <svg class="binance-logo" viewBox="0 0 126.61 126.61" fill="#f3ba2f">
                        <path d="M38.73 53.2l24.59-24.58 24.6 24.6 14.3-14.31L63.32 0 24.43 38.89l14.3 14.31zM0 63.31l14.3-14.3 14.31 14.3-14.31 14.3L0 63.31zm38.73 10.11l24.59 24.58 24.6-24.6 14.31 14.29-38.9 38.91-38.9-38.88 14.3-14.3zM88.58 63.31l14.3-14.3 14.31 14.3-14.31 14.3-14.3-14.3z"/>
                        <path d="M77.83 63.3l-14.51-14.52-10.73 10.73-1.24 1.23-2.54 2.54-.01.02 14.51 14.5 14.51-14.5z"/>
                    </svg>
                    Importer depuis Binance
                    <span class="api-status" id="binanceStatus">Non connect√©</span>
                </h3>
                
                <div class="info-message">
                    ‚ÑπÔ∏è Connectez votre compte Binance pour importer automatiquement vos positions crypto.
                    <br>üîí Vos cl√©s API sont stock√©es localement et ne sont jamais envoy√©es √† des serveurs tiers.
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>API Key Binance</label>
                        <input type="password" id="binanceApiKey" placeholder="Votre API Key">
                    </div>
                    <div class="form-group">
                        <label>API Secret Binance</label>
                        <input type="password" id="binanceApiSecret" placeholder="Votre API Secret">
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="saveBinanceCredentials()" class="btn-primary">üíæ Sauvegarder les cl√©s</button>
                    <button onclick="importFromBinance()" class="btn-primary">üì• Importer les positions</button>
                    <button onclick="clearBinanceCredentials()" class="btn-danger">üóëÔ∏è Supprimer les cl√©s</button>
                </div>
            </div>

            <!-- Crypto Library -->
            <div class="crypto-library">
                <h3>üìö Biblioth√®que de Cryptos</h3>
                <div class="info-message" style="margin-bottom: 15px;">
                    Cliquez sur une crypto pour remplir automatiquement le symbole
                </div>
                <div class="crypto-grid" id="cryptoLibrary"></div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Symbole (ex: BTC, ETH)</label>
                    <input type="text" id="cryptoSymbol" placeholder="BTC">
                </div>
                <div class="form-group">
                    <label>Quantit√©</label>
                    <input type="number" id="cryptoQuantity" step="0.00000001" placeholder="0.5">
                </div>
                <div class="form-group">
                    <label>Prix d'achat ($)</label>
                    <input type="number" id="cryptoPrice" step="0.01" placeholder="50000">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="cryptoDate">
                </div>
            </div>
            <button onclick="addCrypto()">‚ûï Ajouter une position</button>
            
            <div id="cryptoList"></div>
        </div>

        <!-- PEA Section -->
        <div id="pea" class="section">
            <h2 style="margin-bottom: 20px;">üìä Plan d'√âpargne en Actions (PEA)</h2>
            
            <!-- Quick Select for existing assets -->
            <div class="info-message" style="margin-bottom: 20px;">
                <strong>üí° Astuce :</strong> Pour ajouter une ligne sur un actif existant, s√©lectionnez-le ci-dessous :
                <div id="quickSelectPEA" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px;"></div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Nom de l'action</label>
                    <input type="text" id="peaName" placeholder="Apple Inc." list="peaNameList">
                    <datalist id="peaNameList"></datalist>
                </div>
                <div class="form-group">
                    <label>Ticker</label>
                    <input type="text" id="peaTicker" placeholder="AAPL" list="peaTickerList">
                    <datalist id="peaTickerList"></datalist>
                </div>
                <div class="form-group">
                    <label>Quantit√©</label>
                    <input type="number" id="peaQuantity" step="1" placeholder="10">
                </div>
                <div class="form-group">
                    <label>Prix d'achat (‚Ç¨)</label>
                    <input type="number" id="peaPrice" step="0.01" placeholder="150.50">
                </div>
                <div class="form-group">
                    <label>Frais (‚Ç¨)</label>
                    <input type="number" id="peaFees" step="0.01" placeholder="5.00">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="peaDate">
                </div>
            </div>
            <button onclick="addPEA()">‚ûï Ajouter une position</button>
            
            <div id="peaList"></div>
        </div>

        <!-- Livrets Section -->
        <div id="livrets" class="section">
            <h2 style="margin-bottom: 20px;">üí∞ Livrets d'√©pargne</h2>
            
            <div class="info-message" style="margin-bottom: 20px;">
                <strong>üí° Taux actuels 2025 :</strong><br>
                ‚Ä¢ LEP (Livret d'√âpargne Populaire) : 4.00% net<br>
                ‚Ä¢ Livret A : 2.40% net<br>
                ‚Ä¢ LDDS (Livret de D√©veloppement Durable et Solidaire) : 2.40% net<br>
                ‚Ä¢ Livret Jeune : 2.40% √† 4.00% selon les banques<br>
                ‚Ä¢ PEL (Plan d'√âpargne Logement) : 2.25% brut (apr√®s pr√©l√®vements sociaux)
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Type de livret</label>
                    <select id="livretType">
                        <option value="">-- S√©lectionnez --</option>
                        <option value="LEP">LEP (Livret √âpargne Populaire)</option>
                        <option value="Livret A">Livret A</option>
                        <option value="LDDS">LDDS (Livret D√©veloppement Durable)</option>
                        <option value="Livret Jeune">Livret Jeune</option>
                        <option value="PEL">PEL (Plan √âpargne Logement)</option>
                        <option value="CEL">CEL (Compte √âpargne Logement)</option>
                        <option value="CSL">CSL (Compte Sur Livret)</option>
                        <option value="Autre">Autre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Banque</label>
                    <input type="text" id="livretBank" placeholder="Cr√©dit Agricole">
                </div>
                <div class="form-group">
                    <label>Montant actuel (‚Ç¨)</label>
                    <input type="number" id="livretAmount" step="0.01" placeholder="10000">
                </div>
                <div class="form-group">
                    <label>Taux d'int√©r√™t annuel (%)</label>
                    <input type="number" id="livretRate" step="0.01" placeholder="2.40">
                </div>
                <div class="form-group">
                    <label>Plafond (‚Ç¨)</label>
                    <input type="number" id="livretCeiling" step="0.01" placeholder="22950">
                </div>
                <div class="form-group">
                    <label>Date d'ouverture</label>
                    <input type="date" id="livretDate">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button onclick="addLivret()">‚ûï Ajouter un livret</button>
                <button onclick="autoFillLivretRate()" class="btn-secondary">üîÑ Appliquer les taux actuels</button>
            </div>
            
            <div id="livretsList"></div>
        </div>

        <!-- Fundraising Section -->
        <div id="fundraising" class="section">
            <h2 style="margin-bottom: 20px;">üöÄ Lev√©es de fonds / Investissements</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Nom de l'entreprise</label>
                    <input type="text" id="fundName" placeholder="StartupXYZ">
                </div>
                <div class="form-group">
                    <label>Montant investi (‚Ç¨)</label>
                    <input type="number" id="fundAmount" step="0.01" placeholder="10000">
                </div>
                <div class="form-group">
                    <label>Valuation (‚Ç¨)</label>
                    <input type="number" id="fundValuation" step="0.01" placeholder="1000000">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="fundDate">
                </div>
            </div>
            <button onclick="addFundraising()">‚ûï Ajouter un investissement</button>
            
            <div id="fundraisingList"></div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="section">
            <h2 style="margin-bottom: 20px;">‚öôÔ∏è Param√®tres</h2>
            
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">‚òÅÔ∏è Synchronisation Google Drive</h3>
                
                <div class="form-group" style="max-width: 600px; margin-top: 15px;">
                    <label>Google Client ID</label>
                    <input type="text" id="clientId" placeholder="Votre Client ID Google">
                    <button onclick="saveClientId()" style="margin-top: 10px;">üíæ Enregistrer</button>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <button onclick="connectGoogleDrive()">üîó Connecter</button>
                    <button class="btn-danger" onclick="disconnectGoogleDrive()">‚ùå D√©connecter</button>
                    <button class="btn-secondary" onclick="loadFromDrive()">üì• Charger</button>
                    <button class="btn-secondary" onclick="syncDriveData()">üì§ Sauvegarder</button>
                </div>
            </div>

            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">üìä Synchronisation Google Sheets</h3>
                <div class="info-message">
                    <strong>Configuration :</strong><br>
                    1. Cr√©ez une Google Sheet avec 2 colonnes : <code>ticker</code> et <code>prix</code><br>
                    2. Fichier ‚Üí Partager ‚Üí Publier sur le Web ‚Üí Publier<br>
                    3. Copiez l'ID de la feuille (dans l'URL : /d/<strong>ID_ICI</strong>/edit)<br>
                    4. Collez l'ID ci-dessous<br><br>
                    
                    <strong>Exemple d'URL :</strong><br>
                    <code>https://docs.google.com/spreadsheets/d/<span style="color: #00ff88;">1A2B3C4D5E6F7G8H9I0J</span>/edit</code><br><br>
                    
                    <strong>Format de votre feuille :</strong><br>
                    <table style="margin-top: 10px; max-width: 300px;">
                        <tr><th>ticker</th><th>prix</th></tr>
                        <tr><td>FR0013451333</td><td>87.37</td></tr>
                        <tr><td>AAPL</td><td>182.50</td></tr>
                    </table>
                </div>
                
                <div class="form-group" style="max-width: 600px; margin-top: 15px;">
                    <label>Google Sheet ID</label>
                    <input type="text" id="googleSheetId" placeholder="1A2B3C4D5E6F7G8H9I0J">
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <button onclick="saveGoogleSheetId()">üíæ Enregistrer l'ID</button>
                    <button onclick="syncPricesFromGoogleSheets()" class="btn-primary">üîÑ Synchroniser les prix</button>
                </div>
                
                <div style="margin-top: 15px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="autoSyncCheckbox" onchange="toggleAutoSync(this.checked)">
                        <span>üîÑ Synchronisation automatique (toutes les 5 minutes)</span>
                    </label>
                </div>
            </div>
            
            <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px;">
                <h3 style="margin-bottom: 15px;">üíæ Import / Export Local</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="exportData()" class="btn-secondary">üì• Exporter JSON</button>
                    <label class="btn-secondary" style="margin: 0; cursor: pointer;">
                        üì§ Importer JSON
                        <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                    </label>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Popular cryptocurrencies library
        const cryptoLibrary = [
            { symbol: 'BTC', name: 'Bitcoin' },
            { symbol: 'ETH', name: 'Ethereum' },
            { symbol: 'BNB', name: 'Binance Coin' },
            { symbol: 'SOL', name: 'Solana' },
            { symbol: 'XRP', name: 'Ripple' },
            { symbol: 'ADA', name: 'Cardano' },
            { symbol: 'AVAX', name: 'Avalanche' },
            { symbol: 'DOGE', name: 'Dogecoin' },
            { symbol: 'DOT', name: 'Polkadot' },
            { symbol: 'MATIC', name: 'Polygon' },
            { symbol: 'LINK', name: 'Chainlink' },
            { symbol: 'UNI', name: 'Uniswap' },
            { symbol: 'ATOM', name: 'Cosmos' },
            { symbol: 'LTC', name: 'Litecoin' },
            { symbol: 'NEAR', name: 'NEAR Protocol' },
            { symbol: 'APT', name: 'Aptos' },
            { symbol: 'ARB', name: 'Arbitrum' },
            { symbol: 'OP', name: 'Optimism' },
            { symbol: 'SUI', name: 'Sui' },
            { symbol: 'PEPE', name: 'Pepe' },
            { symbol: 'SHIB', name: 'Shiba Inu' },
            { symbol: 'TRX', name: 'TRON' },
            { symbol: 'BCH', name: 'Bitcoin Cash' },
            { symbol: 'XLM', name: 'Stellar' },
            { symbol: 'AAVE', name: 'Aave' },
            { symbol: 'CRV', name: 'Curve' },
            { symbol: 'MKR', name: 'Maker' },
            { symbol: 'SNX', name: 'Synthetix' },
            { symbol: 'FTM', name: 'Fantom' },
            { symbol: 'ALGO', name: 'Algorand' }
        ];

        let portfolio = {
            crypto: [],
            pea: [],
            fundraising: [],
            prices: {},
            priceTimestamps: {},
            binanceCredentials: null
        };

        let autoSyncInterval = null;
        let isGoogleDriveConnected = false;
        let accessToken = null;
        let tokenClient = null;
        let myChart = null;

        // Initialize crypto library display
        function initCryptoLibrary() {
            const container = document.getElementById('cryptoLibrary');
            container.innerHTML = cryptoLibrary.map(crypto => `
                <div class="crypto-chip" onclick="selectCrypto('${crypto.symbol}')">
                    <div class="crypto-chip-symbol">${crypto.symbol}</div>
                    <div class="crypto-chip-name">${crypto.name}</div>
                </div>
            `).join('');
        }

        function selectCrypto(symbol) {
            document.getElementById('cryptoSymbol').value = symbol;
            
            // Visual feedback
            document.querySelectorAll('.crypto-chip').forEach(chip => {
                chip.classList.remove('selected');
            });
            event.target.closest('.crypto-chip').classList.add('selected');
        }

        // Binance API functions
        function saveBinanceCredentials() {
            const apiKey = document.getElementById('binanceApiKey').value.trim();
            const apiSecret = document.getElementById('binanceApiSecret').value.trim();
            
            if (!apiKey || !apiSecret) {
                alert('‚ö†Ô∏è Veuillez remplir les deux champs (API Key et API Secret)');
                return;
            }
            
            portfolio.binanceCredentials = { apiKey, apiSecret };
            saveData();
            updateBinanceStatus();
            alert('‚úÖ Cl√©s API Binance sauvegard√©es avec succ√®s !');
        }

        function clearBinanceCredentials() {
            if (confirm('üóëÔ∏è √ätes-vous s√ªr de vouloir supprimer vos cl√©s API Binance ?')) {
                portfolio.binanceCredentials = null;
                document.getElementById('binanceApiKey').value = '';
                document.getElementById('binanceApiSecret').value = '';
                saveData();
                updateBinanceStatus();
                alert('‚úÖ Cl√©s API supprim√©es');
            }
        }

        function updateBinanceStatus() {
            const statusEl = document.getElementById('binanceStatus');
            if (portfolio.binanceCredentials) {
                statusEl.textContent = '‚úì Connect√©';
                statusEl.className = 'api-status connected';
                
                // Fill credentials fields
                document.getElementById('binanceApiKey').value = portfolio.binanceCredentials.apiKey;
                document.getElementById('binanceApiSecret').value = portfolio.binanceCredentials.apiSecret;
            } else {
                statusEl.textContent = 'Non connect√©';
                statusEl.className = 'api-status disconnected';
            }
        }

        async function importFromBinance() {
            if (!portfolio.binanceCredentials) {
                alert('‚ö†Ô∏è Veuillez d\'abord sauvegarder vos cl√©s API Binance');
                return;
            }

            try {
                const timestamp = Date.now();
                const { apiKey, apiSecret } = portfolio.binanceCredentials;
                
                // Create signature
                const queryString = `timestamp=${timestamp}`;
                const signature = await createHmacSignature(apiSecret, queryString);
                
                // Fetch account info from Binance
                const response = await fetch(`https://api.binance.com/api/v3/account?${queryString}&signature=${signature}`, {
                    headers: {
                        'X-MBX-APIKEY': apiKey
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erreur Binance: ${response.status} - ${await response.text()}`);
                }
                
                const data = await response.json();
                
                // Filter balances with value > 0
                const balances = data.balances.filter(b => parseFloat(b.free) > 0 || parseFloat(b.locked) > 0);
                
                if (balances.length === 0) {
                    alert('‚ÑπÔ∏è Aucune position trouv√©e sur votre compte Binance');
                    return;
                }
                
                // Add positions to portfolio
                let imported = 0;
                for (const balance of balances) {
                    const quantity = parseFloat(balance.free) + parseFloat(balance.locked);
                    
                    // Check if already exists
                    const existing = portfolio.crypto.find(c => c.symbol === balance.asset);
                    if (!existing) {
                        portfolio.crypto.push({
                            symbol: balance.asset,
                            quantity: quantity,
                            price: 0, // Will be updated with current price
                            date: new Date().toISOString().split('T')[0]
                        });
                        imported++;
                    }
                }
                
                saveData();
                await updateAll();
                
                alert(`‚úÖ ${imported} positions import√©es depuis Binance !\n\n‚ö†Ô∏è Les prix d'achat sont √† 0. Veuillez les modifier manuellement.`);
                
            } catch (error) {
                console.error('Erreur import Binance:', error);
                alert(`‚ùå Erreur lors de l'import depuis Binance:\n${error.message}\n\nV√©rifiez que vos cl√©s API sont correctes et que l'API est activ√©e sur Binance.`);
            }
        }

        async function createHmacSignature(secret, message) {
            const encoder = new TextEncoder();
            const keyData = encoder.encode(secret);
            const messageData = encoder.encode(message);
            
            const key = await crypto.subtle.importKey(
                'raw',
                keyData,
                { name: 'HMAC', hash: 'SHA-256' },
                false,
                ['sign']
            );
            
            const signature = await crypto.subtle.sign('HMAC', key, messageData);
            return Array.from(new Uint8Array(signature))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(section).classList.add('active');
        }

        function ensurePortfolioStructure() {
            if (!portfolio.crypto) portfolio.crypto = [];
            if (!portfolio.pea) portfolio.pea = [];
            if (!portfolio.livrets) portfolio.livrets = [];
            if (!portfolio.fundraising) portfolio.fundraising = [];
            if (!portfolio.prices) portfolio.prices = {};
            if (!portfolio.priceTimestamps) portfolio.priceTimestamps = {};
            if (!portfolio.binanceCredentials) portfolio.binanceCredentials = null;
        }

        function addCrypto() {
            const symbol = document.getElementById('cryptoSymbol').value.toUpperCase();
            const quantity = parseFloat(document.getElementById('cryptoQuantity').value);
            const price = parseFloat(document.getElementById('cryptoPrice').value);
            const date = document.getElementById('cryptoDate').value;

            if (!symbol || !quantity || !price || !date) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            portfolio.crypto.push({ symbol, quantity, price, date });
            saveData();
            syncDriveData();
            updateCryptoList();
            
            document.getElementById('cryptoSymbol').value = '';
            document.getElementById('cryptoQuantity').value = '';
            document.getElementById('cryptoPrice').value = '';
            
            // Remove selection
            document.querySelectorAll('.crypto-chip').forEach(chip => {
                chip.classList.remove('selected');
            });
        }

        function addPEA() {
            const name = document.getElementById('peaName').value;
            const ticker = document.getElementById('peaTicker').value.toUpperCase();
            const quantity = parseFloat(document.getElementById('peaQuantity').value);
            const price = parseFloat(document.getElementById('peaPrice').value);
            const fees = parseFloat(document.getElementById('peaFees').value) || 0;
            const date = document.getElementById('peaDate').value;

            if (!name || !ticker || !quantity || !price || !date) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }

            portfolio.pea.push({ name, ticker, quantity, price, fees, date });
            saveData();
            syncDriveData();
            updatePEAList();
            updatePEAQuickSelect(); // Update quick select buttons
            
            document.getElementById('peaName').value = '';
            document.getElementById('peaTicker').value = '';
            document.getElementById('peaQuantity').value = '';
            document.getElementById('peaPrice').value = '';
            document.getElementById('peaFees').value = '';
        }
        
        // Function to fill form with existing asset data
        function fillPEAForm(name, ticker) {
            document.getElementById('peaName').value = name;
            document.getElementById('peaTicker').value = ticker;
            document.getElementById('peaQuantity').focus();
        }
        
        // Function to update quick select buttons and autocomplete
        function updatePEAQuickSelect() {
            const container = document.getElementById('quickSelectPEA');
            if (!container) return;
            
            // Get unique assets (grouped by ticker)
            const uniqueAssets = {};
            portfolio.pea.forEach(item => {
                if (!uniqueAssets[item.ticker]) {
                    uniqueAssets[item.ticker] = {
                        name: item.name,
                        ticker: item.ticker
                    };
                }
            });
            
            // Update quick select buttons
            if (Object.keys(uniqueAssets).length === 0) {
                container.innerHTML = '<em style="color: #a0aec0;">Aucun actif existant</em>';
            } else {
                container.innerHTML = Object.values(uniqueAssets).map(asset => 
                    `<button class="quick-select-btn" onclick="fillPEAForm('${asset.name}', '${asset.ticker}')">
                        ${asset.name} (${asset.ticker})
                    </button>`
                ).join('');
            }
            
            // Update autocomplete datalists
            const nameList = document.getElementById('peaNameList');
            const tickerList = document.getElementById('peaTickerList');
            
            if (nameList && tickerList) {
                nameList.innerHTML = Object.values(uniqueAssets).map(asset => 
                    `<option value="${asset.name}">`
                ).join('');
                
                tickerList.innerHTML = Object.values(uniqueAssets).map(asset => 
                    `<option value="${asset.ticker}">`
                ).join('');
            }
        }
        
        // Auto-sync name and ticker when typing
        document.addEventListener('DOMContentLoaded', function() {
            const peaNameInput = document.getElementById('peaName');
            const peaTickerInput = document.getElementById('peaTicker');
            
            if (peaNameInput && peaTickerInput) {
                peaNameInput.addEventListener('input', function() {
                    // Find matching asset by name
                    const matchingAsset = portfolio.pea.find(item => 
                        item.name.toLowerCase() === this.value.toLowerCase()
                    );
                    if (matchingAsset) {
                        peaTickerInput.value = matchingAsset.ticker;
                    }
                });
                
                peaTickerInput.addEventListener('input', function() {
                    // Find matching asset by ticker
                    const matchingAsset = portfolio.pea.find(item => 
                        item.ticker.toUpperCase() === this.value.toUpperCase()
                    );
                    if (matchingAsset) {
                        peaNameInput.value = matchingAsset.name;
                    }
                });
            }
        });

        function addFundraising() {
            const name = document.getElementById('fundName').value;
            const amount = parseFloat(document.getElementById('fundAmount').value);
            const valuation = parseFloat(document.getElementById('fundValuation').value);
            const date = document.getElementById('fundDate').value;

            if (!name || !amount || !valuation || !date) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            if (isNaN(amount) || isNaN(valuation)) {
                alert('Montant et valuation doivent √™tre des nombres');
                return;
            }
            
            // Ensure portfolio structure exists
            ensurePortfolioStructure();
            
            portfolio.fundraising.push({ 
                name: name, 
                amount: amount, 
                valuation: valuation, 
                date: date 
            });
            
            console.log('‚úÖ Investissement ajout√©:', { name, amount, valuation, date });
            
            saveData();
            syncDriveData();
            updateFundraisingList();
            updateAll();
            
            // Clear form
            document.getElementById('fundName').value = '';
            document.getElementById('fundAmount').value = '';
            document.getElementById('fundValuation').value = '';
        }

        async function updatePrices() {
            const cryptoSymbols = [...new Set(portfolio.crypto.map(c => c.symbol))];
            const peaTickers = [...new Set(portfolio.pea.map(p => p.ticker))];
            
            for (const symbol of cryptoSymbols) {
                try {
                    const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${getCoinGeckoId(symbol)}&vs_currencies=usd`);
                    const data = await res.json();
                    const coinId = getCoinGeckoId(symbol);
                    if (data[coinId]) {
                        portfolio.prices[symbol] = data[coinId].usd;
                        portfolio.priceTimestamps[symbol] = Date.now();
                    }
                } catch (e) {
                    console.error(`Erreur prix ${symbol}:`, e);
                }
            }

            for (const ticker of peaTickers) {
                try {
                    const res = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1d`);
                    const data = await res.json();
                    if (data.chart.result[0]) {
                        const price = data.chart.result[0].meta.regularMarketPrice;
                        portfolio.prices[ticker] = price;
                        portfolio.priceTimestamps[ticker] = Date.now();
                    }
                } catch (e) {
                    console.error(`Erreur prix ${ticker}:`, e);
                }
            }
            
            saveData();
        }

        function getCoinGeckoId(symbol) {
            const map = {
                'BTC': 'bitcoin', 'ETH': 'ethereum', 'BNB': 'binancecoin',
                'SOL': 'solana', 'XRP': 'ripple', 'ADA': 'cardano',
                'AVAX': 'avalanche-2', 'DOGE': 'dogecoin', 'DOT': 'polkadot',
                'MATIC': 'matic-network', 'LINK': 'chainlink', 'UNI': 'uniswap',
                'ATOM': 'cosmos', 'LTC': 'litecoin', 'NEAR': 'near',
                'APT': 'aptos', 'ARB': 'arbitrum', 'OP': 'optimism',
                'SUI': 'sui', 'PEPE': 'pepe', 'SHIB': 'shiba-inu',
                'TRX': 'tron', 'BCH': 'bitcoin-cash', 'XLM': 'stellar',
                'AAVE': 'aave', 'CRV': 'curve-dao-token', 'MKR': 'maker',
                'SNX': 'synthetix-network-token', 'FTM': 'fantom', 'ALGO': 'algorand'
            };
            return map[symbol] || symbol.toLowerCase();
        }

        function updateCryptoList() {
            const grouped = {};
            portfolio.crypto.forEach(item => {
                if (!grouped[item.symbol]) grouped[item.symbol] = [];
                grouped[item.symbol].push(item);
            });

            const html = Object.entries(grouped).map(([symbol, items]) => {
                const totalQty = items.reduce((sum, i) => sum + i.quantity, 0);
                const avgPrice = items.reduce((sum, i) => sum + (i.price * i.quantity), 0) / totalQty;
                const currentPrice = portfolio.prices[symbol] || 0;
                const currentValue = totalQty * currentPrice;
                const invested = items.reduce((sum, i) => sum + (i.price * i.quantity), 0);
                const pnl = currentValue - invested;
                const pnlPercent = ((pnl / invested) * 100) || 0;

                const cryptoInfo = cryptoLibrary.find(c => c.symbol === symbol);
                const fullName = cryptoInfo ? cryptoInfo.name : symbol;

                return `
                    <div class="asset-group">
                        <div class="asset-header" onclick="toggleAsset('${symbol}')">
                            <div class="asset-header-left">
                                <span class="asset-toggle" id="toggle-${symbol}">‚ñ∂</span>
                                <div>
                                    <div class="asset-name">${fullName}</div>
                                    <div class="asset-ticker">${symbol}</div>
                                </div>
                            </div>
                            <div class="asset-stats">
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Quantit√©</div>
                                    <div class="asset-stat-value">${totalQty.toFixed(8)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Prix moyen</div>
                                    <div class="asset-stat-value">$${avgPrice.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Prix actuel</div>
                                    <div class="asset-stat-value">$${currentPrice.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Valeur</div>
                                    <div class="asset-stat-value">$${currentValue.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">P&L</div>
                                    <div class="asset-stat-value ${pnl >= 0 ? 'positive' : 'negative'}">
                                        ${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}
                                    </div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">P&L %</div>
                                    <div class="asset-stat-value ${pnlPercent >= 0 ? 'positive' : 'negative'}">
                                        ${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="asset-content" id="content-${symbol}">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Quantit√©</th>
                                        <th>Prix d'achat</th>
                                        <th>Valeur actuelle</th>
                                        <th>P&L</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${items.map((item, idx) => {
                                        const itemValue = item.quantity * currentPrice;
                                        const itemInvested = item.quantity * item.price;
                                        const itemPnl = itemValue - itemInvested;
                                        const itemPnlPercent = ((itemPnl / itemInvested) * 100) || 0;
                                        
                                        return `
                                            <tr>
                                                <td>${item.date}</td>
                                                <td>${item.quantity}</td>
                                                <td>$${item.price.toFixed(2)}</td>
                                                <td>$${itemValue.toFixed(2)}</td>
                                                <td class="${itemPnl >= 0 ? 'positive' : 'negative'}">
                                                    ${itemPnl >= 0 ? '+' : ''}$${itemPnl.toFixed(2)} (${itemPnlPercent.toFixed(2)}%)
                                                </td>
                                                <td>
                                                    <button onclick="editCrypto('${symbol}', ${portfolio.crypto.indexOf(item)})" class="btn-secondary">‚úèÔ∏è</button>
                                                    <button onclick="deleteCrypto(${portfolio.crypto.indexOf(item)})" class="btn-danger">üóëÔ∏è</button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('cryptoList').innerHTML = html;
        }

        function updatePEAList() {
            const grouped = {};
            portfolio.pea.forEach((item, index) => {
                if (!grouped[item.ticker]) {
                    grouped[item.ticker] = {
                        name: item.name || item.ticker,
                        ticker: item.ticker,
                        purchases: []
                    };
                }
                grouped[item.ticker].purchases.push({ ...item, originalIndex: index });
            });

            const html = Object.entries(grouped).map(([ticker, asset]) => {
                const totalQty = asset.purchases.reduce((sum, i) => sum + i.quantity, 0);
                const totalFees = asset.purchases.reduce((sum, i) => sum + (i.fees || 0), 0);
                const totalInvested = asset.purchases.reduce((sum, i) => sum + (i.price * i.quantity) + (i.fees || 0), 0);
                const avgPrice = totalQty > 0 ? totalInvested / totalQty : 0;
                const currentPrice = portfolio.prices[ticker] || avgPrice;
                const currentValue = totalQty * currentPrice;
                const pnl = currentValue - totalInvested;
                const pnlPercent = totalInvested > 0 ? (pnl / totalInvested) * 100 : 0;

                const lastUpdate = portfolio.priceTimestamps[ticker] 
                    ? new Date(portfolio.priceTimestamps[ticker]).toLocaleString('fr-FR')
                    : 'Jamais';

                return `
                    <div class="asset-group">
                        <div class="asset-header" onclick="toggleAsset('${ticker}')">
                            <div class="asset-header-left">
                                <span class="asset-toggle" id="toggle-${ticker}">‚ñ∂</span>
                                <div>
                                    <div class="asset-name">${asset.name}</div>
                                    <div class="asset-ticker">${ticker} ‚Ä¢ MAJ: ${lastUpdate}</div>
                                </div>
                            </div>
                            <div class="asset-stats">
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Quantit√©</div>
                                    <div class="asset-stat-value">${totalQty.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">PRU</div>
                                    <div class="asset-stat-value">‚Ç¨${avgPrice.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Prix actuel</div>
                                    <div class="asset-stat-value">‚Ç¨${currentPrice.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Valeur</div>
                                    <div class="asset-stat-value">‚Ç¨${currentValue.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">P&L</div>
                                    <div class="asset-stat-value ${pnl >= 0 ? 'positive' : 'negative'}">
                                        ${pnl >= 0 ? '+' : ''}‚Ç¨${pnl.toFixed(2)}
                                    </div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">P&L %</div>
                                    <div class="asset-stat-value ${pnlPercent >= 0 ? 'positive' : 'negative'}">
                                        ${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="asset-content" id="details-${ticker}" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 20px;">
                                <h4 style="margin: 0; color: #a0aec0;">üìä Historique des achats</h4>
                                <div style="flex: 1; max-width: 500px; height: 150px;">
                                    <canvas id="chart-${ticker}"></canvas>
                                </div>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Quantit√©</th>
                                        <th>Prix d'achat</th>
                                        <th>Frais</th>
                                        <th>Valeur actuelle</th>
                                        <th>P&L</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${asset.purchases.map((item) => {
                                        const itemValue = item.quantity * currentPrice;
                                        const itemInvested = item.quantity * item.price + (item.fees || 0);
                                        const itemPnl = itemValue - itemInvested;
                                        const itemPnlPercent = itemInvested > 0 ? ((itemPnl / itemInvested) * 100) : 0;
                                        
                                        return `
                                            <tr>
                                                <td>${new Date(item.date).toLocaleDateString('fr-FR')}</td>
                                                <td>${item.quantity.toFixed(2)}</td>
                                                <td>‚Ç¨${item.price.toFixed(2)}</td>
                                                <td>‚Ç¨${(item.fees || 0).toFixed(2)}</td>
                                                <td>‚Ç¨${itemValue.toFixed(2)}</td>
                                                <td class="${itemPnl >= 0 ? 'positive' : 'negative'}">
                                                    ${itemPnl >= 0 ? '+' : ''}‚Ç¨${itemPnl.toFixed(2)} (${itemPnlPercent.toFixed(2)}%)
                                                </td>
                                                <td>
                                                    <button onclick="editPEA('${ticker}', ${item.originalIndex})" class="btn-secondary">‚úèÔ∏è</button>
                                                    <button onclick="deletePEA(${item.originalIndex})" class="btn-danger">üóëÔ∏è</button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('peaList').innerHTML = html;
            
            // Create charts for each asset
            Object.entries(grouped).forEach(([ticker, asset]) => {
                const currentPrice = portfolio.prices[ticker] || 0;
                setTimeout(() => createAssetChart(ticker, asset.purchases, currentPrice), 100);
            });
        }

        function updateFundraisingList() {
            const container = document.getElementById('fundraisingList');
            if (!container) {
                console.error('Container fundraisingList not found');
                return;
            }
            
            if (!portfolio.fundraising || portfolio.fundraising.length === 0) {
                container.innerHTML = '<p style="color: #a0aec0; text-align: center; padding: 40px;">Aucun investissement enregistr√©.</p>';
                return;
            }
            
            const html = portfolio.fundraising.map((item, index) => {
                // V√©rification et conversion s√©curis√©e
                const amount = parseFloat(item.amount) || 0;
                const valuation = parseFloat(item.valuation) || 0;
                const date = item.date || 'N/A';
                const name = item.name || 'Sans nom';
                
                const equity = valuation > 0 ? (amount / valuation) * 100 : 0;
                
                return `
                    <div class="asset-group">
                        <div class="asset-header">
                            <div class="asset-header-left">
                                <div>
                                    <div class="asset-name">${name}</div>
                                    <div class="asset-ticker">${date}</div>
                                </div>
                            </div>
                            <div class="asset-stats">
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Investi</div>
                                    <div class="asset-stat-value">‚Ç¨${amount.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Valuation</div>
                                    <div class="asset-stat-value">‚Ç¨${valuation.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Part</div>
                                    <div class="asset-stat-value">${equity.toFixed(4)}%</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Actions</div>
                                    <div>
                                        <button onclick="editFundraising(${index})" class="btn-secondary">‚úèÔ∏è</button>
                                        <button onclick="deleteFundraising(${index})" class="btn-danger">üóëÔ∏è</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            container.innerHTML = html;
        }

        function createAssetChart(ticker, purchases, currentPrice) {
            const ctx = document.getElementById(`chart-${ticker}`);
            if (!ctx) return;
            
            // Sort purchases by date
            const sortedPurchases = [...purchases].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Calculate cumulative portfolio value over time
            const chartData = [];
            let cumulativeQuantity = 0;
            let cumulativeInvested = 0;
            
            sortedPurchases.forEach(p => {
                const fees = p.fees || 0;
                cumulativeQuantity += p.quantity;
                cumulativeInvested += (p.quantity * p.price) + fees;
                
                const avgPrice = cumulativeInvested / cumulativeQuantity;
                const currentValue = cumulativeQuantity * currentPrice;
                
                chartData.push({
                    date: new Date(p.date).toLocaleDateString('fr-FR'),
                    invested: cumulativeInvested,
                    value: currentValue,
                    quantity: cumulativeQuantity
                });
            });
            
            // Create chart
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(d => d.date),
                    datasets: [
                        {
                            label: 'Valeur actuelle',
                            data: chartData.map(d => d.value),
                            borderColor: '#00ff88',
                            backgroundColor: 'rgba(0, 255, 136, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Montant investi',
                            data: chartData.map(d => d.invested),
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#fff', font: { size: 10 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' ‚Ç¨';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#a0aec0' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#a0aec0' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function toggleAsset(ticker) {
            const content = document.getElementById(`content-${ticker}`);
            const details = document.getElementById(`details-${ticker}`);
            const toggle = document.getElementById(`toggle-${ticker}`);
            
            const targetElement = content || details;
            
            if (targetElement) {
                if (targetElement.classList.contains('expanded') || targetElement.style.display === 'block') {
                    targetElement.classList.remove('expanded');
                    targetElement.style.display = 'none';
                    if (toggle) toggle.classList.remove('expanded');
                } else {
                    targetElement.classList.add('expanded');
                    targetElement.style.display = 'block';
                    if (toggle) toggle.classList.add('expanded');
                }
            }
        }

        function editCrypto(symbol, index) {
            const item = portfolio.crypto[index];
            const newQuantity = prompt('Nouvelle quantit√©:', item.quantity);
            const newPrice = prompt('Nouveau prix:', item.price);
            
            if (newQuantity !== null && newPrice !== null) {
                portfolio.crypto[index].quantity = parseFloat(newQuantity);
                portfolio.crypto[index].price = parseFloat(newPrice);
                saveData();
                syncDriveData();
                updateCryptoList();
            }
        }

        function deleteCrypto(index) {
            if (confirm('Supprimer cette position ?')) {
                portfolio.crypto.splice(index, 1);
                saveData();
                syncDriveData();
                updateCryptoList();
            }
        }

        function editPEA(ticker, index) {
            const item = portfolio.pea[index];
            const newQuantity = prompt('Nouvelle quantit√©:', item.quantity);
            const newPrice = prompt('Nouveau prix:', item.price);
            const newFees = prompt('Nouveaux frais:', item.fees);
            
            if (newQuantity !== null && newPrice !== null && newFees !== null) {
                portfolio.pea[index].quantity = parseFloat(newQuantity);
                portfolio.pea[index].price = parseFloat(newPrice);
                portfolio.pea[index].fees = parseFloat(newFees);
                saveData();
                syncDriveData();
                updatePEAList();
            }
        }

        function deletePEA(index) {
            if (confirm('Supprimer cette position ?')) {
                portfolio.pea.splice(index, 1);
                saveData();
                syncDriveData();
                updatePEAList();
            }
        }

        function editFundraising(index) {
            const item = portfolio.fundraising[index];
            const newAmount = prompt('Nouveau montant investi:', item.amount);
            const newValuation = prompt('Nouvelle valuation:', item.valuation);
            
            if (newAmount !== null && newValuation !== null) {
                portfolio.fundraising[index].amount = parseFloat(newAmount);
                portfolio.fundraising[index].valuation = parseFloat(newValuation);
                saveData();
                syncDriveData();
                updateFundraisingList();
            }
        }

        function deleteFundraising(index) {
            if (confirm('Supprimer cet investissement ?')) {
                portfolio.fundraising.splice(index, 1);
                saveData();
                syncDriveData();
                updateFundraisingList();
                updateAll();
            }
        }

        // ========================================
        // LIVRETS D'√âPARGNE FUNCTIONS
        // ========================================
        
        function addLivret() {
            const type = document.getElementById('livretType').value;
            const bank = document.getElementById('livretBank').value;
            const amount = parseFloat(document.getElementById('livretAmount').value);
            const rate = parseFloat(document.getElementById('livretRate').value);
            const ceiling = parseFloat(document.getElementById('livretCeiling').value) || null;
            const date = document.getElementById('livretDate').value;

            if (!type || !bank || !amount || !rate || !date) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            if (isNaN(amount) || isNaN(rate)) {
                alert('Montant et taux doivent √™tre des nombres');
                return;
            }

            ensurePortfolioStructure();
            
            portfolio.livrets.push({ 
                type, 
                bank, 
                amount, 
                rate, 
                ceiling,
                date 
            });
            
            console.log('‚úÖ Livret ajout√©:', { type, bank, amount, rate, ceiling, date });
            
            saveData();
            syncDriveData();
            updateLivretsList();
            updateAll();
            
            // Clear form
            document.getElementById('livretType').value = '';
            document.getElementById('livretBank').value = '';
            document.getElementById('livretAmount').value = '';
            document.getElementById('livretRate').value = '';
            document.getElementById('livretCeiling').value = '';
        }
        
        function autoFillLivretRate() {
            const type = document.getElementById('livretType').value;
            const rateInput = document.getElementById('livretRate');
            const ceilingInput = document.getElementById('livretCeiling');
            
            const livretData = {
                'LEP': { rate: 4.00, ceiling: 10000 },
                'Livret A': { rate: 2.40, ceiling: 22950 },
                'LDDS': { rate: 2.40, ceiling: 12000 },
                'Livret Jeune': { rate: 2.40, ceiling: 1600 },
                'PEL': { rate: 2.25, ceiling: 61200 },
                'CEL': { rate: 2.00, ceiling: 15300 },
                'CSL': { rate: 0.50, ceiling: null }
            };
            
            if (type && livretData[type]) {
                rateInput.value = livretData[type].rate;
                if (livretData[type].ceiling) {
                    ceilingInput.value = livretData[type].ceiling;
                }
                alert(`‚úÖ Taux et plafond appliqu√©s pour ${type}`);
            } else {
                alert('‚ö†Ô∏è S√©lectionnez d\'abord un type de livret');
            }
        }
        
        function updateLivretsList() {
            const container = document.getElementById('livretsList');
            if (!container) {
                console.error('Container livretsList not found');
                return;
            }
            
            if (!portfolio.livrets || portfolio.livrets.length === 0) {
                container.innerHTML = '<p style="color: #a0aec0; text-align: center; padding: 40px;">Aucun livret enregistr√©.</p>';
                return;
            }
            
            let totalLivrets = 0;
            let totalInterestPerYear = 0;
            
            const html = portfolio.livrets.map((item, index) => {
                const amount = parseFloat(item.amount) || 0;
                const rate = parseFloat(item.rate) || 0;
                const ceiling = parseFloat(item.ceiling) || null;
                const bank = item.bank || 'N/A';
                const type = item.type || 'Autre';
                const date = item.date || 'N/A';
                
                const interestPerYear = (amount * rate) / 100;
                const remaining = ceiling ? Math.max(0, ceiling - amount) : null;
                const fillPercentage = ceiling ? (amount / ceiling) * 100 : null;
                
                totalLivrets += amount;
                totalInterestPerYear += interestPerYear;
                
                return `
                    <div class="asset-group">
                        <div class="asset-header">
                            <div class="asset-header-left">
                                <div>
                                    <div class="asset-name">${type}</div>
                                    <div class="asset-ticker">${bank} ‚Ä¢ Ouvert le ${new Date(date).toLocaleDateString('fr-FR')}</div>
                                </div>
                            </div>
                            <div class="asset-stats">
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Montant</div>
                                    <div class="asset-stat-value">‚Ç¨${amount.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Taux</div>
                                    <div class="asset-stat-value">${rate.toFixed(2)}%</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Int√©r√™ts/an</div>
                                    <div class="asset-stat-value positive">‚Ç¨${interestPerYear.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Plafond</div>
                                    <div class="asset-stat-value">${ceiling ? '‚Ç¨' + ceiling.toLocaleString('fr-FR') : 'Aucun'}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Restant</div>
                                    <div class="asset-stat-value">${remaining !== null ? '‚Ç¨' + remaining.toLocaleString('fr-FR') : '-'}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Actions</div>
                                    <div>
                                        <button onclick="editLivret(${index})" class="btn-secondary">‚úèÔ∏è</button>
                                        <button onclick="deleteLivret(${index})" class="btn-danger">üóëÔ∏è</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ${fillPercentage !== null ? `
                        <div style="padding: 10px 20px;">
                            <div style="background: rgba(0,0,0,0.3); height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #00ff88, #00cc6a); height: 100%; width: ${fillPercentage}%; transition: width 0.3s;"></div>
                            </div>
                            <p style="text-align: center; margin-top: 5px; font-size: 0.85em; color: #a0aec0;">
                                ${fillPercentage.toFixed(1)}% du plafond atteint
                            </p>
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            const summary = `
                <div class="info-message" style="margin-bottom: 20px;">
                    <strong>üìä R√©capitulatif :</strong><br>
                    Total √©pargn√© : <strong>‚Ç¨${totalLivrets.toLocaleString('fr-FR', {minimumFractionDigits: 2})}</strong><br>
                    Int√©r√™ts annuels estim√©s : <strong class="positive">‚Ç¨${totalInterestPerYear.toFixed(2)}</strong><br>
                    Int√©r√™ts mensuels estim√©s : <strong class="positive">‚Ç¨${(totalInterestPerYear / 12).toFixed(2)}</strong>
                </div>
            `;
            
            container.innerHTML = summary + html;
        }
        
        function editLivret(index) {
            const livret = portfolio.livrets[index];
            if (!livret) return;
            
            document.getElementById('livretType').value = livret.type;
            document.getElementById('livretBank').value = livret.bank;
            document.getElementById('livretAmount').value = livret.amount;
            document.getElementById('livretRate').value = livret.rate;
            document.getElementById('livretCeiling').value = livret.ceiling || '';
            document.getElementById('livretDate').value = livret.date;
            
            // Delete old entry
            portfolio.livrets.splice(index, 1);
            updateLivretsList();
        }
        
        function deleteLivret(index) {
            if (confirm('Supprimer ce livret ?')) {
                portfolio.livrets.splice(index, 1);
                saveData();
                syncDriveData();
                updateLivretsList();
                updateAll();
            }
        }

        function updateDashboard() {
            let totalValue = 0;
            let totalInvested = 0;

            // Crypto calculations
            portfolio.crypto.forEach(c => {
                const currentPrice = portfolio.prices[c.symbol] || 0;
                totalValue += c.quantity * currentPrice;
                totalInvested += c.quantity * c.price;
            });

            // PEA calculations
            const peaByTicker = {};
            portfolio.pea.forEach(p => {
                const fees = p.fees || 0;
                if (!peaByTicker[p.ticker]) {
                    peaByTicker[p.ticker] = { quantity: 0, invested: 0 };
                }
                peaByTicker[p.ticker].quantity += p.quantity;
                peaByTicker[p.ticker].invested += (p.quantity * p.price) + fees;
            });

            Object.entries(peaByTicker).forEach(([ticker, data]) => {
                const avgPrice = data.invested / data.quantity;
                const currentPrice = portfolio.prices[ticker] || avgPrice;
                totalValue += data.quantity * currentPrice;
                totalInvested += data.invested;
            });

            // Livrets calculations (both invested and value are the same)
            portfolio.livrets.forEach(l => {
                const amount = parseFloat(l.amount) || 0;
                totalValue += amount;
                totalInvested += amount;
            });

            // Fundraising calculations
            portfolio.fundraising.forEach(f => {
                totalValue += f.valuation;
                totalInvested += f.amount;
            });

            const totalPnL = totalValue - totalInvested;
            const totalPerf = totalInvested > 0 ? (totalPnL / totalInvested) * 100 : 0;

            const html = `
                <div class="stat-card">
                    <div class="stat-label">üí∞ Valeur Totale</div>
                    <div class="stat-value">‚Ç¨${totalValue.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìä Total Investi</div>
                    <div class="stat-value">‚Ç¨${totalInvested.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìà P&L Global</div>
                    <div class="stat-value ${totalPnL >= 0 ? 'positive' : 'negative'}">
                        ${totalPnL >= 0 ? '+' : ''}‚Ç¨${totalPnL.toFixed(2)}
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìä P&L %</div>
                    <div class="stat-value ${totalPerf >= 0 ? 'positive' : 'negative'}">
                        ${totalPerf >= 0 ? '+' : ''}${totalPerf.toFixed(2)}%
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">‚Çø Crypto</div>
                    <div class="stat-value">‚Ç¨${portfolio.crypto.reduce((sum, c) => sum + (c.quantity * (portfolio.prices[c.symbol] || 0)), 0).toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìä PEA</div>
                    <div class="stat-value">‚Ç¨${Object.entries(peaByTicker).reduce((sum, [ticker, data]) => {
                        const avgPrice = data.invested / data.quantity;
                        const currentPrice = portfolio.prices[ticker] || avgPrice;
                        return sum + (data.quantity * currentPrice);
                    }, 0).toFixed(2)}</div>
                </div>
            `;

            document.getElementById('dashboardStats').innerHTML = html;
            updateChart(peaByTicker);
        }

        function updateChart(peaByTicker) {
            const ctx = document.getElementById('portfolioChart');
            if (!ctx) return;
            
            let cryptoValue = 0;
            let peaValue = 0;
            let fundraisingValue = 0;

            portfolio.crypto.forEach(c => {
                const currentPrice = portfolio.prices[c.symbol] || 0;
                cryptoValue += c.quantity * currentPrice;
            });

            Object.entries(peaByTicker).forEach(([ticker, data]) => {
                const avgPrice = data.invested / data.quantity;
                const currentPrice = portfolio.prices[ticker] || avgPrice;
                peaValue += data.quantity * currentPrice;
            });

            portfolio.fundraising.forEach(f => {
                fundraisingValue += f.valuation;
            });

            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Crypto', 'PEA', 'Lev√©es'],
                    datasets: [{
                        data: [cryptoValue, peaValue, fundraisingValue],
                        backgroundColor: [
                            'rgba(0, 255, 136, 0.8)',
                            'rgba(52, 152, 219, 0.8)',
                            'rgba(243, 186, 47, 0.8)'
                        ],
                        borderColor: [
                            'rgba(0, 255, 136, 1)',
                            'rgba(52, 152, 219, 1)',
                            'rgba(243, 186, 47, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff', font: { size: 14 } }
                        }
                    }
                }
            });
        }

        async function updateAll() {
            await updatePrices();
            updateCryptoList();
            updatePEAList();
            updatePEAQuickSelect(); // Update quick select buttons
            updateLivretsList(); // Update livrets
            updateFundraisingList();
            updateDashboard();
            document.getElementById('syncStatus').textContent = '‚úÖ Synchronis√©';
            document.getElementById('syncStatus').classList.add('synced');
        }

        async function exportToGoogleSheets() {
            const sheetId = document.getElementById('googleSheetId').value.trim();
            if (!sheetId) {
                alert('Veuillez entrer l\'ID de votre Google Sheet');
                return;
            }

            localStorage.setItem('googleSheetId', sheetId);
            alert('‚ö†Ô∏è Cette fonction n√©cessite une authentification Google Sheets API. Utilisez plut√¥t la synchronisation depuis Google Sheets vers l\'application.');
        }

        function saveGoogleSheetId() {
            const id = document.getElementById('googleSheetId').value.trim();
            if (id) {
                localStorage.setItem('googleSheetId', id);
                alert('‚úÖ Google Sheet ID enregistr√©');
            }
        }

        async function syncPricesFromGoogleSheets() {
            const sheetId = localStorage.getItem('googleSheetId');
            if (!sheetId) {
                alert('‚ö†Ô∏è Veuillez d\'abord enregistrer l\'ID de votre Google Sheet');
                showSection('settings');
                return;
            }

            try {
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=0`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: V√©rifiez que la feuille est publique`);
                }
                
                const csvText = await response.text();
                const lines = csvText.split('\n');
                
                let count = 0;
                ensurePortfolioStructure();
                
                // Skip header line
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // Parse CSV handling quotes and decimal commas
                    const parts = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            parts.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    parts.push(current.trim());
                    
                    const ticker = parts[0]?.replace(/"/g, '');
                    const priceStr = parts[1]?.replace(/"/g, '');
                    
                    if (ticker && priceStr) {
                        // Handle both point and comma as decimal separator
                        const price = parseFloat(priceStr.replace(',', '.'));
                        if (!isNaN(price) && price > 0) {
                            portfolio.prices[ticker.toUpperCase()] = price;
                            portfolio.priceTimestamps[ticker.toUpperCase()] = Date.now();
                            count++;
                            console.log(`‚úÖ ${ticker}: ${price}‚Ç¨`);
                        }
                    }
                }
                
                if (count > 0) {
                    saveData();
                    updateAll();
                    alert(`‚úÖ ${count} prix synchronis√©s depuis Google Sheets !`);
                } else {
                    alert('‚ö†Ô∏è Aucun prix trouv√©. V√©rifiez le format de votre feuille.');
                }
                
            } catch (error) {
                console.error('Erreur:', error);
                alert(`‚ùå Erreur: ${error.message}\n\nV√©rifiez que :\n1. La feuille est publi√©e sur le Web\n2. L'ID est correct\n3. Le format est : ticker,prix`);
            }
        }

        function toggleAutoSync(isEnabled) {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
                autoSyncInterval = null;
            }
            
            if (isEnabled) {
                syncPricesFromGoogleSheets(); // Immediate sync
                autoSyncInterval = setInterval(() => {
                    console.log('üîÑ Auto-sync Google Sheets...');
                    syncPricesFromGoogleSheets();
                }, 5 * 60 * 1000); // Every 5 minutes
                localStorage.setItem('autoSyncEnabled', 'true');
                console.log('‚úÖ Auto-sync activ√© (5 min)');
            } else {
                localStorage.setItem('autoSyncEnabled', 'false');
                console.log('‚ùå Auto-sync d√©sactiv√©');
            }
        }

        // Google Drive Functions
        function saveClientId() {
            const id = document.getElementById('clientId').value.trim();
            if (id) {
                localStorage.setItem('googleClientId', id);
                alert('‚úÖ Client ID enregistr√©');
                initGoogleDrive();
            }
        }

        function initGoogleDrive() {
            const id = localStorage.getItem('googleClientId');
            if (!id) return;
            try {
                if (typeof google === 'undefined' || !google.accounts) {
                    setTimeout(initGoogleDrive, 1000);
                    return;
                }
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: id,
                    scope: 'https://www.googleapis.com/auth/drive.file',
                    callback: (r) => {
                        if (r.error) {
                            alert('‚ùå ' + r.error);
                            return;
                        }
                        accessToken = r.access_token;
                        isGoogleDriveConnected = true;
                        document.getElementById('syncStatus').textContent = '‚úì Synchronis√©';
                        document.getElementById('syncStatus').classList.add('synced');
                        loadFromDrive();
                    }
                });
            } catch (e) {
                console.error(e);
            }
        }

        function connectGoogleDrive() {
            if (!localStorage.getItem('googleClientId')) {
                alert('‚ö†Ô∏è Entrez le Client ID');
                showSection('settings');
                return;
            }
            if (!tokenClient) {
                initGoogleDrive();
                setTimeout(() => { if (tokenClient) tokenClient.requestAccessToken(); }, 1000);
            } else {
                tokenClient.requestAccessToken();
            }
        }

        function disconnectGoogleDrive() {
            if (accessToken) google.accounts.oauth2.revoke(accessToken);
            accessToken = null;
            isGoogleDriveConnected = false;
            localStorage.removeItem('portfolioFileId');
            document.getElementById('syncStatus').textContent = '‚è≥ Non synchronis√©';
            document.getElementById('syncStatus').classList.remove('synced');
        }

        async function syncDriveData() {
            if (!isGoogleDriveConnected || !accessToken) {
                console.log('‚ö†Ô∏è Google Drive non connect√©, sauvegarde ignor√©e');
                return;
            }
            try {
                const fid = localStorage.getItem('portfolioFileId');
                const data = JSON.stringify(portfolio, null, 2);
                if (fid) {
                    const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fid}?uploadType=media`, {
                        method: 'PATCH',
                        headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                        body: data
                    });
                    if (response.ok) {
                        console.log('‚úÖ Sauvegard√© sur Google Drive');
                    } else {
                        throw new Error('Erreur HTTP: ' + response.status);
                    }
                } else {
                    const meta = { name: 'portfolio.json', mimeType: 'application/json' };
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(meta)], { type: 'application/json' }));
                    form.append('file', new Blob([data], { type: 'application/json' }));
                    const r = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${accessToken}` },
                        body: form
                    });
                    if (r.ok) {
                        const res = await r.json();
                        localStorage.setItem('portfolioFileId', res.id);
                        console.log('‚úÖ Fichier cr√©√© sur Google Drive:', res.id);
                    } else {
                        throw new Error('Erreur cr√©ation: ' + r.status);
                    }
                }
            } catch (e) {
                console.error('‚ùå Erreur sauvegarde Drive:', e);
                alert('‚ùå Erreur lors de la sauvegarde sur Google Drive:\n' + e.message);
            }
        }

        async function loadFromDrive() {
            if (!isGoogleDriveConnected || !accessToken) {
                alert('‚ö†Ô∏è Veuillez d\'abord vous connecter √† Google Drive');
                return;
            }
            try {
                let fid = localStorage.getItem('portfolioFileId');
                if (!fid) {
                    const r = await fetch('https://www.googleapis.com/drive/v3/files?q=name%3D%27portfolio.json%27', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    const d = await r.json();
                    if (d.files && d.files.length > 0) {
                        fid = d.files[0].id;
                        localStorage.setItem('portfolioFileId', fid);
                    } else {
                        alert('‚ö†Ô∏è Aucun fichier portfolio.json trouv√© sur Google Drive');
                        return;
                    }
                }
                const r = await fetch(`https://www.googleapis.com/drive/v3/files/${fid}?alt=media`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (r.ok) {
                    const importedData = await r.json();
                    portfolio = {
                        crypto: importedData.crypto || [],
                        pea: importedData.pea || [],
                        fundraising: importedData.fundraising || [],
                        prices: importedData.prices || {},
                        priceTimestamps: importedData.priceTimestamps || {},
                        binanceCredentials: importedData.binanceCredentials || null
                    };
                    
                    portfolio.pea = portfolio.pea.map(p => ({
                        name: p.name || '',
                        ticker: p.ticker || '',
                        quantity: p.quantity || 0,
                        price: p.price || 0,
                        fees: p.fees || 0,
                        date: p.date || new Date().toISOString().split('T')[0]
                    }));
                    
                    ensurePortfolioStructure();
                    saveData();
                    updateAll();
                    updateBinanceStatus();
                    alert(`‚úÖ Donn√©es charg√©es depuis Google Drive!\n\nPEA: ${portfolio.pea.length} lignes\nCrypto: ${portfolio.crypto.length} lignes\nLev√©es: ${portfolio.fundraising.length} lignes`);
                } else {
                    alert('‚ùå Erreur lors du chargement: ' + r.status);
                }
            } catch (e) {
                console.error('Erreur Drive:', e);
                alert('‚ùå Erreur: ' + e.message);
            }
        }

        function saveData() {
            localStorage.setItem('portfolioData', JSON.stringify(portfolio));
        }

        function loadData() {
            const saved = localStorage.getItem('portfolioData');
            if (saved) {
                try {
                    portfolio = JSON.parse(saved);
                    ensurePortfolioStructure();
                } catch (e) {
                    console.error('Erreur chargement:', e);
                    portfolio = { crypto: [], pea: [], fundraising: [], prices: {}, priceTimestamps: {}, binanceCredentials: null };
                }
            }
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(portfolio, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `portfolio_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function importData(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const importedData = JSON.parse(ev.target.result);
                        portfolio = {
                            crypto: importedData.crypto || [],
                            pea: importedData.pea || [],
                            fundraising: importedData.fundraising || [],
                            prices: importedData.prices || {},
                            priceTimestamps: importedData.priceTimestamps || {},
                            binanceCredentials: importedData.binanceCredentials || null
                        };
                        
                        portfolio.pea = portfolio.pea.map(p => ({
                            name: p.name || '',
                            ticker: p.ticker || '',
                            quantity: p.quantity || 0,
                            price: p.price || 0,
                            fees: p.fees || 0,
                            date: p.date || new Date().toISOString().split('T')[0]
                        }));
                        
                        ensurePortfolioStructure();
                        saveData();
                        syncDriveData();
                        updateAll();
                        updateBinanceStatus();
                        alert(`‚úÖ Import√© avec succ√®s!\n\nPEA: ${portfolio.pea.length} lignes\nCrypto: ${portfolio.crypto.length} lignes\nLev√©es: ${portfolio.fundraising.length} lignes`);
                    } catch (err) {
                        console.error('Erreur import:', err);
                        alert(`‚ùå Erreur lors de l'import:\n${err.message}\n\nV√©rifiez que le fichier est un JSON valide.`);
                    }
                };
                reader.readAsText(file);
            }
        }

        // Init
        ensurePortfolioStructure();
        loadData();
        initCryptoLibrary();
        updateBinanceStatus();
        updateAll();
        initGoogleDrive();
        document.getElementById('cryptoDate').valueAsDate = new Date();
        document.getElementById('peaDate').valueAsDate = new Date();
        document.getElementById('livretDate').valueAsDate = new Date();
        document.getElementById('fundDate').valueAsDate = new Date();
        
        const savedSheetId = localStorage.getItem('googleSheetId');
        if (savedSheetId) {
            document.getElementById('googleSheetId').value = savedSheetId;
        }
        
        // Restore Client ID
        const savedClientId = localStorage.getItem('googleClientId');
        if (savedClientId) {
            document.getElementById('clientId').value = savedClientId;
        }
        
        const autoSyncEnabled = localStorage.getItem('autoSyncEnabled') === 'true';
        document.getElementById('autoSyncCheckbox').checked = autoSyncEnabled;
        if (autoSyncEnabled) {
            toggleAutoSync(true);
        }
    </script>
</body>
</html>
