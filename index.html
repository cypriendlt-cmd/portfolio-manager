<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Manager - Gestion Financi√®re</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 100%);
            color: #ffffff;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            color: #00ff88;
            font-size: clamp(1.5em, 5vw, 2.5em);
        }

        .sync-status {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .sync-status.synced {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        nav {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #1a1f2e;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 0.9em;
            flex: 1 1 auto;
            min-width: 120px;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            display: none;
        }

        .section.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(0, 204, 106, 0.1) 100%);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .stat-label {
            font-size: 0.9em;
            color: #a0aec0;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #00ff88;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 8px;
            color: #a0aec0;
            font-size: 0.9em;
        }

        input, select {
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
            border-radius: 8px;
            font-size: 1em;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #00ff88;
        }

        button {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #1a1f2e;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4757 0%, #cc3847 100%);
            color: #ffffff;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: #1a1f2e;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(0, 255, 136, 0.1);
            color: #00ff88;
            font-weight: bold;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 30px 0;
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
        }

        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .market-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .market-label {
            color: #a0aec0;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .market-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #00ff88;
        }

        .positive {
            color: #00ff88;
        }

        .negative {
            color: #ff4757;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 100%);
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            color: #00ff88;
            font-size: 1.5em;
        }

        .close-btn {
            background: none;
            color: #ff4757;
            font-size: 1.5em;
            padding: 0;
            width: 30px;
            height: 30px;
            cursor: pointer;
        }

        /* Crypto library styles */
        .crypto-library {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .crypto-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .crypto-item:hover {
            background: rgba(0, 255, 136, 0.1);
            border-color: #00ff88;
            transform: translateY(-2px);
        }

        .crypto-icon {
            font-size: 2em;
            margin-bottom: 8px;
        }

        .crypto-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .crypto-symbol {
            font-size: 0.8em;
            color: #a0aec0;
        }

        /* News section */
        .news-section {
            margin-top: 30px;
        }

        .news-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .news-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #00ff88;
            transition: all 0.3s;
        }

        .news-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        .news-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #00ff88;
            font-size: 1.1em;
        }

        .news-description {
            color: #a0aec0;
            font-size: 0.9em;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .news-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #718096;
            margin-top: 10px;
        }

        .news-source {
            font-weight: bold;
        }

        .news-date {
            font-style: italic;
        }

        .action-btns {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .icon-btn {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .search-box {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .crypto-library {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .news-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üíº Portfolio Manager</h1>
            <div class="sync-status" id="syncStatus">Non synchronis√©</div>
        </header>

        <nav>
            <button class="nav-btn" onclick="showSection('dashboard')">Dashboard</button>
            <button class="nav-btn" onclick="showSection('crypto')">Crypto</button>
            <button class="nav-btn" onclick="showSection('pea')">PEA / Actions</button>
            <button class="nav-btn" onclick="showSection('fundraising')">Lev√©e de Fonds</button>
            <button class="nav-btn" onclick="showSection('markets')">March√©s</button>
            <button class="nav-btn" onclick="showSection('settings')">Param√®tres</button>
        </nav>

        <!-- Dashboard -->
        <div id="dashboard" class="section active">
            <h2>üìä Vue d'ensemble</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Valeur Totale</div>
                    <div class="stat-value" id="totalValue">0 ‚Ç¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Investissement</div>
                    <div class="stat-value" id="totalInvestment">0 ‚Ç¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">P&L Total</div>
                    <div class="stat-value" id="totalPnL">0 ‚Ç¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Performance</div>
                    <div class="stat-value" id="totalPerformance">0%</div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="portfolioChart"></canvas>
            </div>

            <h3>üìà Comparaison Portfolio vs Actif</h3>
            <div class="form-group" style="max-width: 300px; margin: 20px 0;">
                <label>Comparer avec :</label>
                <select id="compareAsset" onchange="updateComparisonChart()">
                    <option value="bitcoin">Bitcoin (BTC)</option>
                    <option value="ethereum">Ethereum (ETH)</option>
                    <option value="sp500">S&P 500</option>
                    <option value="nasdaq">NASDAQ</option>
                </select>
            </div>
            <div class="chart-container">
                <canvas id="comparisonChart"></canvas>
            </div>

            <!-- News Section -->
            <div class="news-section">
                <h3>üì∞ Actualit√©s des March√©s</h3>
                
                <h4 style="color: #00ff88; margin-top: 20px;">Crypto</h4>
                <div class="news-grid" id="cryptoNews"></div>

                <h4 style="color: #3b82f6; margin-top: 30px;">Bourse</h4>
                <div class="news-grid" id="stockNews"></div>
            </div>
        </div>

        <!-- Crypto Section -->
        <div id="crypto" class="section">
            <h2>üíé Gestion Crypto</h2>
            
            <button onclick="openCryptoLibrary()" style="margin-bottom: 20px;">üìö Choisir depuis la biblioth√®que</button>
            
            <form id="cryptoForm" onsubmit="addCryptoPosition(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nom du Token</label>
                        <input type="text" id="cryptoName" required>
                    </div>
                    <div class="form-group">
                        <label>Symbol (ID CoinGecko)</label>
                        <input type="text" id="cryptoSymbol" required>
                    </div>
                    <div class="form-group">
                        <label>Quantit√©</label>
                        <input type="number" step="any" id="cryptoQuantity" required>
                    </div>
                    <div class="form-group">
                        <label>Prix d'Achat (‚Ç¨)</label>
                        <input type="number" step="any" id="cryptoPrice" required>
                    </div>
                    <div class="form-group">
                        <label>Date d'Achat</label>
                        <input type="date" id="cryptoDate" required>
                    </div>
                </div>
                <input type="hidden" id="cryptoEditId" value="">
                <button type="submit" id="cryptoSubmitBtn">Ajouter Position</button>
                <button type="button" class="btn-secondary" onclick="cancelEdit('crypto')" id="cryptoCancelBtn" style="display: none;">Annuler</button>
            </form>

            <table id="cryptoTable">
                <thead>
                    <tr>
                        <th>Token</th>
                        <th>Quantit√©</th>
                        <th>Prix d'Entr√©e</th>
                        <th>Prix Actuel</th>
                        <th>Valeur</th>
                        <th>P&L</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="cryptoTableBody"></tbody>
            </table>
        </div>

        <!-- PEA Section -->
        <div id="pea" class="section">
            <h2>üìà PEA / Actions</h2>
            
            <form id="peaForm" onsubmit="addPEAPosition(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nom</label>
                        <input type="text" id="peaName" required>
                    </div>
                    <div class="form-group">
                        <label>Ticker</label>
                        <input type="text" id="peaTicker" required>
                    </div>
                    <div class="form-group">
                        <label>Quantit√©</label>
                        <input type="number" step="any" id="peaQuantity" required>
                    </div>
                    <div class="form-group">
                        <label>Prix d'Achat (‚Ç¨)</label>
                        <input type="number" step="any" id="peaPrice" required>
                    </div>
                    <div class="form-group">
                        <label>Date d'Achat</label>
                        <input type="date" id="peaDate" required>
                    </div>
                </div>
                <input type="hidden" id="peaEditId" value="">
                <button type="submit" id="peaSubmitBtn">Ajouter Position</button>
                <button type="button" class="btn-secondary" onclick="cancelEdit('pea')" id="peaCancelBtn" style="display: none;">Annuler</button>
            </form>

            <table id="peaTable">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Quantit√©</th>
                        <th>Prix d'Entr√©e</th>
                        <th>Prix Actuel</th>
                        <th>Valeur</th>
                        <th>P&L</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="peaTableBody"></tbody>
            </table>
        </div>

        <!-- Fundraising Section -->
        <div id="fundraising" class="section">
            <h2>üöÄ Lev√©es de Fonds</h2>
            
            <form id="fundraisingForm" onsubmit="addFundraisingPosition(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Startup</label>
                        <input type="text" id="fundName" required>
                    </div>
                    <div class="form-group">
                        <label>Montant Investi (‚Ç¨)</label>
                        <input type="number" step="any" id="fundAmount" required>
                    </div>
                    <div class="form-group">
                        <label>Valorisation (‚Ç¨)</label>
                        <input type="number" step="any" id="fundValuation">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="fundDate" required>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <input type="text" id="fundNotes">
                    </div>
                </div>
                <input type="hidden" id="fundEditId" value="">
                <button type="submit" id="fundSubmitBtn">Ajouter Investissement</button>
                <button type="button" class="btn-secondary" onclick="cancelEdit('fundraising')" id="fundCancelBtn" style="display: none;">Annuler</button>
            </form>

            <table id="fundraisingTable">
                <thead>
                    <tr>
                        <th>Startup</th>
                        <th>Montant</th>
                        <th>Valorisation</th>
                        <th>Date</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="fundraisingTableBody"></tbody>
            </table>
        </div>

        <!-- Markets Section -->
        <div id="markets" class="section">
            <h2>üìä Indicateurs des March√©s</h2>
            
            <h3>Crypto</h3>
            <div class="market-grid">
                <div class="market-card">
                    <div class="market-label">Bitcoin</div>
                    <div class="market-value" id="btcPrice">-</div>
                </div>
                <div class="market-card">
                    <div class="market-label">Ethereum</div>
                    <div class="market-value" id="ethPrice">-</div>
                </div>
                <div class="market-card">
                    <div class="market-label">BTC Dominance</div>
                    <div class="market-value" id="btcDominance">-</div>
                </div>
                <div class="market-card">
                    <div class="market-label">Market Cap</div>
                    <div class="market-value" id="totalMarketCap">-</div>
                </div>
            </div>

            <h3 style="margin-top: 20px;">Boursiers</h3>
            <div class="market-grid">
                <div class="market-card">
                    <div class="market-label">S&P 500</div>
                    <div class="market-value" id="sp500">-</div>
                </div>
                <div class="market-card">
                    <div class="market-label">Dow Jones</div>
                    <div class="market-value" id="dowJones">-</div>
                </div>
                <div class="market-card">
                    <div class="market-label">NASDAQ</div>
                    <div class="market-value" id="nasdaq">-</div>
                </div>
                <div class="market-card">
                    <div class="market-label">CAC 40</div>
                    <div class="market-value" id="cac40">-</div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="section">
            <h2>‚öôÔ∏è Param√®tres</h2>
            
            <h3>Google Drive Sync</h3>
            <div class="form-group" style="max-width: 600px;">
                <label>Client ID Google</label>
                <input type="text" id="clientId" placeholder="votre-client-id.apps.googleusercontent.com">
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="saveClientId()">Enregistrer Client ID</button>
                <button class="btn-secondary" onclick="connectGoogleDrive()">Se connecter</button>
                <button class="btn-danger" onclick="disconnectGoogleDrive()">D√©connecter</button>
            </div>

            <h3 style="margin-top: 30px;">Export / Import</h3>
            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="exportData()">üì• Exporter JSON</button>
                <button class="btn-secondary" onclick="document.getElementById('importFile').click()">üì§ Importer JSON</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
            </div>
        </div>
    </div>

    <!-- Crypto Library Modal -->
    <div id="cryptoLibraryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üìö Biblioth√®que de Cryptomonnaies</h3>
                <button class="close-btn" onclick="closeCryptoLibrary()">√ó</button>
            </div>
            <input type="text" id="cryptoSearch" class="search-box" placeholder="Rechercher une crypto..." onkeyup="filterCryptoLibrary()">
            <div class="crypto-library" id="cryptoLibrary"></div>
        </div>
    </div>

    <script>
        let portfolio = { crypto: [], pea: [], fundraising: [] };
        let priceCache = {};
        let charts = { portfolio: null, comparison: null };
        let isGoogleDriveConnected = false;
        let accessToken = null;
        let tokenClient = null;
        let isSyncing = false;

        // Biblioth√®que de cryptomonnaies populaires
        const cryptoLibrary = [
            { name: 'Bitcoin', symbol: 'bitcoin', icon: '‚Çø' },
            { name: 'Ethereum', symbol: 'ethereum', icon: 'Œû' },
            { name: 'Tether', symbol: 'tether', icon: '‚ÇÆ' },
            { name: 'BNB', symbol: 'binancecoin', icon: '‚¨°' },
            { name: 'Solana', symbol: 'solana', icon: '‚óé' },
            { name: 'XRP', symbol: 'ripple', icon: '‚úï' },
            { name: 'USD Coin', symbol: 'usd-coin', icon: '$' },
            { name: 'Cardano', symbol: 'cardano', icon: '‚Ç≥' },
            { name: 'Dogecoin', symbol: 'dogecoin', icon: '√ê' },
            { name: 'TRON', symbol: 'tron', icon: '‚ÇÆ' },
            { name: 'Avalanche', symbol: 'avalanche-2', icon: '‚ñ≤' },
            { name: 'Polkadot', symbol: 'polkadot', icon: '‚óè' },
            { name: 'Polygon', symbol: 'matic-network', icon: '‚¨£' },
            { name: 'Litecoin', symbol: 'litecoin', icon: '≈Å' },
            { name: 'Chainlink', symbol: 'chainlink', icon: '‚¨¢' },
            { name: 'Uniswap', symbol: 'uniswap', icon: 'ü¶Ñ' },
            { name: 'Stellar', symbol: 'stellar', icon: '*' },
            { name: 'Monero', symbol: 'monero', icon: '…±' },
            { name: 'Bitcoin Cash', symbol: 'bitcoin-cash', icon: '‡∏ø' },
            { name: 'Cosmos', symbol: 'cosmos', icon: '‚öõ' },
            { name: 'Near Protocol', symbol: 'near', icon: '‚ìÉ' },
            { name: 'VeChain', symbol: 'vechain', icon: 'V' },
            { name: 'Algorand', symbol: 'algorand', icon: 'A' },
            { name: 'ApeCoin', symbol: 'apecoin', icon: 'ü¶ç' },
            { name: 'The Graph', symbol: 'the-graph', icon: 'G' },
            { name: 'Sandbox', symbol: 'the-sandbox', icon: 'üèñ' },
            { name: 'Decentraland', symbol: 'decentraland', icon: 'üèõ' },
            { name: 'Tezos', symbol: 'tezos', icon: 'Íú©' },
            { name: 'Aave', symbol: 'aave', icon: 'üëª' },
            { name: 'Shiba Inu', symbol: 'shiba-inu', icon: 'üêï' }
        ];

        window.addEventListener('load', () => {
            loadData();
            updateDashboard();
            updateCryptoTable();
            updatePEATable();
            updateFundraisingTable();
            updateMarketIndicators();
            loadNews();
            renderCryptoLibrary();
            
            const savedClientId = localStorage.getItem('googleClientId');
            if (savedClientId) {
                document.getElementById('clientId').value = savedClientId;
            }

            // Update news daily
            const lastNewsUpdate = localStorage.getItem('lastNewsUpdate');
            const today = new Date().toDateString();
            if (lastNewsUpdate !== today) {
                loadNews();
                localStorage.setItem('lastNewsUpdate', today);
            }
        });

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            
            if (sectionId === 'dashboard') {
                updateDashboard();
                updateComparisonChart();
            }
        }

        // Crypto Library Functions
        function openCryptoLibrary() {
            document.getElementById('cryptoLibraryModal').classList.add('active');
        }

        function closeCryptoLibrary() {
            document.getElementById('cryptoLibraryModal').classList.remove('active');
        }

        function renderCryptoLibrary() {
            const container = document.getElementById('cryptoLibrary');
            container.innerHTML = cryptoLibrary.map(crypto => `
                <div class="crypto-item" onclick="selectCrypto('${crypto.name}', '${crypto.symbol}')">
                    <div class="crypto-icon">${crypto.icon}</div>
                    <div class="crypto-name">${crypto.name}</div>
                    <div class="crypto-symbol">${crypto.symbol}</div>
                </div>
            `).join('');
        }

        function filterCryptoLibrary() {
            const search = document.getElementById('cryptoSearch').value.toLowerCase();
            const items = document.querySelectorAll('.crypto-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(search) ? 'block' : 'none';
            });
        }

        function selectCrypto(name, symbol) {
            document.getElementById('cryptoName').value = name;
            document.getElementById('cryptoSymbol').value = symbol;
            closeCryptoLibrary();
            document.getElementById('cryptoQuantity').focus();
        }

        // CRUD Functions for Crypto
        function addCryptoPosition(event) {
            event.preventDefault();
            
            const editId = document.getElementById('cryptoEditId').value;
            const position = {
                id: editId || Date.now(),
                name: document.getElementById('cryptoName').value,
                symbol: document.getElementById('cryptoSymbol').value.toLowerCase(),
                quantity: parseFloat(document.getElementById('cryptoQuantity').value),
                entryPrice: parseFloat(document.getElementById('cryptoPrice').value),
                date: document.getElementById('cryptoDate').value
            };
            
            if (editId) {
                // Update existing
                const index = portfolio.crypto.findIndex(p => p.id == editId);
                if (index !== -1) {
                    portfolio.crypto[index] = position;
                }
            } else {
                // Add new
                portfolio.crypto.push(position);
            }
            
            saveData();
            syncData();
            updateCryptoTable();
            updateDashboard();
            document.getElementById('cryptoForm').reset();
            cancelEdit('crypto');
        }

        function editCrypto(id) {
            const position = portfolio.crypto.find(p => p.id === id);
            if (!position) return;
            
            document.getElementById('cryptoName').value = position.name;
            document.getElementById('cryptoSymbol').value = position.symbol;
            document.getElementById('cryptoQuantity').value = position.quantity;
            document.getElementById('cryptoPrice').value = position.entryPrice;
            document.getElementById('cryptoDate').value = position.date;
            document.getElementById('cryptoEditId').value = position.id;
            
            document.getElementById('cryptoSubmitBtn').textContent = 'Modifier Position';
            document.getElementById('cryptoCancelBtn').style.display = 'inline-block';
            
            showSection('crypto');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteCrypto(id) {
            if (!confirm('Supprimer cette position ?')) return;
            
            portfolio.crypto = portfolio.crypto.filter(p => p.id !== id);
            saveData();
            syncData();
            updateCryptoTable();
            updateDashboard();
        }

        function cancelEdit(type) {
            if (type === 'crypto') {
                document.getElementById('cryptoForm').reset();
                document.getElementById('cryptoEditId').value = '';
                document.getElementById('cryptoSubmitBtn').textContent = 'Ajouter Position';
                document.getElementById('cryptoCancelBtn').style.display = 'none';
            } else if (type === 'pea') {
                document.getElementById('peaForm').reset();
                document.getElementById('peaEditId').value = '';
                document.getElementById('peaSubmitBtn').textContent = 'Ajouter Position';
                document.getElementById('peaCancelBtn').style.display = 'none';
            } else if (type === 'fundraising') {
                document.getElementById('fundraisingForm').reset();
                document.getElementById('fundEditId').value = '';
                document.getElementById('fundSubmitBtn').textContent = 'Ajouter Investissement';
                document.getElementById('fundCancelBtn').style.display = 'none';
            }
        }

        async function updateCryptoTable() {
            const tbody = document.getElementById('cryptoTableBody');
            tbody.innerHTML = '';
            
            for (const position of portfolio.crypto) {
                const currentPrice = await getCryptoPrice(position.symbol);
                const currentValue = position.quantity * currentPrice;
                const invested = position.quantity * position.entryPrice;
                const pnl = currentValue - invested;
                const pnlPercent = ((pnl / invested) * 100).toFixed(2);
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${position.name}</strong></td>
                    <td>${position.quantity.toFixed(6)}</td>
                    <td>${position.entryPrice.toFixed(2)} ‚Ç¨</td>
                    <td>${currentPrice.toFixed(2)} ‚Ç¨</td>
                    <td><strong>${currentValue.toFixed(2)} ‚Ç¨</strong></td>
                    <td class="${pnl >= 0 ? 'positive' : 'negative'}">
                        ${pnl >= 0 ? '‚ñ≤' : '‚ñº'} ${pnl.toFixed(2)} ‚Ç¨ (${pnlPercent}%)
                    </td>
                    <td>${formatDate(position.date)}</td>
                    <td>
                        <div class="action-btns">
                            <button class="icon-btn btn-warning" onclick="editCrypto(${position.id})">‚úèÔ∏è</button>
                            <button class="icon-btn btn-danger" onclick="deleteCrypto(${position.id})">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
            }
        }

        // PEA Functions
        function addPEAPosition(event) {
            event.preventDefault();
            
            const editId = document.getElementById('peaEditId').value;
            const position = {
                id: editId || Date.now(),
                name: document.getElementById('peaName').value,
                ticker: document.getElementById('peaTicker').value.toUpperCase(),
                quantity: parseFloat(document.getElementById('peaQuantity').value),
                entryPrice: parseFloat(document.getElementById('peaPrice').value),
                date: document.getElementById('peaDate').value
            };
            
            if (editId) {
                const index = portfolio.pea.findIndex(p => p.id == editId);
                if (index !== -1) {
                    portfolio.pea[index] = position;
                }
            } else {
                portfolio.pea.push(position);
            }
            
            saveData();
            syncData();
            updatePEATable();
            updateDashboard();
            document.getElementById('peaForm').reset();
            cancelEdit('pea');
        }

        function editPEA(id) {
            const position = portfolio.pea.find(p => p.id === id);
            if (!position) return;
            
            document.getElementById('peaName').value = position.name;
            document.getElementById('peaTicker').value = position.ticker;
            document.getElementById('peaQuantity').value = position.quantity;
            document.getElementById('peaPrice').value = position.entryPrice;
            document.getElementById('peaDate').value = position.date;
            document.getElementById('peaEditId').value = position.id;
            
            document.getElementById('peaSubmitBtn').textContent = 'Modifier Position';
            document.getElementById('peaCancelBtn').style.display = 'inline-block';
            
            showSection('pea');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deletePEA(id) {
            if (!confirm('Supprimer cette position ?')) return;
            
            portfolio.pea = portfolio.pea.filter(p => p.id !== id);
            saveData();
            syncData();
            updatePEATable();
            updateDashboard();
        }

        async function updatePEATable() {
            const tbody = document.getElementById('peaTableBody');
            tbody.innerHTML = '';
            
            for (const position of portfolio.pea) {
                const currentPrice = await getStockPrice(position.ticker);
                const currentValue = position.quantity * currentPrice;
                const invested = position.quantity * position.entryPrice;
                const pnl = currentValue - invested;
                const pnlPercent = ((pnl / invested) * 100).toFixed(2);
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${position.name}</strong></td>
                    <td>${position.quantity.toFixed(2)}</td>
                    <td>${position.entryPrice.toFixed(2)} ‚Ç¨</td>
                    <td>${currentPrice.toFixed(2)} ‚Ç¨</td>
                    <td><strong>${currentValue.toFixed(2)} ‚Ç¨</strong></td>
                    <td class="${pnl >= 0 ? 'positive' : 'negative'}">
                        ${pnl >= 0 ? '‚ñ≤' : '‚ñº'} ${pnl.toFixed(2)} ‚Ç¨ (${pnlPercent}%)
                    </td>
                    <td>${formatDate(position.date)}</td>
                    <td>
                        <div class="action-btns">
                            <button class="icon-btn btn-warning" onclick="editPEA(${position.id})">‚úèÔ∏è</button>
                            <button class="icon-btn btn-danger" onclick="deletePEA(${position.id})">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
            }
        }

        // Fundraising Functions
        function addFundraisingPosition(event) {
            event.preventDefault();
            
            const editId = document.getElementById('fundEditId').value;
            const position = {
                id: editId || Date.now(),
                name: document.getElementById('fundName').value,
                amount: parseFloat(document.getElementById('fundAmount').value),
                valuation: parseFloat(document.getElementById('fundValuation').value) || 0,
                date: document.getElementById('fundDate').value,
                notes: document.getElementById('fundNotes').value
            };
            
            if (editId) {
                const index = portfolio.fundraising.findIndex(p => p.id == editId);
                if (index !== -1) {
                    portfolio.fundraising[index] = position;
                }
            } else {
                portfolio.fundraising.push(position);
            }
            
            saveData();
            syncData();
            updateFundraisingTable();
            updateDashboard();
            document.getElementById('fundraisingForm').reset();
            cancelEdit('fundraising');
        }

        function editFundraising(id) {
            const position = portfolio.fundraising.find(p => p.id === id);
            if (!position) return;
            
            document.getElementById('fundName').value = position.name;
            document.getElementById('fundAmount').value = position.amount;
            document.getElementById('fundValuation').value = position.valuation;
            document.getElementById('fundDate').value = position.date;
            document.getElementById('fundNotes').value = position.notes;
            document.getElementById('fundEditId').value = position.id;
            
            document.getElementById('fundSubmitBtn').textContent = 'Modifier Investissement';
            document.getElementById('fundCancelBtn').style.display = 'inline-block';
            
            showSection('fundraising');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteFundraising(id) {
            if (!confirm('Supprimer cet investissement ?')) return;
            
            portfolio.fundraising = portfolio.fundraising.filter(p => p.id !== id);
            saveData();
            syncData();
            updateFundraisingTable();
            updateDashboard();
        }

        function updateFundraisingTable() {
            const tbody = document.getElementById('fundraisingTableBody');
            tbody.innerHTML = '';
            
            portfolio.fundraising.forEach(position => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${position.name}</strong></td>
                    <td>${position.amount.toFixed(2)} ‚Ç¨</td>
                    <td>${position.valuation.toFixed(0)} ‚Ç¨</td>
                    <td>${formatDate(position.date)}</td>
                    <td>${position.notes}</td>
                    <td>
                        <div class="action-btns">
                            <button class="icon-btn btn-warning" onclick="editFundraising(${position.id})">‚úèÔ∏è</button>
                            <button class="icon-btn btn-danger" onclick="deleteFundraising(${position.id})">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
            });
        }

        // Dashboard Updates
        async function updateDashboard() {
            let totalValue = 0;
            let totalInvestment = 0;
            
            for (const position of portfolio.crypto) {
                const currentPrice = await getCryptoPrice(position.symbol);
                const currentValue = position.quantity * currentPrice;
                const invested = position.quantity * position.entryPrice;
                
                totalValue += currentValue;
                totalInvestment += invested;
            }
            
            for (const position of portfolio.pea) {
                const currentPrice = await getStockPrice(position.ticker);
                const currentValue = position.quantity * currentPrice;
                const invested = position.quantity * position.entryPrice;
                
                totalValue += currentValue;
                totalInvestment += invested;
            }
            
            portfolio.fundraising.forEach(position => {
                totalInvestment += position.amount;
                totalValue += position.amount; // For simplicity, assuming same value
            });
            
            const totalPnL = totalValue - totalInvestment;
            const totalPerformance = totalInvestment > 0 ? ((totalPnL / totalInvestment) * 100).toFixed(2) : 0;
            
            document.getElementById('totalValue').textContent = `${totalValue.toFixed(2)} ‚Ç¨`;
            document.getElementById('totalInvestment').textContent = `${totalInvestment.toFixed(2)} ‚Ç¨`;
            document.getElementById('totalPnL').textContent = `${totalPnL.toFixed(2)} ‚Ç¨`;
            document.getElementById('totalPnL').className = totalPnL >= 0 ? 'stat-value positive' : 'stat-value negative';
            document.getElementById('totalPerformance').textContent = `${totalPerformance}%`;
            document.getElementById('totalPerformance').className = totalPnL >= 0 ? 'stat-value positive' : 'stat-value negative';
            
            updatePortfolioChart();
        }

        function updatePortfolioChart() {
            const ctx = document.getElementById('portfolioChart');
            
            if (charts.portfolio) {
                charts.portfolio.destroy();
            }
            
            let cryptoValue = 0;
            let peaValue = 0;
            let fundValue = 0;
            
            portfolio.crypto.forEach(p => {
                const price = priceCache[p.symbol] || p.entryPrice;
                cryptoValue += p.quantity * price;
            });
            
            portfolio.pea.forEach(p => {
                const price = priceCache[p.ticker] || p.entryPrice;
                peaValue += p.quantity * price;
            });
            
            portfolio.fundraising.forEach(p => {
                fundValue += p.amount;
            });
            
            charts.portfolio = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Crypto', 'PEA/Actions', 'Lev√©es de Fonds'],
                    datasets: [{
                        data: [cryptoValue, peaValue, fundValue],
                        backgroundColor: ['#00ff88', '#3b82f6', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#ffffff', padding: 20, font: { size: 14 } }
                        }
                    }
                }
            });
        }

        async function updateComparisonChart() {
            const ctx = document.getElementById('comparisonChart');
            const compareAsset = document.getElementById('compareAsset').value;
            
            if (charts.comparison) {
                charts.comparison.destroy();
            }
            
            // Generate last 30 days of data
            const days = 30;
            const labels = [];
            const portfolioData = [];
            const compareData = [];
            
            // Get current portfolio value
            let currentPortfolioValue = 0;
            for (const p of portfolio.crypto) {
                const price = await getCryptoPrice(p.symbol);
                currentPortfolioValue += p.quantity * price;
            }
            for (const p of portfolio.pea) {
                const price = await getStockPrice(p.ticker);
                currentPortfolioValue += p.quantity * price;
            }
            portfolio.fundraising.forEach(p => currentPortfolioValue += p.amount);
            
            // Simulate historical data (in production, use real historical data)
            for (let i = days; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('fr-FR', { month: 'short', day: 'numeric' }));
                
                // Simulate portfolio growth with some volatility
                const portfolioGrowth = 100 + (Math.random() - 0.5) * 20 - (i / days) * 5;
                portfolioData.push(portfolioGrowth);
                
                // Simulate comparison asset with different pattern
                const assetGrowth = 100 + (Math.random() - 0.5) * 15 - (i / days) * 3;
                compareData.push(assetGrowth);
            }
            
            const assetNames = {
                'bitcoin': 'Bitcoin',
                'ethereum': 'Ethereum',
                'sp500': 'S&P 500',
                'nasdaq': 'NASDAQ'
            };
            
            charts.comparison = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Mon Portfolio',
                            data: portfolioData,
                            borderColor: '#00ff88',
                            backgroundColor: 'rgba(0, 255, 136, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: assetNames[compareAsset],
                            data: compareData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff', font: { size: 14 } }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#a0aec0' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#a0aec0' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        // Market Indicators
        async function updateMarketIndicators() {
            try {
                const btcData = await getCryptoPrice('bitcoin');
                const ethData = await getCryptoPrice('ethereum');
                
                document.getElementById('btcPrice').textContent = `$${btcData.toFixed(0)}`;
                document.getElementById('ethPrice').textContent = `$${ethData.toFixed(0)}`;
                document.getElementById('btcDominance').textContent = '54.2%';
                document.getElementById('totalMarketCap').textContent = '$2.4T';
            } catch (e) {
                console.error('Error fetching market data:', e);
            }
            
            // Mock stock market data
            document.getElementById('sp500').textContent = '5,825';
            document.getElementById('dowJones').textContent = '42,350';
            document.getElementById('nasdaq').textContent = '18,450';
            document.getElementById('cac40').textContent = '7,680';
        }

        // News Functions
        async function loadNews() {
            loadCryptoNews();
            loadStockNews();
        }

        function loadCryptoNews() {
            // Mock crypto news data (in production, use a real API like CoinGecko or CryptoPanic)
            const cryptoNews = [
                {
                    title: "Bitcoin atteint un nouveau sommet historique",
                    description: "Le prix du Bitcoin a franchi la barre des 100 000 $ pour la premi√®re fois de son histoire, port√© par l'adoption institutionnelle croissante.",
                    source: "CoinDesk",
                    date: "Aujourd'hui"
                },
                {
                    title: "Ethereum 2.0 : Mise √† jour majeure r√©ussie",
                    description: "La derni√®re mise √† jour d'Ethereum am√©liore consid√©rablement la scalabilit√© et r√©duit les frais de transaction de 60%.",
                    source: "CoinTelegraph",
                    date: "Il y a 2h"
                },
                {
                    title: "Les ETF Bitcoin continuent d'attirer les flux",
                    description: "Plus de 2 milliards de dollars ont √©t√© investis dans les ETF Bitcoin au cours de la derni√®re semaine.",
                    source: "Bloomberg Crypto",
                    date: "Hier"
                },
                {
                    title: "Solana lance sa plateforme DeFi am√©lior√©e",
                    description: "La nouvelle version promet des transactions encore plus rapides et des frais quasi inexistants pour les utilisateurs.",
                    source: "Decrypt",
                    date: "Il y a 5h"
                }
            ];
            
            const container = document.getElementById('cryptoNews');
            container.innerHTML = cryptoNews.map(news => `
                <div class="news-card">
                    <div class="news-title">${news.title}</div>
                    <div class="news-description">${news.description}</div>
                    <div class="news-meta">
                        <span class="news-source">${news.source}</span>
                        <span class="news-date">${news.date}</span>
                    </div>
                </div>
            `).join('');
        }

        function loadStockNews() {
            // Mock stock market news (in production, use APIs like Alpha Vantage, NewsAPI, or Yahoo Finance)
            const stockNews = [
                {
                    title: "Le S&P 500 cl√¥ture en hausse de 1,2%",
                    description: "Les march√©s am√©ricains terminent la s√©ance sur une note positive, soutenus par de bons r√©sultats d'entreprises technologiques.",
                    source: "Reuters",
                    date: "Aujourd'hui"
                },
                {
                    title: "La Fed maintient ses taux directeurs",
                    description: "La R√©serve f√©d√©rale a d√©cid√© de maintenir ses taux d'int√©r√™t, signalant une approche prudente face √† l'inflation.",
                    source: "Wall Street Journal",
                    date: "Il y a 3h"
                },
                {
                    title: "Le CAC 40 d√©passe les 7 700 points",
                    description: "L'indice parisien profite de l'optimisme des investisseurs et des bons chiffres de l'√©conomie europ√©enne.",
                    source: "Les √âchos",
                    date: "Hier"
                },
                {
                    title: "Les valeurs technologiques en forte demande",
                    description: "Le NASDAQ enregistre sa meilleure semaine depuis six mois gr√¢ce aux performances des g√©ants de la tech.",
                    source: "Financial Times",
                    date: "Il y a 6h"
                }
            ];
            
            const container = document.getElementById('stockNews');
            container.innerHTML = stockNews.map(news => `
                <div class="news-card">
                    <div class="news-title">${news.title}</div>
                    <div class="news-description">${news.description}</div>
                    <div class="news-meta">
                        <span class="news-source">${news.source}</span>
                        <span class="news-date">${news.date}</span>
                    </div>
                </div>
            `).join('');
        }

        // API Functions
        async function getCryptoPrice(symbol) {
            if (priceCache[symbol] && Date.now() - priceCache[symbol].timestamp < 300000) {
                return priceCache[symbol].price;
            }
            
            try {
                const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${symbol}&vs_currencies=eur`);
                const data = await response.json();
                const price = data[symbol]?.eur || 0;
                
                priceCache[symbol] = { price, timestamp: Date.now() };
                return price;
            } catch (error) {
                console.error('Error fetching crypto price:', error);
                return 0;
            }
        }

        async function getStockPrice(ticker) {
            if (priceCache[ticker] && Date.now() - priceCache[ticker].timestamp < 300000) {
                return priceCache[ticker].price;
            }
            
            // Mock stock prices (in production, use a real API like Alpha Vantage or Yahoo Finance)
            const mockPrice = Math.random() * 200 + 50;
            priceCache[ticker] = { price: mockPrice, timestamp: Date.now() };
            return mockPrice;
        }

        // Google Drive Functions
        function saveClientId() {
            const clientId = document.getElementById('clientId').value.trim();
            if (clientId) {
                localStorage.setItem('googleClientId', clientId);
                alert('‚úÖ Client ID enregistr√© !');
                initGoogleDrive();
            } else {
                alert('‚ö†Ô∏è Client ID invalide');
            }
        }

        function initGoogleDrive() {
            const clientId = localStorage.getItem('googleClientId');
            if (!clientId) return;

            try {
                if (typeof google === 'undefined' || !google.accounts) {
                    setTimeout(initGoogleDrive, 1000);
                    return;
                }

                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: clientId,
                    scope: 'https://www.googleapis.com/auth/drive.file',
                    callback: (response) => {
                        if (response.error) {
                            alert('‚ùå Erreur : ' + response.error);
                            return;
                        }
                        accessToken = response.access_token;
                        isGoogleDriveConnected = true;
                        updateSyncStatus(true);
                        loadFromDrive();
                    },
                });
            } catch (error) {
                console.error('Erreur init:', error);
            }
        }

        function connectGoogleDrive() {
            const clientId = localStorage.getItem('googleClientId');
            if (!clientId) {
                alert('‚ö†Ô∏è Enregistrez d\'abord le Client ID');
                showSection('settings');
                return;
            }

            if (!tokenClient) {
                initGoogleDrive();
                setTimeout(() => {
                    if (tokenClient) tokenClient.requestAccessToken();
                }, 1000);
            } else {
                tokenClient.requestAccessToken();
            }
        }

        function disconnectGoogleDrive() {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken);
            }
            accessToken = null;
            isGoogleDriveConnected = false;
            localStorage.removeItem('portfolioFileId');
            updateSyncStatus(false);
            alert('‚úÖ D√©connect√©');
        }

        function updateSyncStatus(connected) {
            const status = document.getElementById('syncStatus');
            if (connected) {
                status.textContent = '‚úì Synchronis√©';
                status.classList.add('synced');
            } else {
                status.textContent = 'Non synchronis√©';
                status.classList.remove('synced');
            }
        }

        async function syncData() {
            if (!isGoogleDriveConnected || !accessToken || isSyncing) return;

            isSyncing = true;
            try {
                const fileId = localStorage.getItem('portfolioFileId');
                const dataStr = JSON.stringify(portfolio, null, 2);

                if (fileId) {
                    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: dataStr
                    });
                } else {
                    const metadata = { name: 'portfolio-data.json', mimeType: 'application/json' };
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', new Blob([dataStr], { type: 'application/json' }));

                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${accessToken}` },
                        body: form
                    });

                    if (response.ok) {
                        const result = await response.json();
                        localStorage.setItem('portfolioFileId', result.id);
                    }
                }
            } catch (error) {
                console.error('Erreur sync:', error);
            } finally {
                isSyncing = false;
            }
        }

        async function loadFromDrive() {
            if (!isGoogleDriveConnected || !accessToken) return;

            try {
                let fileId = localStorage.getItem('portfolioFileId');
                
                if (!fileId) {
                    const response = await fetch('https://www.googleapis.com/drive/v3/files?q=name%3D%27portfolio-data.json%27', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    const data = await response.json();
                    if (data.files && data.files.length > 0) {
                        fileId = data.files[0].id;
                        localStorage.setItem('portfolioFileId', fileId);
                    } else {
                        return;
                    }
                }

                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    portfolio = data;
                    saveData();
                    updateDashboard();
                    updateCryptoTable();
                    updatePEATable();
                    updateFundraisingTable();
                    alert('‚úÖ Donn√©es charg√©es depuis Google Drive');
                }
            } catch (error) {
                console.error('Erreur loadFromDrive:', error);
            }
        }

        // Local Storage
        function saveData() {
            localStorage.setItem('portfolioData', JSON.stringify(portfolio));
        }

        function loadData() {
            const saved = localStorage.getItem('portfolioData');
            if (saved) {
                portfolio = JSON.parse(saved);
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(portfolio, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `portfolio_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        portfolio = JSON.parse(e.target.result);
                        saveData();
                        syncData();
                        updateDashboard();
                        updateCryptoTable();
                        updatePEATable();
                        updateFundraisingTable();
                        alert('‚úÖ Donn√©es import√©es avec succ√®s !');
                    } catch (error) {
                        alert('‚ùå Erreur lors de l\'importation');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Utility Functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            });
        }
    </script>
</body>
</html>
