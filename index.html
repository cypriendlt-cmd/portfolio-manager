<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Manager - Finary Design</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --orange-primary: #ff6347;
            --orange-light: #ff7f66;
            --orange-dark: #e84a3a;
            --bg-main: #0b0f1a;
            --bg-secondary: #13182a;
            --bg-card: #1a2036;
            --text-primary: #ffffff;
            --text-secondary: #8892a6;
            --border-subtle: rgba(255, 255, 255, 0.06);
            --success: #00d4aa;
            --danger: #ff4757;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        /* Sidebar Navigation - Finary Style */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-subtle);
            padding: 32px 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        
        .logo {
            font-size: 1.8em;
            font-weight: 900;
            background: linear-gradient(135deg, var(--orange-primary), var(--orange-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 48px;
            letter-spacing: -1px;
        }
        
        .nav-menu {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .nav-item {
            padding: 14px 20px;
            border-radius: 12px;
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background: rgba(255, 99, 71, 0.08);
            color: var(--text-primary);
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, var(--orange-primary), var(--orange-dark));
            color: white;
            box-shadow: 0 4px 16px rgba(255, 99, 71, 0.3);
        }
        
        .nav-item .icon {
            font-size: 1.3em;
        }
        
        /* Main Content Area */
        .main-content {
            margin-left: 260px;
            min-height: 100vh;
            padding: 40px 48px;
        }
        
        /* Top Header */
        .top-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }
        
        .page-title {
            font-size: 2.2em;
            font-weight: 800;
            letter-spacing: -1.5px;
        }
        
        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .sync-badge {
            padding: 8px 20px;
            background: rgba(0, 212, 170, 0.12);
            border: 1px solid rgba(0, 212, 170, 0.2);
            border-radius: 20px;
            color: var(--success);
            font-size: 0.85em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-refresh {
            padding: 10px 24px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-refresh:hover {
            background: var(--bg-secondary);
            border-color: var(--orange-primary);
        }
        
        /* Wealth Summary - Large Card */
        .wealth-summary {
            background: linear-gradient(135deg, var(--orange-primary) 0%, var(--orange-dark) 100%);
            border-radius: 24px;
            padding: 48px;
            margin-bottom: 32px;
            box-shadow: 0 8px 32px rgba(255, 99, 71, 0.25);
            position: relative;
            overflow: hidden;
        }
        
        .wealth-summary::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            border-radius: 50%;
        }
        
        .wealth-label {
            font-size: 0.95em;
            opacity: 0.9;
            margin-bottom: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .wealth-amount {
            font-size: 4em;
            font-weight: 900;
            letter-spacing: -3px;
            margin-bottom: 24px;
        }
        
        .wealth-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 32px;
        }
        
        .wealth-stat {
            display: flex;
            flex-direction: column;
        }
        
        .wealth-stat-label {
            font-size: 0.85em;
            opacity: 0.85;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .wealth-stat-value {
            font-size: 1.8em;
            font-weight: 800;
            letter-spacing: -1px;
        }
        
        /* Grid Layout */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
            margin-bottom: 32px;
        }
        
        /* Modern Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 32px;
            transition: all 0.2s;
        }
        
        .card:hover {
            border-color: rgba(255, 99, 71, 0.3);
            transform: translateY(-2px);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .card-title {
            font-size: 1.1em;
            font-weight: 700;
            letter-spacing: -0.3px;
        }
        
        .card-value {
            font-size: 2.8em;
            font-weight: 900;
            letter-spacing: -2px;
            background: linear-gradient(135deg, var(--orange-primary), var(--orange-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .card-subtitle {
            color: var(--text-secondary);
            font-size: 0.9em;
            font-weight: 500;
        }
        
        /* Chart Card */
        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 32px;
            height: 450px;
        }
        
        /* Asset List */
        .asset-list {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            overflow: hidden;
        }
        
        .asset-item {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .asset-item:hover {
            background: rgba(255, 99, 71, 0.05);
        }
        
        .asset-item:last-child {
            border-bottom: none;
        }
        
        .asset-info {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
        }
        
        .asset-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--orange-primary), var(--orange-light));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: 700;
        }
        
        .asset-details {
            flex: 1;
        }
        
        .asset-name {
            font-size: 1.05em;
            font-weight: 700;
            margin-bottom: 4px;
            letter-spacing: -0.3px;
        }
        
        .asset-meta {
            color: var(--text-secondary);
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .asset-values {
            display: flex;
            gap: 48px;
            align-items: center;
        }
        
        .asset-stat-group {
            text-align: right;
        }
        
        .asset-stat-label {
            color: var(--text-secondary);
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .asset-stat-value {
            font-size: 1.1em;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .positive {
            color: var(--success);
        }
        
        .negative {
            color: var(--danger);
        }
        
        /* Fear & Greed Gauge */
        .gauge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 32px;
        }
        
        .gauge-value {
            font-size: 5em;
            font-weight: 900;
            letter-spacing: -4px;
            margin-bottom: 12px;
        }
        
        .gauge-label {
            font-size: 1.2em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .gauge-bar {
            width: 100%;
            height: 12px;
            background: linear-gradient(90deg, var(--danger), #ffc107, var(--success));
            border-radius: 6px;
            position: relative;
            margin-top: 24px;
        }
        
        .gauge-indicator {
            position: absolute;
            width: 4px;
            height: 20px;
            background: white;
            border-radius: 2px;
            top: -4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        /* News Section */
        .news-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .news-card:hover {
            border-color: var(--orange-primary);
            transform: translateX(4px);
        }
        
        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .news-title {
            font-size: 1.05em;
            font-weight: 700;
            line-height: 1.4;
            letter-spacing: -0.3px;
        }
        
        .news-source {
            color: var(--text-secondary);
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .news-snippet {
            color: var(--text-secondary);
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        /* AI Summary Badge */
        .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: linear-gradient(135deg, var(--orange-primary), var(--orange-light));
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 700;
            margin-bottom: 16px;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 28px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--orange-primary), var(--orange-dark));
            color: white;
            box-shadow: 0 4px 16px rgba(255, 99, 71, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 99, 71, 0.4);
        }
        
        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-subtle);
        }
        
        .btn-secondary:hover {
            border-color: var(--orange-primary);
        }
        
        /* Section Visibility */
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        /* Loading State */
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
            .grid-3 { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 80px;
                padding: 24px 12px;
            }
            
            .logo {
                font-size: 1.2em;
                text-align: center;
            }
            
            .nav-item span {
                display: none;
            }
            
            .main-content {
                margin-left: 80px;
                padding: 24px 20px;
            }
            
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }
            
            .wealth-summary {
                padding: 32px 24px;
            }
            
            .wealth-amount {
                font-size: 2.5em;
            }
            
            .wealth-stats {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="logo">finary</div>
        
        <div class="nav-menu">
            <a class="nav-item active" onclick="showSection('dashboard')">
                <span class="icon">üìä</span>
                <span>Dashboard</span>
            </a>
            <a class="nav-item" onclick="showSection('crypto')">
                <span class="icon">‚Çø</span>
                <span>Crypto</span>
            </a>
            <a class="nav-item" onclick="showSection('pea')">
                <span class="icon">üìà</span>
                <span>PEA</span>
            </a>
            <a class="nav-item" onclick="showSection('livrets')">
                <span class="icon">üí∞</span>
                <span>Livrets</span>
            </a>
            <a class="nav-item" onclick="showSection('fundraising')">
                <span class="icon">üöÄ</span>
                <span>Lev√©es</span>
            </a>
            <a class="nav-item" onclick="showSection('settings')">
                <span class="icon">‚öôÔ∏è</span>
                <span>Param√®tres</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboard" class="section active">
            <!-- Top Header -->
            <div class="top-header">
                <h1 class="page-title">Patrimoine brut</h1>
                <div class="header-actions">
                    <div class="sync-badge" id="syncStatus">
                        <span>‚úì</span>
                        <span>Synchronis√©</span>
                    </div>
                    <button class="btn-refresh" onclick="updateAll()">
                        üîÑ Actualiser les prix
                    </button>
                </div>
            </div>

            <!-- Wealth Summary Card -->
            <div class="wealth-summary">
                <div class="wealth-label">PATRIMOINE BRUT</div>
                <div class="wealth-amount" id="totalWealth">‚Ç¨0</div>
                <div class="wealth-stats">
                    <div class="wealth-stat">
                        <div class="wealth-stat-label">Total investi</div>
                        <div class="wealth-stat-value" id="totalInvested">‚Ç¨0</div>
                    </div>
                    <div class="wealth-stat">
                        <div class="wealth-stat-label">Plus-value</div>
                        <div class="wealth-stat-value" id="totalPnL">‚Ç¨0</div>
                    </div>
                    <div class="wealth-stat">
                        <div class="wealth-stat-label">Performance</div>
                        <div class="wealth-stat-value" id="totalPerf">0%</div>
                    </div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid-4" id="statsGrid"></div>

            <!-- Fear & Greed + Chart -->
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üò± Crypto Fear & Greed</div>
                    </div>
                    <div class="gauge-container" id="cryptoFearGreed">
                        <div class="loading">Chargement...</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìä Stock Fear & Greed</div>
                    </div>
                    <div class="gauge-container" id="stockFearGreed">
                        <div class="loading">Chargement...</div>
                    </div>
                </div>
            </div>

            <!-- Allocation Chart -->
            <div class="chart-card">
                <canvas id="portfolioChart"></canvas>
            </div>

            <!-- News Section -->
            <div style="margin-top: 32px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="font-size: 1.8em; font-weight: 800; letter-spacing: -1px;">üì∞ Actualit√©s</h2>
                    <button class="btn-secondary" onclick="refreshNews()">üîÑ Actualiser</button>
                </div>
                
                <div class="card" style="margin-bottom: 24px;">
                    <span class="ai-badge">ü§ñ Synth√®se IA</span>
                    <div id="aiSummary" style="color: var(--text-secondary); line-height: 1.8;">
                        <div class="loading">G√©n√©ration de la synth√®se...</div>
                    </div>
                </div>
                
                <div id="newsFeed"></div>
            </div>
        </div>

        <!-- Other Sections (Crypto, PEA, etc.) -->
        <div id="crypto" class="section">
            <div class="top-header">
                <h1 class="page-title">Portefeuille Crypto</h1>
            </div>
            <div class="loading">Section Crypto - Design identique avec nouveau style</div>
        </div>

        <div id="pea" class="section">
            <div class="top-header">
                <h1 class="page-title">Plan d'√âpargne en Actions</h1>
            </div>
            <div class="loading">Section PEA - Design identique avec nouveau style</div>
        </div>

        <div id="livrets" class="section">
            <div class="top-header">
                <h1 class="page-title">Livrets d'√©pargne</h1>
            </div>
            <div class="loading">Section Livrets - Design identique avec nouveau style</div>
        </div>

        <div id="fundraising" class="section">
            <div class="top-header">
                <h1 class="page-title">Lev√©es de fonds</h1>
            </div>
            <div class="loading">Section Lev√©es - Design identique avec nouveau style</div>
        </div>

        <div id="settings" class="section">
            <div class="top-header">
                <h1 class="page-title">Param√®tres</h1>
            </div>
            <div class="loading">Section Param√®tres - Design identique avec nouveau style</div>
        </div>
    </div>

    <script>
        let portfolio = {
            crypto: [],
            pea: [],
            livrets: [],
            fundraising: [],
            prices: {},
            priceTimestamps: {},
            binanceCredentials: null
        };

        function showSection(id) {
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');
            
            // Show section
    <script>
        // Popular cryptocurrencies library
        const cryptoLibrary = [
            { symbol: 'BTC', name: 'Bitcoin' },
            { symbol: 'ETH', name: 'Ethereum' },
            { symbol: 'BNB', name: 'Binance Coin' },
            { symbol: 'SOL', name: 'Solana' },
            { symbol: 'XRP', name: 'Ripple' },
            { symbol: 'ADA', name: 'Cardano' },
            { symbol: 'AVAX', name: 'Avalanche' },
            { symbol: 'DOGE', name: 'Dogecoin' },
            { symbol: 'DOT', name: 'Polkadot' },
            { symbol: 'MATIC', name: 'Polygon' },
            { symbol: 'LINK', name: 'Chainlink' },
            { symbol: 'UNI', name: 'Uniswap' },
            { symbol: 'ATOM', name: 'Cosmos' },
            { symbol: 'LTC', name: 'Litecoin' },
            { symbol: 'NEAR', name: 'NEAR Protocol' },
            { symbol: 'APT', name: 'Aptos' },
            { symbol: 'ARB', name: 'Arbitrum' },
            { symbol: 'OP', name: 'Optimism' },
            { symbol: 'SUI', name: 'Sui' },
            { symbol: 'PEPE', name: 'Pepe' },
            { symbol: 'SHIB', name: 'Shiba Inu' },
            { symbol: 'TRX', name: 'TRON' },
            { symbol: 'BCH', name: 'Bitcoin Cash' },
            { symbol: 'XLM', name: 'Stellar' },
            { symbol: 'AAVE', name: 'Aave' },
            { symbol: 'CRV', name: 'Curve' },
            { symbol: 'MKR', name: 'Maker' },
            { symbol: 'SNX', name: 'Synthetix' },
            { symbol: 'FTM', name: 'Fantom' },
            { symbol: 'ALGO', name: 'Algorand' }
        ];

        let portfolio = {
            crypto: [],
            pea: [],
            fundraising: [],
            prices: {},
            priceTimestamps: {},
            binanceCredentials: null
        };

        let autoSyncInterval = null;
        let isGoogleDriveConnected = false;
        let accessToken = null;
        let tokenClient = null;
        let myChart = null;

        // Initialize crypto library display
        function initCryptoLibrary() {
            const container = document.getElementById('cryptoLibrary');
            container.innerHTML = cryptoLibrary.map(crypto => `
                <div class="crypto-chip" onclick="selectCrypto('${crypto.symbol}')">
                    <div class="crypto-chip-symbol">${crypto.symbol}</div>
                    <div class="crypto-chip-name">${crypto.name}</div>
                </div>
            `).join('');
        }

        function selectCrypto(symbol) {
            document.getElementById('cryptoSymbol').value = symbol;
            
            // Visual feedback
            document.querySelectorAll('.crypto-chip').forEach(chip => {
                chip.classList.remove('selected');
            });
            event.target.closest('.crypto-chip').classList.add('selected');
        }

        // Binance API functions
        function saveBinanceCredentials() {
            const apiKey = document.getElementById('binanceApiKey').value.trim();
            const apiSecret = document.getElementById('binanceApiSecret').value.trim();
            
            if (!apiKey || !apiSecret) {
                alert('‚ö†Ô∏è Veuillez remplir les deux champs (API Key et API Secret)');
                return;
            }
            
            portfolio.binanceCredentials = { apiKey, apiSecret };
            saveData();
            updateBinanceStatus();
            alert('‚úÖ Cl√©s API Binance sauvegard√©es avec succ√®s !');
        }

        function clearBinanceCredentials() {
            if (confirm('üóëÔ∏è √ätes-vous s√ªr de vouloir supprimer vos cl√©s API Binance ?')) {
                portfolio.binanceCredentials = null;
                document.getElementById('binanceApiKey').value = '';
                document.getElementById('binanceApiSecret').value = '';
                saveData();
                updateBinanceStatus();
                alert('‚úÖ Cl√©s API supprim√©es');
            }
        }

        function updateBinanceStatus() {
            const statusEl = document.getElementById('binanceStatus');
            if (portfolio.binanceCredentials) {
                statusEl.textContent = '‚úì Connect√©';
                statusEl.className = 'api-status connected';
                
                // Fill credentials fields
                document.getElementById('binanceApiKey').value = portfolio.binanceCredentials.apiKey;
                document.getElementById('binanceApiSecret').value = portfolio.binanceCredentials.apiSecret;
            } else {
                statusEl.textContent = 'Non connect√©';
                statusEl.className = 'api-status disconnected';
            }
        }

        async function importFromBinance() {
            if (!portfolio.binanceCredentials) {
                alert('‚ö†Ô∏è Veuillez d\'abord sauvegarder vos cl√©s API Binance');
                return;
            }

            try {
                const timestamp = Date.now();
                const { apiKey, apiSecret } = portfolio.binanceCredentials;
                
                console.log('üîÑ Import depuis Binance...');
                console.log('API Key:', apiKey.substring(0, 10) + '...');
                
                // Create signature
                const queryString = `timestamp=${timestamp}`;
                const signature = await createHmacSignature(apiSecret, queryString);
                
                console.log('‚úÖ Signature cr√©√©e');
                
                // Binance API URL
                const binanceUrl = `https://api.binance.com/api/v3/account?${queryString}&signature=${signature}`;
                
                // Try with CORS proxy
                const proxies = [
                    `https://api.allorigins.win/get?url=${encodeURIComponent(binanceUrl)}`,
                    `https://corsproxy.io/?${encodeURIComponent(binanceUrl)}`,
                    binanceUrl // Try direct as last resort
                ];
                
                let data = null;
                let lastError = null;
                
                for (let i = 0; i < proxies.length; i++) {
                    try {
                        console.log(`‚è≥ Tentative ${i + 1}/${proxies.length}...`);
                        
                        const headers = {
                            'X-MBX-APIKEY': apiKey
                        };
                        
                        const response = await fetch(proxies[i], {
                            headers: i === 0 ? {} : headers, // AllOrigins doesn't forward headers
                            signal: AbortSignal.timeout(15000)
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        // Handle AllOrigins response format
                        if (i === 0) {
                            const proxyData = await response.json();
                            if (proxyData.contents) {
                                data = JSON.parse(proxyData.contents);
                            } else {
                                throw new Error('Proxy response invalid');
                            }
                        } else {
                            data = await response.json();
                        }
                        
                        // Check if we got valid data
                        if (data && data.balances) {
                            console.log('‚úÖ Donn√©es re√ßues de Binance');
                            break;
                        }
                        
                    } catch (error) {
                        console.warn(`‚ùå Proxy ${i + 1} failed:`, error.message);
                        lastError = error;
                        continue;
                    }
                }
                
                if (!data || !data.balances) {
                    throw new Error(`Impossible de se connecter √† Binance. 

Raisons possibles:
1. Les cl√©s API sont incorrectes
2. L'API Trading n'est pas activ√©e dans vos param√®tres Binance
3. Restrictions IP activ√©es sur votre cl√© API
4. CORS bloqu√© par le navigateur

Solution recommand√©e:
1. Allez sur Binance.com ‚Üí API Management
2. V√©rifiez que "Enable Spot & Margin Trading" est activ√©
3. Ajoutez "0.0.0.0/0" dans les IP autoris√©es (ou d√©sactivez la restriction IP)
4. Reg√©n√©rez votre cl√© API si n√©cessaire

Erreur technique: ${lastError?.message || 'Unknown'}`);
                }
                
                // Filter balances with value > 0
                const balances = data.balances.filter(b => parseFloat(b.free) > 0 || parseFloat(b.locked) > 0);
                
                console.log(`üìä ${balances.length} positions trouv√©es`);
                
                if (balances.length === 0) {
                    alert('‚ÑπÔ∏è Aucune position trouv√©e sur votre compte Binance');
                    return;
                }
                
                // Add positions to portfolio
                let imported = 0;
                let updated = 0;
                
                for (const balance of balances) {
                    const quantity = parseFloat(balance.free) + parseFloat(balance.locked);
                    const symbol = balance.asset;
                    
                    console.log(`${symbol}: ${quantity}`);
                    
                    // Check if already exists
                    const existingIndex = portfolio.crypto.findIndex(c => c.symbol === symbol);
                    
                    if (existingIndex >= 0) {
                        // Update existing
                        portfolio.crypto[existingIndex].quantity = quantity;
                        updated++;
                    } else {
                        // Add new
                        portfolio.crypto.push({
                            symbol: symbol,
                            quantity: quantity,
                            price: 0, // Will be updated with current price
                            date: new Date().toISOString().split('T')[0]
                        });
                        imported++;
                    }
                }
                
                saveData();
                await updateAll();
                
                alert(`‚úÖ Import Binance r√©ussi !

Nouvelles positions : ${imported}
Positions mises √† jour : ${updated}
Total : ${balances.length} cryptos

‚ö†Ô∏è Note : Les prix d'achat sont √† 0. 
Vous pouvez les modifier manuellement dans la liste ci-dessous.`);
                
            } catch (error) {
                console.error('‚ùå Erreur import Binance:', error);
                alert(`‚ùå Erreur lors de l'import depuis Binance:

${error.message}

üí° SOLUTION : Utilisez l'import CSV Binance (bouton "üì• Importer CSV Binance")

Aide au d√©pannage API:
‚Ä¢ V√©rifiez vos cl√©s API dans les param√®tres Binance
‚Ä¢ Assurez-vous que "Enable Spot & Margin Trading" est activ√©
‚Ä¢ V√©rifiez les restrictions IP (d√©sactivez-les temporairement pour tester)
‚Ä¢ Le probl√®me CORS persiste malgr√© nos tentatives de proxies`);
            }
        }
        
        // Import CSV from Binance
        function importBinanceCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('üì• Import CSV Binance...');
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    try {
                        ensurePortfolioStructure();
                        
                        let imported = 0;
                        let updated = 0;
                        let errors = [];
                        
                        console.log('üìä Lignes trouv√©es:', results.data.length);
                        
                        results.data.forEach((row, index) => {
                            // Try different possible column names
                            const coin = row.Coin || row.coin || row.Asset || row.asset || row.Symbol || row.symbol;
                            const free = parseFloat(row.Free || row.free || row.Available || row.available || 0);
                            const locked = parseFloat(row.Locked || row.locked || 0);
                            
                            if (!coin) {
                                errors.push(`Ligne ${index + 1}: Pas de symbole trouv√©`);
                                return;
                            }
                            
                            const quantity = free + locked;
                            
                            // Skip if quantity is 0
                            if (quantity <= 0) {
                                console.log(`‚è≠Ô∏è ${coin}: Quantit√© = 0, ignor√©`);
                                return;
                            }
                            
                            console.log(`üí∞ ${coin}: ${quantity} (Free: ${free}, Locked: ${locked})`);
                            
                            // Check if already exists
                            const existingIndex = portfolio.crypto.findIndex(c => c.symbol === coin.toUpperCase());
                            
                            if (existingIndex >= 0) {
                                // Update existing
                                portfolio.crypto[existingIndex].quantity = quantity;
                                updated++;
                            } else {
                                // Add new
                                portfolio.crypto.push({
                                    symbol: coin.toUpperCase(),
                                    quantity: quantity,
                                    price: 0, // Will be updated with current price
                                    date: new Date().toISOString().split('T')[0]
                                });
                                imported++;
                            }
                        });
                        
                        if (imported === 0 && updated === 0) {
                            alert(`‚ö†Ô∏è Aucune position valide trouv√©e dans le CSV.

V√©rifiez que votre CSV contient :
‚Ä¢ Une colonne "Coin" (ou "Asset"/"Symbol")
‚Ä¢ Une colonne "Free" (ou "Available")
‚Ä¢ Une colonne "Locked" (optionnel)

Erreurs d√©tect√©es :
${errors.length > 0 ? errors.join('\n') : 'Aucune ligne avec quantit√© > 0'}`);
                            return;
                        }
                        
                        saveData();
                        syncDriveData();
                        updateAll();
                        
                        alert(`‚úÖ Import CSV Binance r√©ussi !

Nouvelles positions : ${imported}
Positions mises √† jour : ${updated}
Total import√© : ${imported + updated} cryptos

‚ö†Ô∏è Note : Les prix d'achat sont √† 0.
Cliquez sur "Actualiser les prix" pour obtenir les prix actuels.
${errors.length > 0 ? '\n\n‚ö†Ô∏è Erreurs : ' + errors.length + ' lignes ignor√©es' : ''}`);
                        
                    } catch (err) {
                        console.error('‚ùå Erreur traitement CSV:', err);
                        alert(`‚ùå Erreur lors du traitement du CSV:

${err.message}

V√©rifiez que votre fichier CSV est au bon format.`);
                    }
                },
                error: function(error) {
                    alert(`‚ùå Erreur lecture CSV: ${error.message}`);
                }
            });
            
            // Reset input
            event.target.value = '';
        }

        async function createHmacSignature(secret, message) {
            const encoder = new TextEncoder();
            const keyData = encoder.encode(secret);
            const messageData = encoder.encode(message);
            
            const key = await crypto.subtle.importKey(
                'raw',
                keyData,
                { name: 'HMAC', hash: 'SHA-256' },
                false,
                ['sign']
            );
            
            const signature = await crypto.subtle.sign('HMAC', key, messageData);
            return Array.from(new Uint8Array(signature))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(section).classList.add('active');
        }

        function ensurePortfolioStructure() {
            if (!portfolio.crypto) portfolio.crypto = [];
            if (!portfolio.pea) portfolio.pea = [];
            if (!portfolio.livrets) portfolio.livrets = [];
            if (!portfolio.fundraising) portfolio.fundraising = [];
            if (!portfolio.prices) portfolio.prices = {};
            if (!portfolio.priceTimestamps) portfolio.priceTimestamps = {};
            if (!portfolio.binanceCredentials) portfolio.binanceCredentials = null;
        }

        function addCrypto() {
            const symbol = document.getElementById('cryptoSymbol').value.toUpperCase();
            const quantity = parseFloat(document.getElementById('cryptoQuantity').value);
            const price = parseFloat(document.getElementById('cryptoPrice').value);
            const date = document.getElementById('cryptoDate').value;

            if (!symbol || !quantity || !price || !date) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            portfolio.crypto.push({ symbol, quantity, price, date });
            saveData();
            syncDriveData();
            updateCryptoList();
            
            document.getElementById('cryptoSymbol').value = '';
            document.getElementById('cryptoQuantity').value = '';
            document.getElementById('cryptoPrice').value = '';
            
            // Remove selection
            document.querySelectorAll('.crypto-chip').forEach(chip => {
                chip.classList.remove('selected');
            });
        }

        function addPEA() {
            const name = document.getElementById('peaName').value;
            const ticker = document.getElementById('peaTicker').value.toUpperCase();
            const quantity = parseFloat(document.getElementById('peaQuantity').value);
            const price = parseFloat(document.getElementById('peaPrice').value);
            const fees = parseFloat(document.getElementById('peaFees').value) || 0;
            const date = document.getElementById('peaDate').value;

            if (!name || !ticker || !quantity || !price || !date) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }

            portfolio.pea.push({ name, ticker, quantity, price, fees, date });
            saveData();
            syncDriveData();
            updatePEAList();
            updatePEAQuickSelect(); // Update quick select buttons
            
            document.getElementById('peaName').value = '';
            document.getElementById('peaTicker').value = '';
            document.getElementById('peaQuantity').value = '';
            document.getElementById('peaPrice').value = '';
            document.getElementById('peaFees').value = '';
        }
        
        // Function to fill form with existing asset data
        function fillPEAForm(name, ticker) {
            document.getElementById('peaName').value = name;
            document.getElementById('peaTicker').value = ticker;
            document.getElementById('peaQuantity').focus();
        }
        
        // Function to update quick select buttons and autocomplete
        function updatePEAQuickSelect() {
            const container = document.getElementById('quickSelectPEA');
            if (!container) return;
            
            // Get unique assets (grouped by ticker)
            const uniqueAssets = {};
            portfolio.pea.forEach(item => {
                if (!uniqueAssets[item.ticker]) {
                    uniqueAssets[item.ticker] = {
                        name: item.name,
                        ticker: item.ticker
                    };
                }
            });
            
            // Update quick select buttons
            if (Object.keys(uniqueAssets).length === 0) {
                container.innerHTML = '<em style="color: #a0aec0;">Aucun actif existant</em>';
            } else {
                container.innerHTML = Object.values(uniqueAssets).map(asset => 
                    `<button class="quick-select-btn" onclick="fillPEAForm('${asset.name}', '${asset.ticker}')">
                        ${asset.name} (${asset.ticker})
                    </button>`
                ).join('');
            }
            
            // Update autocomplete datalists
            const nameList = document.getElementById('peaNameList');
            const tickerList = document.getElementById('peaTickerList');
            
            if (nameList && tickerList) {
                nameList.innerHTML = Object.values(uniqueAssets).map(asset => 
                    `<option value="${asset.name}">`
                ).join('');
                
                tickerList.innerHTML = Object.values(uniqueAssets).map(asset => 
                    `<option value="${asset.ticker}">`
                ).join('');
            }
        }
        
        // Auto-sync name and ticker when typing
        document.addEventListener('DOMContentLoaded', function() {
            const peaNameInput = document.getElementById('peaName');
            const peaTickerInput = document.getElementById('peaTicker');
            
            if (peaNameInput && peaTickerInput) {
                peaNameInput.addEventListener('input', function() {
                    // Find matching asset by name
                    const matchingAsset = portfolio.pea.find(item => 
                        item.name.toLowerCase() === this.value.toLowerCase()
                    );
                    if (matchingAsset) {
                        peaTickerInput.value = matchingAsset.ticker;
                    }
                });
                
                peaTickerInput.addEventListener('input', function() {
                    // Find matching asset by ticker
                    const matchingAsset = portfolio.pea.find(item => 
                        item.ticker.toUpperCase() === this.value.toUpperCase()
                    );
                    if (matchingAsset) {
                        peaNameInput.value = matchingAsset.name;
                    }
                });
            }
        });

        function addFundraising() {
            const name = document.getElementById('fundName').value;
            const amount = parseFloat(document.getElementById('fundAmount').value);
            const valuation = parseFloat(document.getElementById('fundValuation').value);
            const date = document.getElementById('fundDate').value;

            if (!name || !amount || !valuation || !date) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            if (isNaN(amount) || isNaN(valuation)) {
                alert('Montant et valuation doivent √™tre des nombres');
                return;
            }
            
            // Ensure portfolio structure exists
            ensurePortfolioStructure();
            
            portfolio.fundraising.push({ 
                name: name, 
                amount: amount, 
                valuation: valuation, 
                date: date 
            });
            
            console.log('‚úÖ Investissement ajout√©:', { name, amount, valuation, date });
            
            saveData();
            syncDriveData();
            updateFundraisingList();
            updateAll();
            
            // Clear form
            document.getElementById('fundName').value = '';
            document.getElementById('fundAmount').value = '';
            document.getElementById('fundValuation').value = '';
        }

        async function updatePrices() {
            const cryptoSymbols = [...new Set(portfolio.crypto.map(c => c.symbol))];
            const peaTickers = [...new Set(portfolio.pea.map(p => p.ticker))];
            
            for (const symbol of cryptoSymbols) {
                try {
                    const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${getCoinGeckoId(symbol)}&vs_currencies=usd`);
                    const data = await res.json();
                    const coinId = getCoinGeckoId(symbol);
                    if (data[coinId]) {
                        portfolio.prices[symbol] = data[coinId].usd;
                        portfolio.priceTimestamps[symbol] = Date.now();
                    }
                } catch (e) {
                    console.error(`Erreur prix ${symbol}:`, e);
                }
            }

            for (const ticker of peaTickers) {
                try {
                    const res = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1d`);
                    const data = await res.json();
                    if (data.chart.result[0]) {
                        const price = data.chart.result[0].meta.regularMarketPrice;
                        portfolio.prices[ticker] = price;
                        portfolio.priceTimestamps[ticker] = Date.now();
                    }
                } catch (e) {
                    console.error(`Erreur prix ${ticker}:`, e);
                }
            }
            
            saveData();
        }

        function getCoinGeckoId(symbol) {
            const map = {
                'BTC': 'bitcoin', 'ETH': 'ethereum', 'BNB': 'binancecoin',
                'SOL': 'solana', 'XRP': 'ripple', 'ADA': 'cardano',
                'AVAX': 'avalanche-2', 'DOGE': 'dogecoin', 'DOT': 'polkadot',
                'MATIC': 'matic-network', 'LINK': 'chainlink', 'UNI': 'uniswap',
                'ATOM': 'cosmos', 'LTC': 'litecoin', 'NEAR': 'near',
                'APT': 'aptos', 'ARB': 'arbitrum', 'OP': 'optimism',
                'SUI': 'sui', 'PEPE': 'pepe', 'SHIB': 'shiba-inu',
                'TRX': 'tron', 'BCH': 'bitcoin-cash', 'XLM': 'stellar',
                'AAVE': 'aave', 'CRV': 'curve-dao-token', 'MKR': 'maker',
                'SNX': 'synthetix-network-token', 'FTM': 'fantom', 'ALGO': 'algorand'
            };
            return map[symbol] || symbol.toLowerCase();
        }

        function updateCryptoList() {
            const grouped = {};
            portfolio.crypto.forEach(item => {
                if (!grouped[item.symbol]) grouped[item.symbol] = [];
                grouped[item.symbol].push(item);
            });

            const html = Object.entries(grouped).map(([symbol, items]) => {
                const totalQty = items.reduce((sum, i) => sum + i.quantity, 0);
                const avgPrice = items.reduce((sum, i) => sum + (i.price * i.quantity), 0) / totalQty;
                const currentPrice = portfolio.prices[symbol] || 0;
                const currentValue = totalQty * currentPrice;
                const invested = items.reduce((sum, i) => sum + (i.price * i.quantity), 0);
                const pnl = currentValue - invested;
                const pnlPercent = ((pnl / invested) * 100) || 0;

                const cryptoInfo = cryptoLibrary.find(c => c.symbol === symbol);
                const fullName = cryptoInfo ? cryptoInfo.name : symbol;

                return `
                    <div class="asset-group">
                        <div class="asset-header" onclick="toggleAsset('${symbol}')">
                            <div class="asset-header-left">
                                <span class="asset-toggle" id="toggle-${symbol}">‚ñ∂</span>
                                <div>
                                    <div class="asset-name">${fullName}</div>
                                    <div class="asset-ticker">${symbol}</div>
                                </div>
                            </div>
                            <div class="asset-stats">
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Quantit√©</div>
                                    <div class="asset-stat-value">${totalQty.toFixed(8)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Prix moyen</div>
                                    <div class="asset-stat-value">$${avgPrice.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Prix actuel</div>
                                    <div class="asset-stat-value">$${currentPrice.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Valeur</div>
                                    <div class="asset-stat-value">$${currentValue.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">P&L</div>
                                    <div class="asset-stat-value ${pnl >= 0 ? 'positive' : 'negative'}">
                                        ${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}
                                    </div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">P&L %</div>
                                    <div class="asset-stat-value ${pnlPercent >= 0 ? 'positive' : 'negative'}">
                                        ${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="asset-content" id="content-${symbol}">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Quantit√©</th>
                                        <th>Prix d'achat</th>
                                        <th>Valeur actuelle</th>
                                        <th>P&L</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${items.map((item, idx) => {
                                        const itemValue = item.quantity * currentPrice;
                                        const itemInvested = item.quantity * item.price;
                                        const itemPnl = itemValue - itemInvested;
                                        const itemPnlPercent = ((itemPnl / itemInvested) * 100) || 0;
                                        
                                        return `
                                            <tr>
                                                <td>${item.date}</td>
                                                <td>${item.quantity}</td>
                                                <td>$${item.price.toFixed(2)}</td>
                                                <td>$${itemValue.toFixed(2)}</td>
                                                <td class="${itemPnl >= 0 ? 'positive' : 'negative'}">
                                                    ${itemPnl >= 0 ? '+' : ''}$${itemPnl.toFixed(2)} (${itemPnlPercent.toFixed(2)}%)
                                                </td>
                                                <td>
                                                    <button onclick="editCrypto('${symbol}', ${portfolio.crypto.indexOf(item)})" class="btn-secondary">‚úèÔ∏è</button>
                                                    <button onclick="deleteCrypto(${portfolio.crypto.indexOf(item)})" class="btn-danger">üóëÔ∏è</button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('cryptoList').innerHTML = html;
        }

        function updatePEAList() {
            const grouped = {};
            portfolio.pea.forEach((item, index) => {
                if (!grouped[item.ticker]) {
                    grouped[item.ticker] = {
                        name: item.name || item.ticker,
                        ticker: item.ticker,
                        purchases: []
                    };
                }
                grouped[item.ticker].purchases.push({ ...item, originalIndex: index });
            });

            const html = Object.entries(grouped).map(([ticker, asset]) => {
                const totalQty = asset.purchases.reduce((sum, i) => sum + i.quantity, 0);
                const totalFees = asset.purchases.reduce((sum, i) => sum + (i.fees || 0), 0);
                const totalInvested = asset.purchases.reduce((sum, i) => sum + (i.price * i.quantity) + (i.fees || 0), 0);
                const avgPrice = totalQty > 0 ? totalInvested / totalQty : 0;
                const currentPrice = portfolio.prices[ticker] || avgPrice;
                const currentValue = totalQty * currentPrice;
                const pnl = currentValue - totalInvested;
                const pnlPercent = totalInvested > 0 ? (pnl / totalInvested) * 100 : 0;

                const lastUpdate = portfolio.priceTimestamps[ticker] 
                    ? new Date(portfolio.priceTimestamps[ticker]).toLocaleString('fr-FR')
                    : 'Jamais';

                return `
                    <div class="asset-group">
                        <div class="asset-header" onclick="toggleAsset('${ticker}')">
                            <div class="asset-header-left">
                                <span class="asset-toggle" id="toggle-${ticker}">‚ñ∂</span>
                                <div>
                                    <div class="asset-name">${asset.name}</div>
                                    <div class="asset-ticker">${ticker} ‚Ä¢ MAJ: ${lastUpdate}</div>
                                </div>
                            </div>
                            <div class="asset-stats">
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Quantit√©</div>
                                    <div class="asset-stat-value">${totalQty.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">PRU</div>
                                    <div class="asset-stat-value">‚Ç¨${avgPrice.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Prix actuel</div>
                                    <div class="asset-stat-value">‚Ç¨${currentPrice.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Valeur</div>
                                    <div class="asset-stat-value">‚Ç¨${currentValue.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">P&L</div>
                                    <div class="asset-stat-value ${pnl >= 0 ? 'positive' : 'negative'}">
                                        ${pnl >= 0 ? '+' : ''}‚Ç¨${pnl.toFixed(2)}
                                    </div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">P&L %</div>
                                    <div class="asset-stat-value ${pnlPercent >= 0 ? 'positive' : 'negative'}">
                                        ${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="asset-content" id="details-${ticker}" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 20px;">
                                <h4 style="margin: 0; color: #a0aec0;">üìä Historique des achats</h4>
                                <div style="flex: 1; max-width: 500px; height: 150px;">
                                    <canvas id="chart-${ticker}"></canvas>
                                </div>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Quantit√©</th>
                                        <th>Prix d'achat</th>
                                        <th>Frais</th>
                                        <th>Valeur actuelle</th>
                                        <th>P&L</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${asset.purchases.map((item) => {
                                        const itemValue = item.quantity * currentPrice;
                                        const itemInvested = item.quantity * item.price + (item.fees || 0);
                                        const itemPnl = itemValue - itemInvested;
                                        const itemPnlPercent = itemInvested > 0 ? ((itemPnl / itemInvested) * 100) : 0;
                                        
                                        return `
                                            <tr>
                                                <td>${new Date(item.date).toLocaleDateString('fr-FR')}</td>
                                                <td>${item.quantity.toFixed(2)}</td>
                                                <td>‚Ç¨${item.price.toFixed(2)}</td>
                                                <td>‚Ç¨${(item.fees || 0).toFixed(2)}</td>
                                                <td>‚Ç¨${itemValue.toFixed(2)}</td>
                                                <td class="${itemPnl >= 0 ? 'positive' : 'negative'}">
                                                    ${itemPnl >= 0 ? '+' : ''}‚Ç¨${itemPnl.toFixed(2)} (${itemPnlPercent.toFixed(2)}%)
                                                </td>
                                                <td>
                                                    <button onclick="editPEA('${ticker}', ${item.originalIndex})" class="btn-secondary">‚úèÔ∏è</button>
                                                    <button onclick="deletePEA(${item.originalIndex})" class="btn-danger">üóëÔ∏è</button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('peaList').innerHTML = html;
            
            // Create charts for each asset
            Object.entries(grouped).forEach(([ticker, asset]) => {
                const currentPrice = portfolio.prices[ticker] || 0;
                setTimeout(() => createAssetChart(ticker, asset.purchases, currentPrice), 100);
            });
        }

        function updateFundraisingList() {
            const container = document.getElementById('fundraisingList');
            if (!container) {
                console.error('Container fundraisingList not found');
                return;
            }
            
            if (!portfolio.fundraising || portfolio.fundraising.length === 0) {
                container.innerHTML = '<p style="color: #a0aec0; text-align: center; padding: 40px;">Aucun investissement enregistr√©.</p>';
                return;
            }
            
            const html = portfolio.fundraising.map((item, index) => {
                // V√©rification et conversion s√©curis√©e
                const amount = parseFloat(item.amount) || 0;
                const valuation = parseFloat(item.valuation) || 0;
                const date = item.date || 'N/A';
                const name = item.name || 'Sans nom';
                
                const equity = valuation > 0 ? (amount / valuation) * 100 : 0;
                
                return `
                    <div class="asset-group">
                        <div class="asset-header">
                            <div class="asset-header-left">
                                <div>
                                    <div class="asset-name">${name}</div>
                                    <div class="asset-ticker">${date}</div>
                                </div>
                            </div>
                            <div class="asset-stats">
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Investi</div>
                                    <div class="asset-stat-value">‚Ç¨${amount.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Valuation</div>
                                    <div class="asset-stat-value">‚Ç¨${valuation.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Part</div>
                                    <div class="asset-stat-value">${equity.toFixed(4)}%</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Actions</div>
                                    <div>
                                        <button onclick="editFundraising(${index})" class="btn-secondary">‚úèÔ∏è</button>
                                        <button onclick="deleteFundraising(${index})" class="btn-danger">üóëÔ∏è</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            container.innerHTML = html;
        }

        function createAssetChart(ticker, purchases, currentPrice) {
            const ctx = document.getElementById(`chart-${ticker}`);
            if (!ctx) return;
            
            // Sort purchases by date
            const sortedPurchases = [...purchases].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Calculate cumulative portfolio value over time
            const chartData = [];
            let cumulativeQuantity = 0;
            let cumulativeInvested = 0;
            
            sortedPurchases.forEach(p => {
                const fees = p.fees || 0;
                cumulativeQuantity += p.quantity;
                cumulativeInvested += (p.quantity * p.price) + fees;
                
                const avgPrice = cumulativeInvested / cumulativeQuantity;
                const currentValue = cumulativeQuantity * currentPrice;
                
                chartData.push({
                    date: new Date(p.date).toLocaleDateString('fr-FR'),
                    invested: cumulativeInvested,
                    value: currentValue,
                    quantity: cumulativeQuantity
                });
            });
            
            // Create chart
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(d => d.date),
                    datasets: [
                        {
                            label: 'Valeur actuelle',
                            data: chartData.map(d => d.value),
                            borderColor: '#00ff88',
                            backgroundColor: 'rgba(0, 255, 136, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Montant investi',
                            data: chartData.map(d => d.invested),
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#fff', font: { size: 10 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' ‚Ç¨';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#a0aec0' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#a0aec0' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function toggleAsset(ticker) {
            const content = document.getElementById(`content-${ticker}`);
            const details = document.getElementById(`details-${ticker}`);
            const toggle = document.getElementById(`toggle-${ticker}`);
            
            const targetElement = content || details;
            
            if (targetElement) {
                if (targetElement.classList.contains('expanded') || targetElement.style.display === 'block') {
                    targetElement.classList.remove('expanded');
                    targetElement.style.display = 'none';
                    if (toggle) toggle.classList.remove('expanded');
                } else {
                    targetElement.classList.add('expanded');
                    targetElement.style.display = 'block';
                    if (toggle) toggle.classList.add('expanded');
                }
            }
        }

        function editCrypto(symbol, index) {
            const item = portfolio.crypto[index];
            const newQuantity = prompt('Nouvelle quantit√©:', item.quantity);
            const newPrice = prompt('Nouveau prix:', item.price);
            
            if (newQuantity !== null && newPrice !== null) {
                portfolio.crypto[index].quantity = parseFloat(newQuantity);
                portfolio.crypto[index].price = parseFloat(newPrice);
                saveData();
                syncDriveData();
                updateCryptoList();
            }
        }

        function deleteCrypto(index) {
            if (confirm('Supprimer cette position ?')) {
                portfolio.crypto.splice(index, 1);
                saveData();
                syncDriveData();
                updateCryptoList();
            }
        }

        function editPEA(ticker, index) {
            const item = portfolio.pea[index];
            const newQuantity = prompt('Nouvelle quantit√©:', item.quantity);
            const newPrice = prompt('Nouveau prix:', item.price);
            const newFees = prompt('Nouveaux frais:', item.fees);
            
            if (newQuantity !== null && newPrice !== null && newFees !== null) {
                portfolio.pea[index].quantity = parseFloat(newQuantity);
                portfolio.pea[index].price = parseFloat(newPrice);
                portfolio.pea[index].fees = parseFloat(newFees);
                saveData();
                syncDriveData();
                updatePEAList();
            }
        }

        function deletePEA(index) {
            if (confirm('Supprimer cette position ?')) {
                portfolio.pea.splice(index, 1);
                saveData();
                syncDriveData();
                updatePEAList();
            }
        }

        function editFundraising(index) {
            const item = portfolio.fundraising[index];
            const newAmount = prompt('Nouveau montant investi:', item.amount);
            const newValuation = prompt('Nouvelle valuation:', item.valuation);
            
            if (newAmount !== null && newValuation !== null) {
                portfolio.fundraising[index].amount = parseFloat(newAmount);
                portfolio.fundraising[index].valuation = parseFloat(newValuation);
                saveData();
                syncDriveData();
                updateFundraisingList();
            }
        }

        function deleteFundraising(index) {
            if (confirm('Supprimer cet investissement ?')) {
                portfolio.fundraising.splice(index, 1);
                saveData();
                syncDriveData();
                updateFundraisingList();
                updateAll();
            }
        }

        // ========================================
        // LIVRETS D'√âPARGNE FUNCTIONS
        // ========================================
        
        function addLivret() {
            const type = document.getElementById('livretType').value;
            const bank = document.getElementById('livretBank').value;
            const amount = parseFloat(document.getElementById('livretAmount').value);
            const rate = parseFloat(document.getElementById('livretRate').value);
            const ceiling = parseFloat(document.getElementById('livretCeiling').value) || null;
            const date = document.getElementById('livretDate').value;

            if (!type || !bank || !amount || !rate || !date) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            if (isNaN(amount) || isNaN(rate)) {
                alert('Montant et taux doivent √™tre des nombres');
                return;
            }

            ensurePortfolioStructure();
            
            portfolio.livrets.push({ 
                type, 
                bank, 
                amount, 
                rate, 
                ceiling,
                date 
            });
            
            console.log('‚úÖ Livret ajout√©:', { type, bank, amount, rate, ceiling, date });
            
            saveData();
            syncDriveData();
            updateLivretsList();
            updateAll();
            
            // Clear form
            document.getElementById('livretType').value = '';
            document.getElementById('livretBank').value = '';
            document.getElementById('livretAmount').value = '';
            document.getElementById('livretRate').value = '';
            document.getElementById('livretCeiling').value = '';
        }
        
        function autoFillLivretRate() {
            const type = document.getElementById('livretType').value;
            const rateInput = document.getElementById('livretRate');
            const ceilingInput = document.getElementById('livretCeiling');
            
            const livretData = {
                'LEP': { rate: 4.00, ceiling: 10000 },
                'Livret A': { rate: 2.40, ceiling: 22950 },
                'LDDS': { rate: 2.40, ceiling: 12000 },
                'Livret Jeune': { rate: 2.40, ceiling: 1600 },
                'PEL': { rate: 2.25, ceiling: 61200 },
                'CEL': { rate: 2.00, ceiling: 15300 },
                'CSL': { rate: 0.50, ceiling: null }
            };
            
            if (type && livretData[type]) {
                rateInput.value = livretData[type].rate;
                if (livretData[type].ceiling) {
                    ceilingInput.value = livretData[type].ceiling;
                }
                alert(`‚úÖ Taux et plafond appliqu√©s pour ${type}`);
            } else {
                alert('‚ö†Ô∏è S√©lectionnez d\'abord un type de livret');
            }
        }
        
        function updateLivretsList() {
            const container = document.getElementById('livretsList');
            if (!container) {
                console.error('Container livretsList not found');
                return;
            }
            
            if (!portfolio.livrets || portfolio.livrets.length === 0) {
                container.innerHTML = '<p style="color: #a0aec0; text-align: center; padding: 40px;">Aucun livret enregistr√©.</p>';
                return;
            }
            
            let totalLivrets = 0;
            let totalInterestPerYear = 0;
            
            const html = portfolio.livrets.map((item, index) => {
                const amount = parseFloat(item.amount) || 0;
                const rate = parseFloat(item.rate) || 0;
                const ceiling = parseFloat(item.ceiling) || null;
                const bank = item.bank || 'N/A';
                const type = item.type || 'Autre';
                const date = item.date || 'N/A';
                
                const interestPerYear = (amount * rate) / 100;
                const remaining = ceiling ? Math.max(0, ceiling - amount) : null;
                const fillPercentage = ceiling ? (amount / ceiling) * 100 : null;
                
                totalLivrets += amount;
                totalInterestPerYear += interestPerYear;
                
                return `
                    <div class="asset-group">
                        <div class="asset-header">
                            <div class="asset-header-left">
                                <div>
                                    <div class="asset-name">${type}</div>
                                    <div class="asset-ticker">${bank} ‚Ä¢ Ouvert le ${new Date(date).toLocaleDateString('fr-FR')}</div>
                                </div>
                            </div>
                            <div class="asset-stats">
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Montant</div>
                                    <div class="asset-stat-value">‚Ç¨${amount.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Taux</div>
                                    <div class="asset-stat-value">${rate.toFixed(2)}%</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Int√©r√™ts/an</div>
                                    <div class="asset-stat-value positive">‚Ç¨${interestPerYear.toFixed(2)}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Plafond</div>
                                    <div class="asset-stat-value">${ceiling ? '‚Ç¨' + ceiling.toLocaleString('fr-FR') : 'Aucun'}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Restant</div>
                                    <div class="asset-stat-value">${remaining !== null ? '‚Ç¨' + remaining.toLocaleString('fr-FR') : '-'}</div>
                                </div>
                                <div class="asset-stat">
                                    <div class="asset-stat-label">Actions</div>
                                    <div>
                                        <button onclick="editLivret(${index})" class="btn-secondary">‚úèÔ∏è</button>
                                        <button onclick="deleteLivret(${index})" class="btn-danger">üóëÔ∏è</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ${fillPercentage !== null ? `
                        <div style="padding: 10px 20px;">
                            <div style="background: rgba(0,0,0,0.3); height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #00ff88, #00cc6a); height: 100%; width: ${fillPercentage}%; transition: width 0.3s;"></div>
                            </div>
                            <p style="text-align: center; margin-top: 5px; font-size: 0.85em; color: #a0aec0;">
                                ${fillPercentage.toFixed(1)}% du plafond atteint
                            </p>
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            const summary = `
                <div class="info-message" style="margin-bottom: 20px;">
                    <strong>üìä R√©capitulatif :</strong><br>
                    Total √©pargn√© : <strong>‚Ç¨${totalLivrets.toLocaleString('fr-FR', {minimumFractionDigits: 2})}</strong><br>
                    Int√©r√™ts annuels estim√©s : <strong class="positive">‚Ç¨${totalInterestPerYear.toFixed(2)}</strong><br>
                    Int√©r√™ts mensuels estim√©s : <strong class="positive">‚Ç¨${(totalInterestPerYear / 12).toFixed(2)}</strong>
                </div>
            `;
            
            container.innerHTML = summary + html;
        }
        
        function editLivret(index) {
            const livret = portfolio.livrets[index];
            if (!livret) return;
            
            document.getElementById('livretType').value = livret.type;
            document.getElementById('livretBank').value = livret.bank;
            document.getElementById('livretAmount').value = livret.amount;
            document.getElementById('livretRate').value = livret.rate;
            document.getElementById('livretCeiling').value = livret.ceiling || '';
            document.getElementById('livretDate').value = livret.date;
            
            // Delete old entry
            portfolio.livrets.splice(index, 1);
            saveData();
            syncDriveData();
            updateLivretsList();
        }
        
        function deleteLivret(index) {
            if (confirm('Supprimer ce livret ?')) {
                portfolio.livrets.splice(index, 1);
                saveData();
                syncDriveData();
                updateLivretsList();
                updateAll();
            }
        }

        function updateDashboard() {
            let totalValue = 0;
            let totalInvested = 0;

            // Crypto calculations
            portfolio.crypto.forEach(c => {
                const currentPrice = portfolio.prices[c.symbol] || 0;
                totalValue += c.quantity * currentPrice;
                totalInvested += c.quantity * c.price;
            });

            // PEA calculations
            const peaByTicker = {};
            portfolio.pea.forEach(p => {
                const fees = p.fees || 0;
                if (!peaByTicker[p.ticker]) {
                    peaByTicker[p.ticker] = { quantity: 0, invested: 0 };
                }
                peaByTicker[p.ticker].quantity += p.quantity;
                peaByTicker[p.ticker].invested += (p.quantity * p.price) + fees;
            });

            Object.entries(peaByTicker).forEach(([ticker, data]) => {
                const avgPrice = data.invested / data.quantity;
                const currentPrice = portfolio.prices[ticker] || avgPrice;
                totalValue += data.quantity * currentPrice;
                totalInvested += data.invested;
            });

            // Livrets calculations (both invested and value are the same)
            let totalLivrets = 0;
            portfolio.livrets.forEach(l => {
                const amount = parseFloat(l.amount) || 0;
                totalLivrets += amount;
                totalValue += amount;
                totalInvested += amount;
            });

            // Fundraising calculations
            portfolio.fundraising.forEach(f => {
                totalValue += f.valuation;
                totalInvested += f.amount;
            });

            const totalPnL = totalValue - totalInvested;
            const totalPerf = totalInvested > 0 ? (totalPnL / totalInvested) * 100 : 0;

            const html = `
                <div class="stat-card">
                    <div class="stat-label">üí∞ Valeur Totale</div>
                    <div class="stat-value">‚Ç¨${totalValue.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìä Total Investi</div>
                    <div class="stat-value">‚Ç¨${totalInvested.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìà P&L Global</div>
                    <div class="stat-value ${totalPnL >= 0 ? 'positive' : 'negative'}">
                        ${totalPnL >= 0 ? '+' : ''}‚Ç¨${totalPnL.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìä P&L %</div>
                    <div class="stat-value ${totalPerf >= 0 ? 'positive' : 'negative'}">
                        ${totalPerf >= 0 ? '+' : ''}${totalPerf.toFixed(2)}%
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">‚Çø Crypto</div>
                    <div class="stat-value">‚Ç¨${portfolio.crypto.reduce((sum, c) => sum + (c.quantity * (portfolio.prices[c.symbol] || 0)), 0).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìä PEA</div>
                    <div class="stat-value">‚Ç¨${Object.entries(peaByTicker).reduce((sum, [ticker, data]) => {
                        const avgPrice = data.invested / data.quantity;
                        const currentPrice = portfolio.prices[ticker] || avgPrice;
                        return sum + (data.quantity * currentPrice);
                    }, 0).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üí∞ Livrets</div>
                    <div class="stat-value">‚Ç¨${totalLivrets.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üöÄ Lev√©es</div>
                    <div class="stat-value">‚Ç¨${portfolio.fundraising.reduce((sum, f) => sum + f.valuation, 0).toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                </div>
            `;

            document.getElementById('dashboardStats').innerHTML = html;
            updateChart(peaByTicker);
        }

        function updateChart(peaByTicker) {
            const ctx = document.getElementById('portfolioChart');
            if (!ctx) return;
            
            let cryptoValue = 0;
            let peaValue = 0;
            let livretsValue = 0;
            let fundraisingValue = 0;

            portfolio.crypto.forEach(c => {
                const currentPrice = portfolio.prices[c.symbol] || 0;
                cryptoValue += c.quantity * currentPrice;
            });

            Object.entries(peaByTicker).forEach(([ticker, data]) => {
                const avgPrice = data.invested / data.quantity;
                const currentPrice = portfolio.prices[ticker] || avgPrice;
                peaValue += data.quantity * currentPrice;
            });

            portfolio.livrets.forEach(l => {
                livretsValue += parseFloat(l.amount) || 0;
            });

            portfolio.fundraising.forEach(f => {
                fundraisingValue += f.valuation;
            });

            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Crypto', 'PEA', 'Livrets', 'Lev√©es'],
                    datasets: [{
                        data: [cryptoValue, peaValue, livretsValue, fundraisingValue],
                        backgroundColor: [
                            'rgba(0, 255, 136, 0.8)',      // Crypto - Vert
                            'rgba(52, 152, 219, 0.8)',     // PEA - Bleu
                            'rgba(255, 193, 7, 0.8)',      // Livrets - Jaune/Or
                            'rgba(156, 39, 176, 0.8)'      // Lev√©es - Violet (CHANG√â)
                        ],
                        borderColor: [
                            'rgba(0, 255, 136, 1)',
                            'rgba(52, 152, 219, 1)',
                            'rgba(255, 193, 7, 1)',
                            'rgba(156, 39, 176, 1)'        // Lev√©es - Violet (CHANG√â)
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff', font: { size: 14 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += '‚Ç¨' + context.parsed.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ========================================
        // NEWS AND MARKET INDICATORS
        // ========================================
        
        async function loadCryptoFearGreed() {
            try {
                const response = await fetch('https://api.alternative.me/fng/?limit=1');
                const data = await response.json();
                
                if (data.data && data.data[0]) {
                    const fng = data.data[0];
                    const value = parseInt(fng.value);
                    const classification = fng.value_classification;
                    
                    let color = '#a0aec0';
                    if (value <= 25) color = '#ff4757'; // Extreme Fear
                    else if (value <= 45) color = '#ff6b6b'; // Fear
                    else if (value <= 55) color = '#ffc107'; // Neutral
                    else if (value <= 75) color = '#4ecdc4'; // Greed
                    else color = '#00ff88'; // Extreme Greed
                    
                    document.getElementById('cryptoFearGreed').innerHTML = `
                        <div class="fear-greed-gauge">
                            <div class="gauge-value" style="color: ${color};">${value}</div>
                            <div class="gauge-label" style="color: ${color};">${classification}</div>
                        </div>
                        <div style="margin-top: 15px; font-size: 0.9em; color: #d0d0d0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>0</span>
                                <span>Extreme Fear</span>
                                <span>Fear</span>
                                <span>Neutral</span>
                                <span>Greed</span>
                                <span>Extreme Greed</span>
                                <span>100</span>
                            </div>
                            <div style="height: 10px; background: linear-gradient(90deg, #ff4757, #ff6b6b, #ffc107, #4ecdc4, #00ff88); border-radius: 5px; position: relative;">
                                <div style="position: absolute; left: ${value}%; top: -5px; width: 3px; height: 20px; background: white;"></div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading Crypto F&G:', error);
                document.getElementById('cryptoFearGreed').innerHTML = '<div style="color: #ff4757;">Erreur de chargement</div>';
            }
        }
        
        async function loadStockFearGreed() {
            // Estimation bas√©e sur le VIX (volatilit√©)
            // Dans une vraie app, vous utiliseriez une API payante comme CNN Fear & Greed
            try {
                // Simulation d'une valeur bas√©e sur la date (pour d√©mo)
                const today = new Date();
                const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 86400000);
                const simValue = 50 + (Math.sin(dayOfYear / 30) * 30); // Oscillation entre 20 et 80
                
                const value = Math.round(simValue);
                let label = 'Neutral';
                let color = '#ffc107';
                
                if (value <= 25) { label = 'Extreme Fear'; color = '#ff4757'; }
                else if (value <= 45) { label = 'Fear'; color = '#ff6b6b'; }
                else if (value <= 55) { label = 'Neutral'; color = '#ffc107'; }
                else if (value <= 75) { label = 'Greed'; color = '#4ecdc4'; }
                else { label = 'Extreme Greed'; color = '#00ff88'; }
                
                document.getElementById('stockFGValue').textContent = value;
                document.getElementById('stockFGValue').style.color = color;
                document.getElementById('stockFGLabel').textContent = label;
                document.getElementById('stockFGLabel').style.color = color;
                
                // Add gradient bar
                const container = document.getElementById('stockFearGreed');
                const existingBar = container.querySelector('.fear-greed-gradient');
                if (!existingBar) {
                    container.innerHTML += `
                        <div class="fear-greed-gradient" style="margin-top: 15px;">
                            <div style="height: 10px; background: linear-gradient(90deg, #ff4757, #ff6b6b, #ffc107, #4ecdc4, #00ff88); border-radius: 5px; position: relative;">
                                <div style="position: absolute; left: ${value}%; top: -5px; width: 3px; height: 20px; background: white;"></div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading Stock F&G:', error);
            }
        }
        
        async function refreshNews() {
            const summaryEl = document.getElementById('aiSummary');
            const feedEl = document.getElementById('newsFeed');
            
            summaryEl.innerHTML = '<div class="loading">‚è≥ Recherche des derni√®res actualit√©s...</div>';
            feedEl.innerHTML = '<div class="loading">Chargement...</div>';
            
            try {
                // Rechercher les actualit√©s crypto et bourse
                const cryptoQuery = 'Latest cryptocurrency market news Bitcoin Ethereum';
                const stockQuery = 'Latest stock market news S&P 500 Nasdaq';
                
                // Utiliser web_search pour obtenir les actualit√©s
                summaryEl.innerHTML = '<div class="loading">‚è≥ Synth√®se IA en cours...</div>';
                
                // Simuler le chargement (dans la vraie app, vous utiliseriez l'API Anthropic)
                const newsItems = [
                    {
                        title: "Bitcoin franchit les $100,000",
                        source: "CoinDesk",
                        snippet: "Le Bitcoin a atteint un nouveau sommet historique aujourd'hui...",
                        url: "#"
                    },
                    {
                        title: "La Fed maintient ses taux directeurs",
                        source: "Bloomberg",
                        snippet: "La R√©serve F√©d√©rale am√©ricaine a d√©cid√© de maintenir...",
                        url: "#"
                    },
                    {
                        title: "Les actions tech en hausse de 3%",
                        source: "Reuters",
                        snippet: "Le secteur technologique poursuit sa progression avec...",
                        url: "#"
                    }
                ];
                
                // Afficher les actualit√©s
                feedEl.innerHTML = newsItems.map(news => `
                    <div class="news-item" onclick="window.open('${news.url}', '_blank')">
                        <div class="news-title">${news.title}</div>
                        <div class="news-source">üì∞ ${news.source}</div>
                        <div class="news-snippet">${news.snippet}</div>
                    </div>
                `).join('');
                
                // Synth√®se IA (simul√©e)
                summaryEl.innerHTML = `
                    <div class="ai-summary-text">
                        <p style="margin-bottom: 12px;">
                            <strong>üìä March√©s aujourd'hui :</strong> Les march√©s affichent une tendance haussi√®re avec le Bitcoin franchissant des niveaux historiques. 
                            Les investisseurs restent optimistes malgr√© l'incertitude √©conomique.
                        </p>
                        <p style="margin-bottom: 12px;">
                            <strong>üè¶ Politique mon√©taire :</strong> La Fed maintient sa position prudente, surveillant de pr√®s l'inflation 
                            tout en soutenant la croissance √©conomique.
                        </p>
                        <p>
                            <strong>üí° Perspective :</strong> Les analystes pr√©voient une volatilit√© accrue dans les semaines √† venir, 
                            avec des opportunit√©s tant sur les cryptos que sur les march√©s traditionnels.
                        </p>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading news:', error);
                summaryEl.innerHTML = '<div class="ai-summary-text" style="color: #ff4757;">‚ùå Erreur lors du chargement des actualit√©s</div>';
                feedEl.innerHTML = '<div style="color: #ff4757; text-align: center;">Erreur de chargement</div>';
            }
        }
        
        async function updateAll() {
            await updatePrices();
            updateCryptoList();
            updatePEAList();
            updatePEAQuickSelect(); // Update quick select buttons
            updateLivretsList(); // Update livrets
            updateFundraisingList();
            updateDashboard();
            
            // Load market indicators and news
            loadCryptoFearGreed();
            loadStockFearGreed();
            refreshNews();
            
            document.getElementById('syncStatus').textContent = '‚úÖ Synchronis√©';
            document.getElementById('syncStatus').classList.add('synced');
        }

        async function exportToGoogleSheets() {
            const sheetId = document.getElementById('googleSheetId').value.trim();
            if (!sheetId) {
                alert('Veuillez entrer l\'ID de votre Google Sheet');
                return;
            }

            localStorage.setItem('googleSheetId', sheetId);
            alert('‚ö†Ô∏è Cette fonction n√©cessite une authentification Google Sheets API. Utilisez plut√¥t la synchronisation depuis Google Sheets vers l\'application.');
        }

        function saveGoogleSheetId() {
            const id = document.getElementById('googleSheetId').value.trim();
            if (id) {
                localStorage.setItem('googleSheetId', id);
                alert('‚úÖ Google Sheet ID enregistr√©');
            }
        }

        async function syncPricesFromGoogleSheets() {
            const sheetId = localStorage.getItem('googleSheetId');
            if (!sheetId) {
                alert('‚ö†Ô∏è Veuillez d\'abord enregistrer l\'ID de votre Google Sheet');
                showSection('settings');
                return;
            }

            try {
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=0`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: V√©rifiez que la feuille est publique`);
                }
                
                const csvText = await response.text();
                const lines = csvText.split('\n');
                
                let count = 0;
                ensurePortfolioStructure();
                
                // Skip header line
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // Parse CSV handling quotes and decimal commas
                    const parts = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            parts.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    parts.push(current.trim());
                    
                    const ticker = parts[0]?.replace(/"/g, '');
                    const priceStr = parts[1]?.replace(/"/g, '');
                    
                    if (ticker && priceStr) {
                        // Handle both point and comma as decimal separator
                        const price = parseFloat(priceStr.replace(',', '.'));
                        if (!isNaN(price) && price > 0) {
                            portfolio.prices[ticker.toUpperCase()] = price;
                            portfolio.priceTimestamps[ticker.toUpperCase()] = Date.now();
                            count++;
                            console.log(`‚úÖ ${ticker}: ${price}‚Ç¨`);
                        }
                    }
                }
                
                if (count > 0) {
                    saveData();
                    updateAll();
                    alert(`‚úÖ ${count} prix synchronis√©s depuis Google Sheets !`);
                } else {
                    alert('‚ö†Ô∏è Aucun prix trouv√©. V√©rifiez le format de votre feuille.');
                }
                
            } catch (error) {
                console.error('Erreur:', error);
                alert(`‚ùå Erreur: ${error.message}\n\nV√©rifiez que :\n1. La feuille est publi√©e sur le Web\n2. L'ID est correct\n3. Le format est : ticker,prix`);
            }
        }

        function toggleAutoSync(isEnabled) {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
                autoSyncInterval = null;
            }
            
            if (isEnabled) {
                syncPricesFromGoogleSheets(); // Immediate sync
                autoSyncInterval = setInterval(() => {
                    console.log('üîÑ Auto-sync Google Sheets...');
                    syncPricesFromGoogleSheets();
                }, 5 * 60 * 1000); // Every 5 minutes
                localStorage.setItem('autoSyncEnabled', 'true');
                console.log('‚úÖ Auto-sync activ√© (5 min)');
            } else {
                localStorage.setItem('autoSyncEnabled', 'false');
                console.log('‚ùå Auto-sync d√©sactiv√©');
            }
        }

        // Google Drive Functions
        function saveClientId() {
            const id = document.getElementById('clientId').value.trim();
            if (id) {
                localStorage.setItem('googleClientId', id);
                alert('‚úÖ Client ID enregistr√©');
                initGoogleDrive();
            }
        }

        function initGoogleDrive() {
            const id = localStorage.getItem('googleClientId');
            if (!id) return;
            try {
                if (typeof google === 'undefined' || !google.accounts) {
                    setTimeout(initGoogleDrive, 1000);
                    return;
                }
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: id,
                    scope: 'https://www.googleapis.com/auth/drive.file',
                    callback: (r) => {
                        if (r.error) {
                            alert('‚ùå ' + r.error);
                            return;
                        }
                        accessToken = r.access_token;
                        isGoogleDriveConnected = true;
                        document.getElementById('syncStatus').textContent = '‚úì Synchronis√©';
                        document.getElementById('syncStatus').classList.add('synced');
                        loadFromDrive();
                    }
                });
            } catch (e) {
                console.error(e);
            }
        }

        function connectGoogleDrive() {
            if (!localStorage.getItem('googleClientId')) {
                alert('‚ö†Ô∏è Entrez le Client ID');
                showSection('settings');
                return;
            }
            if (!tokenClient) {
                initGoogleDrive();
                setTimeout(() => { if (tokenClient) tokenClient.requestAccessToken(); }, 1000);
            } else {
                tokenClient.requestAccessToken();
            }
        }

        function disconnectGoogleDrive() {
            if (accessToken) google.accounts.oauth2.revoke(accessToken);
            accessToken = null;
            isGoogleDriveConnected = false;
            localStorage.removeItem('portfolioFileId');
            document.getElementById('syncStatus').textContent = '‚è≥ Non synchronis√©';
            document.getElementById('syncStatus').classList.remove('synced');
        }

        async function syncDriveData() {
            if (!isGoogleDriveConnected || !accessToken) {
                console.log('‚ö†Ô∏è Google Drive non connect√©, sauvegarde ignor√©e');
                return;
            }
            
            // Show saving indicator
            const statusEl = document.getElementById('syncStatus');
            const originalText = statusEl.textContent;
            statusEl.textContent = 'üíæ Sauvegarde...';
            statusEl.classList.remove('synced');
            
            try {
                const fid = localStorage.getItem('portfolioFileId');
                const data = JSON.stringify(portfolio, null, 2);
                if (fid) {
                    const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fid}?uploadType=media`, {
                        method: 'PATCH',
                        headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                        body: data
                    });
                    if (response.ok) {
                        console.log('‚úÖ Sauvegard√© sur Google Drive');
                        showSaveConfirmation();
                    } else {
                        throw new Error('Erreur HTTP: ' + response.status);
                    }
                } else {
                    const meta = { name: 'portfolio.json', mimeType: 'application/json' };
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(meta)], { type: 'application/json' }));
                    form.append('file', new Blob([data], { type: 'application/json' }));
                    const r = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${accessToken}` },
                        body: form
                    });
                    if (r.ok) {
                        const res = await r.json();
                        localStorage.setItem('portfolioFileId', res.id);
                        console.log('‚úÖ Fichier cr√©√© sur Google Drive:', res.id);
                        showSaveConfirmation();
                    } else {
                        throw new Error('Erreur cr√©ation: ' + r.status);
                    }
                }
                
                // Restore status
                statusEl.textContent = '‚úÖ Synchronis√©';
                statusEl.classList.add('synced');
                
            } catch (e) {
                console.error('‚ùå Erreur sauvegarde Drive:', e);
                statusEl.textContent = '‚ùå Erreur Drive';
                alert('‚ùå Erreur lors de la sauvegarde sur Google Drive:\n' + e.message);
            }
        }
        
        function showSaveConfirmation() {
            const statusEl = document.getElementById('syncStatus');
            statusEl.textContent = '‚úÖ Sauvegard√© sur Drive';
            statusEl.classList.add('synced');
            
            // Reset after 3 seconds
            setTimeout(() => {
                statusEl.textContent = '‚úÖ Synchronis√©';
            }, 3000);
        }

        async function loadFromDrive() {
            if (!isGoogleDriveConnected || !accessToken) {
                alert('‚ö†Ô∏è Veuillez d\'abord vous connecter √† Google Drive');
                return;
            }
            try {
                let fid = localStorage.getItem('portfolioFileId');
                if (!fid) {
                    const r = await fetch('https://www.googleapis.com/drive/v3/files?q=name%3D%27portfolio.json%27', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    const d = await r.json();
                    if (d.files && d.files.length > 0) {
                        fid = d.files[0].id;
                        localStorage.setItem('portfolioFileId', fid);
                    } else {
                        alert('‚ö†Ô∏è Aucun fichier portfolio.json trouv√© sur Google Drive');
                        return;
                    }
                }
                const r = await fetch(`https://www.googleapis.com/drive/v3/files/${fid}?alt=media`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (r.ok) {
                    const importedData = await r.json();
                    portfolio = {
                        crypto: importedData.crypto || [],
                        pea: importedData.pea || [],
                        livrets: importedData.livrets || [],
                        fundraising: importedData.fundraising || [],
                        prices: importedData.prices || {},
                        priceTimestamps: importedData.priceTimestamps || {},
                        binanceCredentials: importedData.binanceCredentials || null
                    };
                    
                    portfolio.pea = portfolio.pea.map(p => ({
                        name: p.name || '',
                        ticker: p.ticker || '',
                        quantity: p.quantity || 0,
                        price: p.price || 0,
                        fees: p.fees || 0,
                        date: p.date || new Date().toISOString().split('T')[0]
                    }));
                    
                    ensurePortfolioStructure();
                    saveData();
                    updateAll();
                    updateBinanceStatus();
                    alert(`‚úÖ Donn√©es charg√©es depuis Google Drive!

üìä PEA: ${portfolio.pea.length} ligne${portfolio.pea.length > 1 ? 's' : ''}
‚Çø Crypto: ${portfolio.crypto.length} ligne${portfolio.crypto.length > 1 ? 's' : ''}
üí∞ Livrets: ${portfolio.livrets.length} livret${portfolio.livrets.length > 1 ? 's' : ''}
üöÄ Lev√©es: ${portfolio.fundraising.length} investissement${portfolio.fundraising.length > 1 ? 's' : ''}`);
                } else {
                    alert('‚ùå Erreur lors du chargement: ' + r.status);
                }
            } catch (e) {
                console.error('Erreur Drive:', e);
                alert('‚ùå Erreur: ' + e.message);
            }
        }

        function saveData() {
            localStorage.setItem('portfolioData', JSON.stringify(portfolio));
        }

        function loadData() {
            const saved = localStorage.getItem('portfolioData');
            if (saved) {
                try {
                    portfolio = JSON.parse(saved);
                    ensurePortfolioStructure();
                } catch (e) {
                    console.error('Erreur chargement:', e);
                    portfolio = { crypto: [], pea: [], fundraising: [], prices: {}, priceTimestamps: {}, binanceCredentials: null };
                }
            }
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(portfolio, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `portfolio_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function importData(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const importedData = JSON.parse(ev.target.result);
                        portfolio = {
                            crypto: importedData.crypto || [],
                            pea: importedData.pea || [],
                            fundraising: importedData.fundraising || [],
                            prices: importedData.prices || {},
                            priceTimestamps: importedData.priceTimestamps || {},
                            binanceCredentials: importedData.binanceCredentials || null
                        };
                        
                        portfolio.pea = portfolio.pea.map(p => ({
                            name: p.name || '',
                            ticker: p.ticker || '',
                            quantity: p.quantity || 0,
                            price: p.price || 0,
                            fees: p.fees || 0,
                            date: p.date || new Date().toISOString().split('T')[0]
                        }));
                        
                        ensurePortfolioStructure();
                        saveData();
                        syncDriveData();
                        updateAll();
                        updateBinanceStatus();
                        alert(`‚úÖ Import√© avec succ√®s!\n\nPEA: ${portfolio.pea.length} lignes\nCrypto: ${portfolio.crypto.length} lignes\nLev√©es: ${portfolio.fundraising.length} lignes`);
                    } catch (err) {
                        console.error('Erreur import:', err);
                        alert(`‚ùå Erreur lors de l'import:\n${err.message}\n\nV√©rifiez que le fichier est un JSON valide.`);
                    }
                };
                reader.readAsText(file);
            }
        }

        // Init
        ensurePortfolioStructure();
        loadData();
        initCryptoLibrary();
        updateBinanceStatus();
        updateAll();
        initGoogleDrive();
        document.getElementById('cryptoDate').valueAsDate = new Date();
        document.getElementById('peaDate').valueAsDate = new Date();
        document.getElementById('livretDate').valueAsDate = new Date();
        document.getElementById('fundDate').valueAsDate = new Date();
        
        const savedSheetId = localStorage.getItem('googleSheetId');
        if (savedSheetId) {
            document.getElementById('googleSheetId').value = savedSheetId;
        }
        
        // Restore Client ID
        const savedClientId = localStorage.getItem('googleClientId');
        if (savedClientId) {
            document.getElementById('clientId').value = savedClientId;
        }
        
        const autoSyncEnabled = localStorage.getItem('autoSyncEnabled') === 'true';
        document.getElementById('autoSyncCheckbox').checked = autoSyncEnabled;
        if (autoSyncEnabled) {
            toggleAutoSync(true);
        }
    </script>
</body>
</html>
</body>
</html>
