<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Manager - Gestion Financi√®re</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 100%);
            color: #ffffff;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            color: #00ff88;
            font-size: clamp(1.5em, 5vw, 2.5em);
        }

        .sync-status {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .sync-status.synced {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        nav {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #1a1f2e;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 0.9em;
            flex: 1 1 auto;
            min-width: 120px;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            display: none;
        }

        .section.active {
            display: block;
        }

        h2 {
            color: #00ff88;
            margin-bottom: 20px;
            font-size: clamp(1.3em, 4vw, 1.8em);
        }

        h3 {
            color: #3b82f6;
            margin-bottom: 15px;
            font-size: clamp(1.1em, 3vw, 1.3em);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(0, 255, 136, 0.05) 100%);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .stat-label {
            font-size: 0.85em;
            color: #a0aec0;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: clamp(1.2em, 4vw, 2em);
            font-weight: bold;
            color: #00ff88;
            word-break: break-word;
        }

        .stat-change {
            font-size: 0.9em;
            margin-top: 5px;
        }

        .stat-change.positive {
            color: #00ff88;
        }

        .stat-change.negative {
            color: #ff4444;
        }

        form {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #a0aec0;
            font-size: 0.9em;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
            color: #ffffff;
            border-radius: 8px;
            font-size: 1em;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #00ff88;
        }

        button[type="submit"] {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #1a1f2e;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s;
            width: 100%;
        }

        button[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px 8px;
            text-align: left;
            color: #00ff88;
            font-weight: bold;
            font-size: 0.9em;
        }

        td {
            padding: 12px 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85em;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .delete-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .btn {
            background: rgba(59, 130, 246, 0.8);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 0.9em;
            flex: 1 1 auto;
            min-width: 150px;
        }

        .btn:hover {
            background: rgba(59, 130, 246, 1);
            transform: translateY(-2px);
        }

        .settings-section {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .market-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #00ff88;
        }

        .market-label {
            font-size: 0.85em;
            color: #a0aec0;
        }

        .market-value {
            font-size: clamp(1em, 3vw, 1.5em);
            font-weight: bold;
            color: #ffffff;
            margin-top: 5px;
        }

        #importFile {
            display: none;
        }

        .config-section {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .step-list {
            margin-left: 20px;
            margin-top: 10px;
        }

        .step-list li {
            margin-bottom: 10px;
            color: #cbd5e0;
            font-size: 0.9em;
        }

        .warning-box {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .warning-box h4 {
            color: #f59e0b;
            margin-bottom: 10px;
        }

        .warning-box ul {
            margin-left: 20px;
        }

        .warning-box li {
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        a {
            color: #00ff88;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            header {
                padding: 15px;
            }

            .section {
                padding: 15px;
            }

            .nav-btn {
                padding: 10px 15px;
                font-size: 0.85em;
                min-width: 100px;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            form {
                padding: 15px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            th, td {
                padding: 8px 5px;
                font-size: 0.8em;
            }

            .config-section {
                padding: 15px;
            }

            .step-list {
                margin-left: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Portfolio Manager</h1>
            <div class="sync-status" id="syncStatus">Non synchronis√©</div>
        </header>

        <nav>
            <button class="nav-btn" onclick="showSection('dashboard')">Dashboard</button>
            <button class="nav-btn" onclick="showSection('crypto')">Crypto</button>
            <button class="nav-btn" onclick="showSection('pea')">PEA / Actions</button>
            <button class="nav-btn" onclick="showSection('fundraising')">Lev√©es</button>
            <button class="nav-btn" onclick="showSection('markets')">March√©s</button>
            <button class="nav-btn" onclick="showSection('settings')">‚öôÔ∏è</button>
        </nav>

        <!-- Settings Section -->
        <div id="settings" class="section">
            <h2>‚öôÔ∏è Configuration Google Drive</h2>
            
            <div class="config-section">
                <h3>üìÅ Synchronisation Cloud</h3>
                <p>Vos donn√©es sont automatiquement sauvegard√©es dans Google Drive.</p>
            </div>

            <div class="config-section">
                <h3>üöÄ Configuration</h3>
                <ol class="step-list">
                    <li>Allez sur <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a></li>
                    <li>Cr√©ez un projet et activez l'API Google Drive</li>
                    <li>Configurez OAuth (External) et ajoutez votre email en test user</li>
                    <li>Cr√©ez un Client ID OAuth 2.0 (Web application)</li>
                    <li>Ajoutez <code>https://cypriendlt-cmd.github.io</code> dans les origines autoris√©es</li>
                    <li>Copiez le Client ID ci-dessous</li>
                </ol>
            </div>

            <div class="settings-section">
                <div class="form-group">
                    <label for="clientId">Google Drive Client ID</label>
                    <input type="text" id="clientId" placeholder="xxxxx.apps.googleusercontent.com">
                </div>
                <div class="action-buttons">
                    <button class="btn" onclick="saveClientId()">üíæ Enregistrer</button>
                    <button class="btn" onclick="connectGoogleDrive()">üîó Connecter</button>
                    <button class="btn" onclick="disconnectGoogleDrive()">üîå D√©connecter</button>
                </div>
            </div>

            <div class="warning-box">
                <h4>üîß Probl√®mes courants</h4>
                <ul>
                    <li><strong>Erreur OAuth</strong> : V√©rifiez l'√©cran de consentement</li>
                    <li><strong>redirect_uri_mismatch</strong> : Ajoutez l'URI correcte</li>
                    <li><strong>access_denied</strong> : Ajoutez votre email en test user</li>
                </ul>
            </div>

            <h2 style="margin-top: 30px;">üìÇ Export / Import</h2>
            <div class="action-buttons">
                <button class="btn" onclick="exportData()">üìä Exporter</button>
                <label for="importFile" class="btn">üì• Importer</label>
                <input type="file" id="importFile" accept=".json" onchange="importData(event)">
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="section active">
            <div class="action-buttons">
                <button class="btn" onclick="refreshAllData()">üîÑ Rafra√Æchir</button>
            </div>

            <h2>üìà Synth√®se Globale</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Valeur Totale</div>
                    <div class="stat-value" id="totalValue">0 ‚Ç¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Investissement</div>
                    <div class="stat-value" id="totalInvestment">0 ‚Ç¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">P&L Total</div>
                    <div class="stat-value" id="totalPnL">0 ‚Ç¨</div>
                    <div class="stat-change" id="totalPnLPercent">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Meilleur Actif</div>
                    <div class="stat-value" id="bestAsset">-</div>
                </div>
            </div>

            <h2>üìä R√©partition</h2>
            <div class="chart-container">
                <canvas id="portfolioChart"></canvas>
            </div>

            <h2>üìã Toutes les Positions</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Actif</th>
                            <th>Quantit√©</th>
                            <th>Prix Entr√©e</th>
                            <th>Valeur</th>
                            <th>P&L</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="allPositionsTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Crypto Section -->
        <div id="crypto" class="section">
            <h2>üí∞ Gestion Crypto</h2>
            <form onsubmit="addCryptoPosition(event)">
                <div class="form-group">
                    <label>Nom du Token</label>
                    <input type="text" id="cryptoName" required placeholder="Bitcoin">
                </div>
                <div class="form-group">
                    <label>Symbol (ID CoinGecko)</label>
                    <input type="text" id="cryptoSymbol" required placeholder="bitcoin">
                </div>
                <div class="form-group">
                    <label>Quantit√©</label>
                    <input type="number" id="cryptoQuantity" step="0.00000001" required>
                </div>
                <div class="form-group">
                    <label>Prix d'Achat (‚Ç¨)</label>
                    <input type="number" id="cryptoPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Date d'Achat</label>
                    <input type="date" id="cryptoDate" required>
                </div>
                <button type="submit">Ajouter Position</button>
            </form>

            <h2>üìä Positions Crypto</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Token</th>
                            <th>Quantit√©</th>
                            <th>Prix Entr√©e</th>
                            <th>Prix Actuel</th>
                            <th>Valeur</th>
                            <th>P&L</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="cryptoTable"></tbody>
                </table>
            </div>
        </div>

        <!-- PEA Section -->
        <div id="pea" class="section">
            <h2>üìà Gestion PEA / Actions</h2>
            <form onsubmit="addPEAPosition(event)">
                <div class="form-group">
                    <label>Nom de l'Action / ETF</label>
                    <input type="text" id="peaName" required placeholder="Apple Inc.">
                </div>
                <div class="form-group">
                    <label>Ticker</label>
                    <input type="text" id="peaTicker" required placeholder="AAPL">
                </div>
                <div class="form-group">
                    <label>Quantit√©</label>
                    <input type="number" id="peaQuantity" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Prix d'Achat (‚Ç¨)</label>
                    <input type="number" id="peaPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Date d'Achat</label>
                    <input type="date" id="peaDate" required>
                </div>
                <button type="submit">Ajouter Position</button>
            </form>

            <h2>üìä Positions PEA</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Action/ETF</th>
                            <th>Quantit√©</th>
                            <th>Prix Entr√©e</th>
                            <th>Prix Actuel</th>
                            <th>Valeur</th>
                            <th>P&L</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="peaTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Fundraising Section -->
        <div id="fundraising" class="section">
            <h2>üöÄ Lev√©es de Fonds</h2>
            <form onsubmit="addFundraisingPosition(event)">
                <div class="form-group">
                    <label>Nom de la Startup</label>
                    <input type="text" id="fundName" required>
                </div>
                <div class="form-group">
                    <label>Montant Investi (‚Ç¨)</label>
                    <input type="number" id="fundAmount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Valorisation (‚Ç¨)</label>
                    <input type="number" id="fundValuation" step="0.01">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="fundDate" required>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="fundNotes" rows="3"></textarea>
                </div>
                <button type="submit">Ajouter</button>
            </form>

            <h2>üìä Mes Investissements</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Startup</th>
                            <th>Montant</th>
                            <th>Valorisation</th>
                            <th>Date</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="fundraisingTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Markets Section -->
        <div id="markets" class="section">
            <h2>üìä March√©s</h2>
            
            <h3>Crypto</h3>
            <div class="market-grid">
                <div class="market-card">
                    <div class="market-label">Bitcoin (BTC)</div>
                    <div class="market-value" id="btcPrice">-</div>
                </div>
                <div class="market-card">
                    <div class="market-label">Ethereum (ETH)</div>
                    <div class="market-value" id="ethPrice">-</div>
                </div>
                <div class="market-card">
                    <div class="market-label">BTC Dom.</div>
                    <div class="market-value" id="btcDominance">-</div>
                </div>
                <div class="market-card">
                    <div class="market-label">Market Cap</div>
                    <div class="market-value" id="totalMarketCap">-</div>
                </div>
            </div>

            <h3 style="margin-top: 20px;">Boursiers</h3>
            <div class="market-grid">
                <div class="market-card">
                    <div class="market-label">S&P 500</div>
                    <div class="market-value" id="sp500">-</div>
                </div>
                <div class="market-card">
                    <div class="market-label">Dow Jones</div>
                    <div class="market-value" id="dowJones">-</div>
                </div>
                <div class="market-card">
                    <div class="market-label">NASDAQ</div>
                    <div class="market-value" id="nasdaq">-</div>
                </div>
                <div class="market-card">
                    <div class="market-label">CAC 40</div>
                    <div class="market-value" id="cac40">-</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let portfolio = { crypto: [], pea: [], fundraising: [] };
        let priceCache = {};
        let charts = { portfolio: null };
        let isGoogleDriveConnected = false;
        let accessToken = null;
        let tokenClient = null;
        let isSyncing = false;

        window.addEventListener('load', () => {
            loadData();
            updateDashboard();
            updateCryptoTable();
            updatePEATable();
            updateFundraisingTable();
            updateMarketIndicators();
            const savedClientId = localStorage.getItem('googleClientId');
            if (savedClientId) {
                document.getElementById('clientId').value = savedClientId;
            }
        });

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
        }

        function saveClientId() {
            const clientId = document.getElementById('clientId').value.trim();
            if (clientId) {
                localStorage.setItem('googleClientId', clientId);
                alert('‚úÖ Client ID enregistr√© !');
                initGoogleDrive();
            } else {
                alert('‚ö†Ô∏è Client ID invalide');
            }
        }

        function initGoogleDrive() {
            const clientId = localStorage.getItem('googleClientId');
            if (!clientId) return;

            try {
                if (typeof google === 'undefined' || !google.accounts) {
                    setTimeout(initGoogleDrive, 1000);
                    return;
                }

                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: clientId,
                    scope: 'https://www.googleapis.com/auth/drive.file',
                    callback: (response) => {
                        if (response.error) {
                            alert('‚ùå Erreur : ' + response.error);
                            return;
                        }
                        accessToken = response.access_token;
                        isGoogleDriveConnected = true;
                        updateSyncStatus(true);
                        loadFromDrive();
                    },
                });
            } catch (error) {
                console.error('Erreur init:', error);
            }
        }

        function connectGoogleDrive() {
            const clientId = localStorage.getItem('googleClientId');
            if (!clientId) {
                alert('‚ö†Ô∏è Enregistrez d\'abord le Client ID');
                showSection('settings');
                return;
            }

            if (!tokenClient) {
                initGoogleDrive();
                setTimeout(() => {
                    if (tokenClient) tokenClient.requestAccessToken();
                }, 1000);
            } else {
                tokenClient.requestAccessToken();
            }
        }

        function disconnectGoogleDrive() {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken);
            }
            accessToken = null;
            isGoogleDriveConnected = false;
            localStorage.removeItem('portfolioFileId');
            updateSyncStatus(false);
            alert('‚úÖ D√©connect√©');
        }

        function updateSyncStatus(connected) {
            const status = document.getElementById('syncStatus');
            if (connected) {
                status.textContent = '‚úì Synchronis√©';
                status.classList.add('synced');
            } else {
                status.textContent = 'Non synchronis√©';
                status.classList.remove('synced');
            }
        }

        async function syncData() {
            if (!isGoogleDriveConnected || !accessToken || isSyncing) return;

            isSyncing = true;
            try {
                const fileId = localStorage.getItem('portfolioFileId');
                const dataStr = JSON.stringify(portfolio, null, 2);

                if (fileId) {
                    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: dataStr
                    });
                } else {
                    const metadata = { name: 'portfolio-data.json', mimeType: 'application/json' };
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', new Blob([dataStr], { type: 'application/json' }));

                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${accessToken}` },
                        body: form
                    });

                    if (response.ok) {
                        const result = await response.json();
                        localStorage.setItem('portfolioFileId', result.id);
                    }
                }
            } catch (error) {
                console.error('Erreur sync:', error);
            } finally {
                isSyncing = false;
            }
        }

        async function loadFromDrive() {
            if (!isGoogleDriveConnected || !accessToken) return;

            try {
                let fileId = localStorage.getItem('portfolioFileId');
                
                if (!fileId) {
                    const response = await fetch('https://www.googleapis.com/drive/v3/files?q=name%3D%27portfolio-data.json%27', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    const data = await response.json();
                    if (data.files && data.files.length > 0) {
                        fileId = data.files[0].id;
                        localStorage.setItem('portfolioFileId', fileId);
                    } else {
                        return;
                    }
                }

                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    portfolio = data;
                    saveData();
                    await refreshAllData();
                }
            } catch (error) {
                console.error('Erreur chargement:', error);
            }
        }

        async function addCryptoPosition(event) {
            event.preventDefault();
            const position = {
                id: Date.now(),
                name: document.getElementById('cryptoName').value,
                symbol: document.getElementById('cryptoSymbol').value.toLowerCase(),
                quantity: parseFloat(document.getElementById('cryptoQuantity').value),
                entryPrice: parseFloat(document.getElementById('cryptoPrice').value),
                date: document.getElementById('cryptoDate').value
            };
            portfolio.crypto.push(position);
            saveData();
            syncData();
            await updateCryptoTable();
            await updateDashboard();
            event.target.reset();
            alert('‚úÖ Position ajout√©e !');
        }

        async function updateCryptoTable() {
            const tbody = document.getElementById('cryptoTable');
            tbody.innerHTML = '';
            
            for (const position of portfolio.crypto) {
                const currentPrice = await getCryptoPrice(position.symbol);
                const currentValue = position.quantity * currentPrice;
                const invested = position.quantity * position.entryPrice;
                const pnl = currentValue - invested;
                const pnlPercent = invested > 0 ? ((pnl / invested) * 100).toFixed(2) : 0;

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${position.name}</strong></td>
                    <td>${position.quantity.toFixed(6)}</td>
                    <td>${position.entryPrice.toFixed(2)} ‚Ç¨</td>
                    <td>${currentPrice.toFixed(2)} ‚Ç¨</td>
                    <td><strong>${currentValue.toFixed(2)} ‚Ç¨</strong></td>
                    <td class="${pnl >= 0 ? 'positive' : 'negative'}">${pnl >= 0 ? '‚ñ≤' : '‚ñº'} ${pnl.toFixed(2)} ‚Ç¨ (${pnlPercent}%)</td>
                    <td>${formatDate(position.date)}</td>
                    <td><button class="delete-btn" onclick="deletePosition('crypto', ${position.id})">üóëÔ∏è</button></td>
                `;
            }
        }

        async function addPEAPosition(event) {
            event.preventDefault();
            const position = {
                id: Date.now(),
                name: document.getElementById('peaName').value,
                ticker: document.getElementById('peaTicker').value.toUpperCase(),
                quantity: parseFloat(document.getElementById('peaQuantity').value),
                entryPrice: parseFloat(document.getElementById('peaPrice').value),
                date: document.getElementById('peaDate').value
            };
            portfolio.pea.push(position);
            saveData();
            syncData();
            await updatePEATable();
            await updateDashboard();
            event.target.reset();
            alert('‚úÖ Position ajout√©e !');
        }

        async function updatePEATable() {
            const tbody = document.getElementById('peaTable');
            tbody.innerHTML = '';
            
            for (const position of portfolio.pea) {
                const currentPrice = await getStockPrice(position.ticker);
                const currentValue = position.quantity * currentPrice;
                const invested = position.quantity * position.entryPrice;
                const pnl = currentValue - invested;
                const pnlPercent = invested > 0 ? ((pnl / invested) * 100).toFixed(2) : 0;

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${position.name}</strong></td>
                    <td>${position.quantity.toFixed(2)}</td>
                    <td>${position.entryPrice.toFixed(2)} ‚Ç¨</td>
                    <td>${currentPrice.toFixed(2)} ‚Ç¨</td>
                    <td><strong>${currentValue.toFixed(2)} ‚Ç¨</strong></td>
                    <td class="${pnl >= 0 ? 'positive' : 'negative'}">${pnl >= 0 ? '‚ñ≤' : '‚ñº'} ${pnl.toFixed(2)} ‚Ç¨ (${pnlPercent}%)</td>
                    <td>${formatDate(position.date)}</td>
                    <td><button class="delete-btn" onclick="deletePosition('pea', ${position.id})">üóëÔ∏è</button></td>
                `;
            }
        }

        function addFundraisingPosition(event) {
            event.preventDefault();
            const position = {
                id: Date.now(),
                name: document.getElementById('fundName').value,
                amount: parseFloat(document.getElementById('fundAmount').value),
                valuation: parseFloat(document.getElementById('fundValuation').value) || 0,
                date: document.getElementById('fundDate').value,
                notes: document.getElementById('fundNotes').value
            };
            portfolio.fundraising.push(position);
            saveData();
            syncData();
            updateFundraisingTable();
            updateDashboard();
            event.target.reset();
            alert('‚úÖ Investissement ajout√© !');
        }

        function updateFundraisingTable() {
            const tbody = document.getElementById('fundraisingTable');
            tbody.innerHTML = '';
            
            portfolio.fundraising.forEach(position => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${position.name}</strong></td>
                    <td>${position.amount.toFixed(2)} ‚Ç¨</td>
                    <td>${position.valuation.toFixed(0)} ‚Ç¨</td>
                    <td>${formatDate(position.date)}</td>
                    <td>${position.notes}</td>
                    <td><button class="delete-btn" onclick="deletePosition('fundraising', ${position.id})">üóëÔ∏è</button></td>
                `;
            });
        }

        async function deletePosition(type, id) {
            if (confirm('Supprimer cette position ?')) {
                portfolio[type] = portfolio[type].filter(p => p.id !== id);
                saveData();
                syncData();
                
                if (type === 'crypto') await updateCryptoTable();
                else if (type === 'pea') await updatePEATable();
                else if (type === 'fundraising') updateFundraisingTable();
                
                await updateDashboard();
                alert('‚úÖ Position supprim√©e !');
            }
        }

        async function updateDashboard() {
            let totalValue = 0;
            let totalInvestment = 0;
            let allPositions = [];

            for (const position of portfolio.crypto) {
                const currentPrice = await getCryptoPrice(position.symbol);
                const currentValue = position.quantity * currentPrice;
                const invested = position.quantity * position.entryPrice;
                totalValue += currentValue;
                totalInvestment += invested;
                allPositions.push({
                    type: 'Crypto',
                    name: position.name,
                    quantity: position.quantity,
                    entryPrice: position.entryPrice,
                    currentValue: currentValue,
                    pnl: currentValue - invested,
                    date: position.date
                });
            }

            for (const position of portfolio.pea) {
                const currentPrice = await getStockPrice(position.ticker);
                const currentValue = position.quantity * currentPrice;
                const invested = position.quantity * position.entryPrice;
                totalValue += currentValue;
                totalInvestment += invested;
                allPositions.push({
                    type: 'PEA',
                    name: position.name,
                    quantity: position.quantity,
                    entryPrice: position.entryPrice,
                    currentValue: currentValue,
                    pnl: currentValue - invested,
                    date: position.date
                });
            }

            portfolio.fundraising.forEach(position => {
                totalInvestment += position.amount;
                totalValue += position.amount;
                allPositions.push({
                    type: 'Lev√©e',
                    name: position.name,
                    quantity: 1,
                    entryPrice: position.amount,
                    currentValue: position.amount,
                    pnl: 0,
                    date: position.date
                });
            });

            const totalPnL = totalValue - totalInvestment;
            const totalPnLPercent = totalInvestment > 0 ? ((totalPnL / totalInvestment) * 100).toFixed(2) : 0;

            document.getElementById('totalValue').textContent = `${totalValue.toFixed(2)} ‚Ç¨`;
            document.getElementById('totalInvestment').textContent = `${totalInvestment.toFixed(2)} ‚Ç¨`;
            document.getElementById('totalPnL').textContent = `${totalPnL.toFixed(2)} ‚Ç¨`;
            document.getElementById('totalPnLPercent').textContent = `${totalPnLPercent}%`;
            document.getElementById('totalPnLPercent').className = totalPnL >= 0 ? 'stat-change positive' : 'stat-change negative';

            const bestAsset = allPositions.sort((a, b) => b.pnl - a.pnl)[0];
            document.getElementById('bestAsset').textContent = bestAsset ? bestAsset.name : '-';

            const tbody = document.getElementById('allPositionsTable');
            tbody.innerHTML = '';
            allPositions.forEach(pos => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${pos.type}</strong></td>
                    <td>${pos.name}</td>
                    <td>${pos.quantity.toFixed(4)}</td>
                    <td>${pos.entryPrice.toFixed(2)} ‚Ç¨</td>
                    <td><strong>${pos.currentValue.toFixed(2)} ‚Ç¨</strong></td>
                    <td class="${pos.pnl >= 0 ? 'positive' : 'negative'}">${pos.pnl >= 0 ? '‚ñ≤' : '‚ñº'} ${pos.pnl.toFixed(2)} ‚Ç¨</td>
                    <td>${formatDate(pos.date)}</td>
                `;
            });

            updatePortfolioChart();
        }

        function updatePortfolioChart() {
            const canvas = document.getElementById('portfolioChart');
            if (!canvas) return;

            if (charts.portfolio) charts.portfolio.destroy();

            const cryptoValue = portfolio.crypto.reduce((sum, p) => {
                const px = priceCache[p.symbol]?.price || p.entryPrice;
                return sum + (p.quantity * px);
            }, 0);

            const peaValue = portfolio.pea.reduce((sum, p) => {
                const px = priceCache[p.ticker]?.price || p.entryPrice;
                return sum + (p.quantity * px);
            }, 0);

            const fundValue = portfolio.fundraising.reduce((sum, p) => sum + p.amount, 0);

            charts.portfolio = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: ['Crypto', 'PEA/Actions', 'Lev√©es'],
                    datasets: [{
                        data: [cryptoValue, peaValue, fundValue],
                        backgroundColor: ['#00ff88', '#3b82f6', '#f59e0b'],
                        borderWidth: 2,
                        borderColor: '#1a1f2e'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#ffffff',
                                font: { size: 12 },
                                padding: 15
                            }
                        }
                    }
                }
            });
        }

        async function updateMarketIndicators() {
            try {
                const btcData = await getCryptoPrice('bitcoin');
                const ethData = await getCryptoPrice('ethereum');
                document.getElementById('btcPrice').textContent = `$${btcData.toFixed(0)}`;
                document.getElementById('ethPrice').textContent = `$${ethData.toFixed(0)}`;
            } catch (e) {
                console.error('Erreur march√©s:', e);
            }
            
            document.getElementById('btcDominance').textContent = '54%';
            document.getElementById('totalMarketCap').textContent = '$2.4T';
            document.getElementById('sp500').textContent = '5,825';
            document.getElementById('dowJones').textContent = '42,350';
            document.getElementById('nasdaq').textContent = '18,450';
            document.getElementById('cac40').textContent = '7,680';
        }

        async function getCryptoPrice(symbol) {
            if (priceCache[symbol] && Date.now() - priceCache[symbol].timestamp < 300000) {
                return priceCache[symbol].price;
            }

            try {
                const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${symbol}&vs_currencies=eur`);
                const data = await response.json();
                const price = data[symbol]?.eur || 0;
                priceCache[symbol] = { price, timestamp: Date.now() };
                return price;
            } catch (error) {
                console.error('Erreur prix crypto:', error);
                return priceCache[symbol]?.price || 0;
            }
        }

        async function getStockPrice(ticker) {
            if (priceCache[ticker] && Date.now() - priceCache[ticker].timestamp < 300000) {
                return priceCache[ticker].price;
            }

            const mockPrice = Math.random() * 200 + 50;
            priceCache[ticker] = { price: mockPrice, timestamp: Date.now() };
            return mockPrice;
        }

        function saveData() {
            localStorage.setItem('portfolioData', JSON.stringify(portfolio));
        }

        function loadData() {
            const saved = localStorage.getItem('portfolioData');
            if (saved) {
                try {
                    portfolio = JSON.parse(saved);
                } catch (e) {
                    console.error('Erreur chargement:', e);
                }
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(portfolio, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `portfolio_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            alert('‚úÖ Export√© !');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        portfolio = JSON.parse(e.target.result);
                        saveData();
                        syncData();
                        refreshAllData();
                        alert('‚úÖ Import√© !');
                    } catch (error) {
                        alert('‚ùå Erreur import');
                    }
                };
                reader.readAsText(file);
            }
        }

        async function refreshAllData() {
            priceCache = {};
            await updateDashboard();
            await updateCryptoTable();
            await updatePEATable();
            updateFundraisingTable();
            await updateMarketIndicators();
            alert('‚úÖ Rafra√Æchi !');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
    </script>
</body>
</html>
